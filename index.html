<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.3">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT" />


<meta property="og:type" content="website">
<meta property="og:title" content="Zamperini">
<meta property="og:url" content="https://dorgenjones.github.io/index.html">
<meta property="og:site_name" content="Zamperini">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zamperini">
<meta name="twitter:card" content="summary">






  <link rel="canonical" href="https://dorgenjones.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Zamperini</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zamperini</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2020/02/11/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/11/hello-world/" itemprop="url">主页</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-11T17:45:17+08:00">2020-02-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%BB%E9%A1%B5/" itemprop="url" rel="index"><span itemprop="name">主页</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h1><p>中国科学技术大学计算机硕士毕业，毕业以来一直在美团猫眼，先后从事后端研发、基础架构中间件研发。喜欢钻研技术、跑步、骑行、电影。更多信息见 <a href="/about">关于我</a></p>
<h1 id="关于本博客"><a href="#关于本博客" class="headerlink" title="关于本博客"></a>关于本博客</h1><p>目前托管在 <strong>github</strong>，之后会申请独立域名。基于 <code>Hexo + Mweb</code> 构建。</p>
<ol>
<li>博客里大部分内容属于原创；</li>
<li>早期的博客写的比较粗糙，后期将会陆续翻新，不足之处请多包涵。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2020/02/07/k8s/6.k8s-scheduler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/07/k8s/6.k8s-scheduler/" itemprop="url">kube-scheduler</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-07T00:00:00+08:00">2020-02-07</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="4-kube-scheduler"><a href="#4-kube-scheduler" class="headerlink" title="4.kube-scheduler"></a>4.kube-scheduler</h1><p><code>scheduler</code>是<code>k8s</code>集群中负责调度的组件。它监听<code>apiserver</code>，查询未绑定<code>Node</code>资源的<code>Pod</code>，并跟据调度策略为其选择一个最合适的节点。<br>下面本节将从两个方面来介绍<code>scheduler</code>的实现：</p>
<ol>
<li>初始化过程</li>
<li>单次调度过程</li>
</ol>
<h2 id="4-1-初始化过程"><a href="#4-1-初始化过程" class="headerlink" title="4.1 初始化过程"></a>4.1 初始化过程</h2><p><code>scheduler</code>的初始化过程与其他组件非常类似。创建初始化配置，并将启动参数应用到该配置上，再基于此参数来运行<code>scheudler</code>，同样也会进行初始化参数的验证。</p>
<p>在运行前，<code>scheduler</code>会执行一些<code>init</code>方法注册调度策略（<code>predicates</code>过滤策略、<code>priority</code>优先级策略）<code>register_predicates | register_priority</code>、策略提供器配置（默认提供器和集群自动扩容提供器）<code>defaults</code>。位置位于<code>algorithprovider/defaults</code>。<br>注册时，注册的是<strong>策略构建工厂</strong>，并将其保存在全局变量中<code>scheduler/algorithm_factory.go/</code>。</p>
<p>注册的过滤算法有如下几种：</p>
<blockquote>
<p><strong>PodFitsPorts：</strong>被<code>PodFitsHostPorts</code>取代<br><strong>PodFitsHostPorts：</strong>检查是否有<code>Host Ports</code> 冲突；<br><strong>PodFitsResources：</strong>检查资源可用性（<code>CPU</code>、<code>内存</code>等是否充足），其也是默认的过滤策略；<br><strong>HostName：</strong> 检查 <code>pod.Spec.NodeName</code> 是否与候选节点一致；<br><strong>MatchNodeSelector：</strong>检查候选节点的 <code>pod.Spec.NodeSelector</code> 是否匹配；<br><strong>NoVolumeZoneConflict：</strong>检查 <code>volume zone</code> 是否冲突；<br><strong>MaxEBSVolumeCount：</strong>（<code>废弃</code>）检查 <code>AWS EBS Volume</code> 数量是否过多（<code>默认不超过 39</code>）<br><strong>MaxGCEPDVolumeCount：</strong>（<code>废弃</code>）检查 <code>GCE PD Volume</code> 数量是否过多（默认不超过 <code>16</code>）<br><strong>MaxAzureDiskVolumeCount：</strong>（<code>废弃</code>）检查 <code>Azure Disk Volume</code> 数量是否过多（默认不超过 <code>16</code>）<br><strong>MatchInterPodAffinity：</strong>检查是否匹配 <code>Pod Affinity</code>(<code>亲和度</code>)要求<br><strong>NoDiskConflict：</strong>检查是否存在 <code>Volume 冲突</code>；<br><strong>GeneralPredicates：</strong>由多个<code>过滤策略</code>聚合，所有<code>k8s</code>组件都强制执行，包括<code>PodFitsResources</code>、<code>PodFitsHost</code>，<code>PodFitsHostPorts</code> 和 <code>PodSelectorMatches</code>；<br><strong>PodToleratesNodeTaints：</strong>检查 <code>Pod</code> 是否容忍<code>Node</code>误点 <code>Node Taints</code>；<br><strong>CheckNodeMemoryPressure：</strong>检查 <code>Pod</code> 是否可以调度到 <code>MemoryPressure</code> 的节点上。<br><strong>CheckNodeUnschedulable：</strong> 检查 <code>Pod</code> 是否可以调度到 带有<code>Unschedulable</code> 的节点上；<br><strong>CheckVolumeBinding：</strong> 检查是否能满足<code>Pod</code>的<code>PVC</code>上下界需求。</p>
</blockquote>
<p>注册的优先级排序算法有以下几种：</p>
<blockquote>
<p><strong>SelectorSpreadPriority：</strong>优先减少同一<code>Service</code>下的<code>Pod</code>在同一<code>Node</code>节点上的可能；<br><strong>MostRequestedPriority：</strong>尽量调度到已经使用过的 <code>Node</code> 上，介绍节点使用；<br><strong>RequestedToCapacityRatioPriority：</strong>跟据<code>Node</code>上的资源分配情况计算其分数；<br><strong>ServiceSpreadingPriority：</strong>尽量将同一个 <code>service</code> 的 <code>Pod</code> 分布到不同节点上，被 <code>SelectorSpreadPriority</code> 替代<br><strong>InterPodAffinityPriority：</strong>优先将 <code>Pod</code> 调度到相同的拓扑域上（如同一个节点、地域等）；<br><strong>LeastRequestedPriority：</strong>优先调度到请求资源少的节点上；<br><strong>BalancedResourceAllocation：</strong>优先平衡各节点的资源使用；<br><strong>NodePreferAvoidPodsPriority：</strong>跟据节点<code>scheduler.alpha.kubernetes.io/preferAvoidPods</code>注解来计算<code>Node</code>权重, 权重为 10000，避免其他优先级策略的影响；<br><strong>NodeAffinityPriority：</strong>优先调度到匹配 <code>NodeAffinity</code> 的节点上；<br><strong>TaintTolerationPriority：</strong>优先调度到匹配 <code>TaintToleration</code> 的节点上；<br><strong>ImageLocalityPriority：</strong>尽量将使用大镜像的容器调度到已经下拉了该镜像的节点上。</p>
</blockquote>
<p>注册的算法提供器，包含<code>DefaultProvider</code>和<code>ClusterAutoscalerProvider</code>，默认算法提供器为<code>DefaultProvider</code>：</p>
<ul>
<li><strong>DefaultProvider</strong> 包含默认的过滤和优先级策略：<ul>
<li><code>MaxGCEPDVolumeCount,MaxCSIVolumeCountPred,NoDiskConflict,CheckVolumeBinding,CheckNodeUnschedulable,NoVolumeZoneConflict,MaxEBSVolumeCount,MaxAzureDiskVolumeCount,MatchInterPodAffinity,GeneralPredicates,PodToleratesNodeTaints</code></li>
<li><code>SelectorSpreadPriority,InterPodAffinityPriority,LeastRequestedPriority,BalancedResourceAllocation,NodePreferAvoidPodsPriority,NodeAffinityPriority,TaintTolerationPriority,ImageLocalityPriority</code></li>
</ul>
</li>
<li><strong>ClusterAutoscalerProvider</strong> 包含默认过滤和优先级策略：<ul>
<li><code>MaxGCEPDVolumeCount,MaxCSIVolumeCountPred,NoDiskConflict,CheckVolumeBinding,CheckNodeUnschedulable,NoVolumeZoneConflict,MaxEBSVolumeCount,MaxAzureDiskVolumeCount,MatchInterPodAffinity,GeneralPredicates,PodToleratesNodeTaints</code></li>
<li><code>SelectorSpreadPriority,InterPodAffinityPriority,MostRequestedPriority,BalancedResourceAllocation,NodePreferAvoidPodsPriority,NodeAffinityPriority,TaintTolerationPriority,ImageLocalityPriority</code></li>
</ul>
</li>
</ul>
<p>初始化过程主要在创建<code>Scheduler</code>中，<code>scheduler/scheduler.go/New</code>，笔者第一遍阅读代码的时候发现一个很令人费解的事：<code>Scheduler</code>中存在另外一套插件式策略框架，该框架与之前的注册机制功能作用雷同。后来，从注释中得到了蛛丝马迹，<code>Scheduler</code>正在从第一种方式向第二种方式过度，下面我们将在<code>scheduler</code>的创建过程中介绍这种新的策略框架，插件式策略框架更佳抽象可拓展。</p>
<ol>
<li>首先创建了<code>framework.Registry</code>，其保存了所有可用的插件，以及相应插件的构建函数<code>framework/plugins/default_registry.go/NewDefaultRegistry</code>；</li>
<li>同时构建了<code>DefaultConfigProducerRegistry</code>，其保存了生成插件需要的配置生产者</li>
<li>根据参数生成不同的<code>Scheduler</code>。<ul>
<li>若配置了<code>provider</code>参数，则跟据策略提供者来创建；</li>
<li>若用户自定义了<code>Policy</code>，则通过策略配置来创建调度器，该模式下支持用户通过<code>Extender</code>来拓展实现第三方调度器；</li>
</ul>
</li>
<li>下面将介绍通过<strong>策略提供者</strong>的方式创建<code>Scheduler</code>的过程</li>
<li>跟据<code>ProviderName</code>从之前注册的策略提供者列表中捞出该种类型的策略提供者配置（配置了开启哪些策略），调用<code>Configurator.CreateFromKeys</code>来<strong>进行最核心的初始化流程</strong>；<ol>
<li>构建<code>过滤策略</code>的配置，其包含两部分内容：一部分通过第一种<code>注册构建工厂</code>（这里称之为<code>fitPredicates</code>）的方式，另一种是通过插件式策略框架的方式<code>framework plugins</code><ul>
<li>这两种方式对应的策略集存在交集。对于某种策略来说，若注册了插件配置构造器，则用插件的方式；</li>
<li>对于<strong>插件过滤策略</strong>，其会根据<code>predicates.Ordering()</code>顺序进行排序；</li>
</ul>
</li>
<li>构建<code>优先级策略</code>的配置，其构建方式与上面构建<code>过滤策略</code>的配置的方式一致；</li>
<li>利用上面的得到的配置参数，构建插件框架<code>framework</code>（<code>framework/v1alpha1/framework.go</code>）<ul>
<li>筛选出所有需要的插件；</li>
<li>根据前面构建的<code>framework.Registry</code>和<code>framework</code>来构建插件实体并进行保存</li>
<li>将创建的这些插件策略器按类型赋值给<code>framework</code>的属性，如<code>filterPlugins</code>（对应过滤策略），<code>scorePlugins</code>（对应权重策略）。<ol start="4">
<li>创建一个队列<code>SchedulingQueue</code>，用来接收需要调度的<code>Pod</code>，其是一种优先队列<code>PriorityQueue</code>（后文将单独详细剖析其实现）。</li>
</ol>
</li>
</ul>
</li>
</ol>
</li>
<li>创建完<code>Scheduler</code>后，调用<code>AddAllEventHandlers</code>方法，该方法的作用是监听资源的变更，并回调<code>Scheduler</code>的方法，如监听<code>pod</code>资源变更回调<code>Scheduler.addPodToSchedulingQueue</code>方法；</li>
<li>开启健康检查服务；</li>
<li>若配置了选主，则进行选主；</li>
<li>开启<code>Scheduler</code>的后台运行任务，当有需要调度的<code>Pod</code>到来时，并最终调用<code>scheduleOne</code>。</li>
</ol>
<h2 id="4-2-单次调度过程"><a href="#4-2-单次调度过程" class="headerlink" title="4.2 单次调度过程"></a>4.2 单次调度过程</h2><p>当<code>ReplicaSetController</code>创建<code>Pod</code>之后，<code>Scheduler</code>则会接收到<code>Pod</code>的更新消息，会调用<code>addPodToSchedulingQueue</code>方法，而方法则直接将<code>Pod</code>放入<code>SchedulingQueue</code>中。<br><code>Scheduler.scheduleOne</code>是调度的核心，其阻塞监听<code>SchedulingQueue</code>队列并进行调度，下面将详细介绍该调度过程：</p>
<ol>
<li>阻塞调用<code>Scheduler.NextPod</code>方法，该方法实际是阻塞等待<code>SchedulingQueue</code>；</li>
<li><code>Scheduler</code>接收到新建的<code>Pod</code>后执行<code>Schedule</code>执行调度；<ol>
<li>首先进行一些基础校验：检测<code>Pod</code>设置<code>PVC</code>配置是否存在；</li>
<li>为本此调度执行一次<code>Node</code>节点缓存的快照；</li>
<li>执行<code>PreFilter</code>逻辑，若返回任何除成功以外的状态则终止流程（目前无实现）；</li>
<li>执行<code>findNodesThatFit</code>逻辑，执行过滤策略，筛选出可备用<code>Node</code>节点列表；<ol>
<li>首先计算参与调度的<code>Node</code>节点数量（<code>Scheduler</code>为了提交调度的性能，当节点数量众多时，则每次调度的时候不会选取所有Node节点）<ol>
<li>若节点数小于<code>100</code>，或者配置的<code>percentageOfNodesToScore</code>大于<code>100</code>时，所有节点参与调度；</li>
<li>否则只选出<code>percentageOfNodesToScore</code>个<code>Node</code>节点参数调度；当然若按百分比选出的节点数小于<code>100</code>时，返回<code>100</code></li>
</ol>
</li>
<li>以<code>16</code>并发执行<code>podFitsOnNode</code>方法筛选可用的<code>Node</code>节点候选列表<ol>
<li><code>podFitsOnNode</code>方法执行比较复杂，其涉及到抢占式调度的计算；</li>
<li>首先通过<code>addNominatedPods</code>方法查看当前<code>Node</code>节点上是否有比当前<code>Pod</code>权重大的<code>nominatedPod</code>（通过<code>通过调度要运行在该节点上但未真正运行在该节点上</code>）</li>
<li>运行通过老的筛选策略<code>fitPredicates</code>查看是否可以调度到该节点上；</li>
<li>再运行<code>插件过滤策略</code>检测是否可以在<code>Node</code>上执行；</li>
<li>当任何一个运行结果显示不合适时则立即返回；</li>
<li>若匹配成功且<code>Node</code>节点上无<code>nominatedPod</code>，则返回该节点，表示可以调度到该节点；</li>
<li>若匹配成功但<code>Node</code>上有<code>nominatedPod</code>时，则再次运行依次过滤匹配过程（<strong><code>twice</code></strong>），运行两次的原因是，（<code>源码注释中写的很绕</code>）：<ul>
<li>当没有<code>nominatedPod</code>时，运行第二遍很可能通不过（<code>pod affnitity</code>策略），而``；</li>
<li>当将<code>nominatedPod</code>视为运行状态时，<code>anti-affinity</code>策略很可能失败；而将<code>nominatedPod</code>视为非运行状态时，则<code>pod affinity</code>可能无法通过，因此不能假设<code>nominatedPod</code>是什么状态，所以运行第二次是有必要的<ol start="3">
<li>当系统配置了第三方调度服务时，则会通过<code>Extender</code>（目前有<code>HttpExtender</code>）将上一步运行的结果带去请求第三方服务进行进一步的匹配；</li>
</ol>
</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
<li>当调度结果只有一个时，则直接返回结果；</li>
<li>执行<code>prioritizeNodes</code><ol>
<li>当没有配置<code>权重策略</code>时， 返回输入的节点；</li>
<li>16并发计算每种<code>prioritizers</code>策略对每个节点的权重；<ol>
<li><code>Map</code>操作：计算每个节点的结果集；</li>
<li><code>Reduce</code>（如果有的话）：聚合每个节点的结果集，并计算每个结果的最终结果（<code>归一化</code>）</li>
</ol>
</li>
<li>调用调度框架计算每种权重插件的分数：<code>RunScorePlugins</code><ol>
<li><strong>16并发</strong>运行权重插件，计算每种插件针对每个节点的分数；</li>
<li><strong>16并发</strong>为每个节点的分数乘以每个插件的权重</li>
</ol>
</li>
<li>汇总上面两个计算结果，总结成每个<code>Node</code>的分值 <strong>result</strong>；</li>
<li>最后一步，请求<code>Extender</code>计算每个节点的分值并整合到<code>result</code>上。</li>
</ol>
</li>
<li>根据结果，选中分值最大的<code>Node</code>，当有多个分值一样大的节点时随机选择一个</li>
</ol>
</li>
<li>在绑定<code>Node</code>之前，先绑定<code>vloume</code>资源；</li>
<li>设置<code>Pod</code>节点的<code>SuggestedHost</code>，从<code>SchedulingQueue</code>中删除作为<code>notimatedPod</code>的本<code>pod</code>，将该<code>pod</code>添加到<code>node</code>信息里，将该<code>node</code>移到最前（<code>LRU</code>）；</li>
<li>与<code>apiserver</code>进行绑定，将<code>pod</code>绑定到<code>node</code>上。</li>
</ol>
<p>简单总结其流程如下：<br> <img src="/media/15813607449175.jpg" alt=""></p>
<h2 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h2><p><code>Scheduler</code>中<code>PriorityQueue</code>有着特别的设计，其实现<code>SchedulingQueue</code>接口（存储<code>Pod</code>并等待被调度）。<br>本小节将从初始化和单次添加pod两个方面来介绍它：</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>首先，先来了解其数据结构：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PriorityQueue <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 根据试图被重调度的pod节点信息</span></span><br><span class="line">	podBackoff *PodBackoffMap</span><br><span class="line">   <span class="comment">// 大根堆，按pod的权重来pod数据，可以优先弹出权重最大的pod</span></span><br><span class="line">	activeQ *heap.Heap</span><br><span class="line">	<span class="comment">// 按`backoff`过期时间排序的大根堆，弹出时先访问该堆再访问`activeQ`堆</span></span><br><span class="line">	podBackoffQ *heap.Heap</span><br><span class="line">	<span class="comment">// 保存暂且不可调度的pod列表</span></span><br><span class="line">	unschedulableQ *UnschedulablePodsMap</span><br><span class="line">	<span class="comment">// 保存要被委派给`Node`的pod列表信息</span></span><br><span class="line">	nominatedPods *nominatedPodMap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建完这个<code>PriorityQueue</code>后开启后台任务<code>run</code>：</p>
<ul>
<li><strong>flushBackoffQCompleted：</strong> 从<code>podBackoffQ</code>中捞出超过<code>backoff</code>时间的<code>pod</code>重新放入<code>activeQ</code>中进行调度（每秒运行一次）；</li>
<li><strong>flushUnschedulableQLeftover：</strong>将呆在<code>unschedulableQ</code>中时间超过<code>durationStayUnschedulableQ</code>（60s）时间的<code>pod</code>移到<code>activeQ</code>或者<code>podBackoffQ</code>中（每30秒运行一次）<h3 id="单次入队-amp-弹出"><a href="#单次入队-amp-弹出" class="headerlink" title="单次入队&amp;弹出"></a>单次入队&amp;弹出</h3><code>PriorityQueue.Add</code>方法用于入队：</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *PriorityQueue)</span> <span class="title">Add</span><span class="params">(pod *v1.Pod)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	p.lock.Lock()</span><br><span class="line">	<span class="keyword">defer</span> p.lock.Unlock()</span><br><span class="line">	pInfo := p.newPodInfo(pod)</span><br><span class="line">	<span class="keyword">if</span> err := p.activeQ.Add(pInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> p.unschedulableQ.get(pod) != <span class="literal">nil</span> &#123;</span><br><span class="line">		p.unschedulableQ.<span class="built_in">delete</span>(pod)</span><br><span class="line">	&#125;</span><br><span class="line">	p.podBackoffQ.Delete(pInfo)</span><br><span class="line">	p.nominatedPods.add(pod, <span class="string">""</span>)</span><br><span class="line">	<span class="comment">// 通知队列变更</span></span><br><span class="line">	p.cond.Broadcast()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接添加到<code>activeQ</code>队列中，并且从<code>unschedulableQ</code>和<code>podbackoff!</code>中删除。</p>
<p>弹出方法<code>Pop</code>：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *PriorityQueue)</span> <span class="title">Pop</span><span class="params">()</span> <span class="params">(*framework.PodInfo, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> p.activeQ.Len() == <span class="number">0</span> &#123;</span><br><span class="line">	   <span class="comment">//阻塞等待条件</span></span><br><span class="line">		p.cond.Wait()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 从大根堆中弹出权重最大的`pod`返回</span></span><br><span class="line">	obj, err := p.activeQ.Pop()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	pInfo := obj.(*framework.PodInfo)</span><br><span class="line">	pInfo.Attempts++</span><br><span class="line">	p.schedulingCycle++</span><br><span class="line">	<span class="keyword">return</span> pInfo, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2020/02/06/k8s/5.k8s-controllermanager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/06/k8s/5.k8s-controllermanager/" itemprop="url">kube-controller-manager</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-06T00:00:00+08:00">2020-02-06</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="3-controller-manager"><a href="#3-controller-manager" class="headerlink" title="3. controller-manager"></a>3. controller-manager</h1><p><code>controller-manager</code>是整个<code>k8s</code>的大脑，<br>其由<code>kube-conrtoller-manager</code>和<code>cloud-controller-manager</code>组成。其中<code>clound-controller-manager</code>用来配合云服务提供商的控制，因此本章将不对其做详细描述。<br><code>controller-manager</code>中包含众多控制器见附件^1，通过这些控制器来完成集群管理的作用。监控集群状态，并确保集群处于预期的状态。<br>本节，将从如下几个方面来讲解<code>controller-manager</code>的工作原理：</p>
<ol>
<li>启动过程</li>
<li>单次部署的执行过程</li>
<li>pod自动横向伸缩工作原理</li>
</ol>
<h2 id="3-1-启动过程"><a href="#3-1-启动过程" class="headerlink" title="3.1 启动过程"></a>3.1 启动过程</h2><p><code>controller-manager</code>启动入口<code>cmd/kube-controller-manager/controller-manager.go</code>，与<code>apiserver</code>一样其也是基于<code>CLI</code>框架<code>Cobra</code>来实现。<br>其初始化过程如下：</p>
<ol>
<li>首先创建一个带有默认参数的<code>KubeControllerManagerOption</code>，用于构建控制器管理器；<ul>
<li>其中带有各控制器创建的配置参数</li>
</ul>
</li>
<li>通过<code>cobra</code>将输入参数应用到<code>KubeControllerManagerOption</code>上，运行前，会先对参数进行校验；</li>
<li>跟据<code>KubeControllerManagerOptions</code>构建创建众多控制器的配置参数<code>kubecontrollerconfig.Config</code><ol>
<li>跟据输入参数构建与<code>apiserver</code>交互的<code>client</code>；</li>
<li>创建用于选主的通信客户端<code>leaderElectionClient</code>；</li>
<li>创建一个事件记录器，用于记录事件并将事件以<code>v1.Event</code>发送给<code>apiserver</code>；</li>
<li>将<code>KubeControllerManagerOptions</code>中的配置应用到<code>kubecontrollerconfig.Config</code>。</li>
</ol>
</li>
<li>开启运行<code>控制器</code>管理器。<ol>
<li>为<code>controller-manager</code>创建两个http服务，分别用来做健康检查、配置查询；</li>
<li>若配置需要选主，则先选主（没有那么复杂， 只是先到先得的原则）。若选主成功则开始初始化其内部组件，众多控制器；</li>
<li>运行组件<ul>
<li>创建控制器上下文<code>ControllerContext</code>，实际是提前构建一些通用的组件<ol>
<li>分别创建两个<code>Informer</code>工厂，<code>shared-informers</code>以及<code>metadata-informers</code>；</li>
<li>等待<code>apiserver</code>就绪，最多等待<code>10s</code>；</li>
<li>查询<code>apiserver</code>中所有可用的资源；</li>
<li>创建云提供商工具<ul>
<li>跟据控制器上下文来开启控制器</li>
</ul>
<ol>
<li>开启<code>ServiceAccount</code>控制器；</li>
<li><code>app/controllermanager.go.NewControllerInitializer</code>方法中保存了所有控制器的初始化函数，遍历并执行所有控制器的初始化函数，开启这些控制器的执行。比如<code>DeploymentController</code>、<code>ReplicaSetController</code>等；</li>
</ol>
<ul>
<li>开始两个<code>Informer</code>工厂，开始同步并监听资源更新。</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ol>
</li>
</ol>
<p>到此就完成了<code>controller-manager</code>的初始化过程。<br>下面我们以<code>DeploymentController</code>来讲解其初始化详细过程，<code>DeploymentController</code>的初始化函数是<code>startDeploymentController</code>：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dc, err := deployment.NewDeploymentController(</span><br><span class="line">	ctx.InformerFactory.Apps().V1().Deployments(),</span><br><span class="line">	ctx.InformerFactory.Apps().V1().ReplicaSets(),</span><br><span class="line">	ctx.InformerFactory.Core().V1().Pods(),</span><br><span class="line">	ctx.ClientBuilder.ClientOrDie(<span class="string">"deployment-controller"</span>),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">go</span> dc.Run(<span class="keyword">int</span>(ctx.ComponentConfig.DeploymentController.ConcurrentDeploymentSyncs), ctx.Stop)</span><br></pre></td></tr></table></figure>
<p>可以看到，其关注监听<code>Deployment</code>、<code>ReplicaSets</code>和<code>Pod</code>资源。再继续查看<code>DeploymentController</code>的创建过程，其关注这三种资源，并且添加事件监听器，当<code>Deployment</code>资源更新时回调<code>addDeplotment\updateDeployment\deleteDeployment</code>方法，<code>ReplicaSets</code>和<code>Pod</code>的更新也会回调<code>DeploymentController</code>的相应方法。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dc := &amp;DeploymentController&#123;</span><br><span class="line">	client:        client,</span><br><span class="line">	eventRecorder: eventBroadcaster.NewRecorder(scheme.Scheme, v1.EventSource&#123;Component: <span class="string">"deployment-controller"</span>&#125;),</span><br><span class="line">	queue:         workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), <span class="string">"deployment"</span>),</span><br><span class="line">&#125;</span><br><span class="line">dc.rsControl = controller.RealRSControl&#123;</span><br><span class="line">	KubeClient: client,</span><br><span class="line">	Recorder:   dc.eventRecorder,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">	AddFunc:    dc.addDeployment,</span><br><span class="line">	UpdateFunc: dc.updateDeployment,</span><br><span class="line">	DeleteFunc: dc.deleteDeployment,</span><br><span class="line">&#125;)</span><br><span class="line">rsInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">	AddFunc:    dc.addReplicaSet,</span><br><span class="line">	UpdateFunc: dc.updateReplicaSet,</span><br><span class="line">	DeleteFunc: dc.deleteReplicaSet,</span><br><span class="line">&#125;)</span><br><span class="line">podInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">	DeleteFunc: dc.deletePod,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>创建完成后，调用<code>Run</code>方法开始运行<code>DeploymentController</code>，当然运行前需要这三种资源都从<code>apiserver</code>同步到其本地，然后开启多个协程执行<code>worker</code>逻辑。<br><code>worker</code>从<code>Controller</code>自身的<code>queue</code>中阻塞式等待数据，然后执行<code>syncDeploymet</code>方法，这里则是其的核心处理逻辑。</p>
<h2 id="3-2-pod单次部署执行过程"><a href="#3-2-pod单次部署执行过程" class="headerlink" title="3.2 pod单次部署执行过程"></a>3.2 pod单次部署执行过程</h2><p>  单次执行<code>Deployment</code>进行部署时，其经历主过程如下：<code>DeploymenetController</code>接收创建<code>Deployment</code>的请求，进行解析创建<code>ReplicaSet</code>资源，而后<code>ReplicaSetController</code>接收到创建<code>ReplicaSet</code>的请求则创建响应的<code>Pod</code>资源信息。<br>除了简单部署之外，各控制器组件同时需要保障部署运行实情与<code>期望</code>一致。以下就是部署过程的简要流程图：</p>
<p><img src="/media/15812219131772.jpg" alt=""></p>
<p>下面将详细介绍其执行流程：</p>
<ol>
<li><code>kubectl</code>执行<code>create deployment.yml</code>命令后，<code>apiserver</code>接收请求，并将其保存到<code>etcd</code>中；</li>
<li>由于<code>controller-manager</code>中的<code>DeploymentController</code>，所以变更会推送到<code>DeploymentController</code>的<code>deploymentInformer</code>中，而<code>deploymentInformer</code>则会回调<code>DeploymentController.addDeployment</code>方法；</li>
<li><code>addDeployment</code>方法并不会立即处理<code>Deployment</code>，而是将该<code>Deployment</code>生成的唯一<strong>key</strong> 入队列<code>queue</code>（该队列支持限流）；</li>
<li><code>DeploymentController.processBexrWorkItem</code>会阻塞等待队列中的资源更新（系统可以启动多个工作协程同时监听该队列，以提升吞吐），最后会调用<strong>核心方法</strong><code>syncDeployment</code>进行处理；</li>
<li><code>DeploymentController.syncDeployment</code>方法不仅处理初次部署的情况，同时也负责更新以及由其发起的部署集群发生变化的处理逻辑：<ol>
<li>通过<code>key</code>获取发生变更的<code>Deployment</code>；</li>
<li>获取该<code>Deployment</code>创建的<code>ReplicaSet</code>，这里因为是新创建的<code>Deployment</code>所以查询不到<code>ReplicaSet</code>；</li>
<li>获取该<code>Deployment</code>间接创建的所有<code>Pod</code></li>
<li>若<code>Deployment</code>的属性<code>DeletionTimestamp</code>不为空时表示该<code>Deployment</code>被删除，则只同步状态；</li>
<li>检查<code>Deployment</code>是否被暂停或者恢复，并设置相应的状态，若被暂停则进一步进行清理；</li>
<li>若该<code>Deployment</code>是进行回滚操作，则执行<code>rollback</code>回滚相应逻辑；</li>
<li>检查<code>Deployment</code>是否需要进行扩缩容（通过检查其对应的<code>ReplicaSet</code>所有的分片数与理想状态是否一致来判断）</li>
<li>若是扩缩容事件，则执行同步方法<code>sync</code></li>
<li>若不是，则是初次创建，部署时有两种策略：<strong>Recreate</strong>、<strong>RollingUpdate</strong>（针对升级的情况，默认是<strong>RollingUpdate</strong>），这里我们就以<code>RollingUpdate</code>为例来查看其执行过程（<code>DeploymentController.rolloutRolling</code>）：<ol>
<li>首先会获取所有新老<code>ReplicaSet</code>。当不存在<code>ReplicaSet</code>时，则跟据<code>Deployment</code>属性创建一个<code>ReplicaSet</code>，并发送到<code>apiserver</code>（<code>DeploymentController.getNewReplicaSet</code>）；</li>
<li>更新<code>Deployment</code>的状态</li>
</ol>
</li>
</ol>
</li>
<li><code>ReplicaSetController</code>监听<code>ReplicaSet</code>的更新，上面<code>DeploymentController</code>创建<code>ReplicaSet</code>后，<code>ReplicaSetController</code>会受到通知（与<code>DeploymentController</code>执行方式一样，也通过<code>queue</code>和多个<code>worker</code>来处理更新）并最终调用<code>ReplicaSetController.syncReplicaSet</code>方法：<ol>
<li>获取同一命名空间内的所有存活的<code>Pod</code>；</li>
<li>并通过<code>ReplicaSet</code>的<code>Selector</code>筛选出由其创建的<code>Pod</code>；</li>
<li><code>manageReplicas</code>方法管理<code>ReplicaSet</code>，计算已经创建的<code>Pod</code>数和<code>ReplicaSet</code>的预期的<code>Pod</code>差值<ul>
<li>当<code>Pod</code>数不足时，则依次跟据<code>ReplicaSet</code>的配置<code>PodTemplateSepc</code>创建<code>Pod</code>，同时设置上<code>Pod</code>的<code>OwnerRefernce</code>（用于<code>gc</code>）；</li>
<li>当<code>Pod</code>数过多时，则并发删除多余的<code>Pod</code>。</li>
</ul>
</li>
<li>更新<code>ReplicaSet</code>的状态。</li>
</ol>
</li>
</ol>
<p>到此就完成了<code>Pod</code>的创建，但创建的<code>Pod</code>还不能工作，需要被调度到某个<code>Node</code>上才能运行。至于应该被调度到哪个节点上，这就涉及到调度器的实现逻辑，将在下节<code>scheduler</code>中介绍。</p>
<h2 id="3-3-pod自动横向伸缩"><a href="#3-3-pod自动横向伸缩" class="headerlink" title="3.3 pod自动横向伸缩"></a>3.3 pod自动横向伸缩</h2><p><code>k8s</code>中负责<code>pod</code>自动横向伸缩的控制器叫<code>HorizontalController</code>。首先看其控制器初始化：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startHPAController</span><span class="params">(ctx ControllerContext)</span> <span class="params">(http.Handler, <span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 若此项为true，则表示从组合API服务获取指标数据，而不是通过apiserver</span></span><br><span class="line">	<span class="keyword">if</span> ctx.ComponentConfig.HPAController.HorizontalPodAutoscalerUseRESTClients &#123;</span><br><span class="line">		<span class="keyword">return</span> startHPAControllerWithRESTClient(ctx)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> startHPAControllerWithLegacyClient(ctx)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startHPAControllerWithRESTClient</span><span class="params">(ctx ControllerContext)</span> <span class="params">(http.Handler, <span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 创建获取指标的客户端</span></span><br><span class="line">	metricsClient := metrics.NewRESTMetricsClient(</span><br><span class="line">		resourceclient.NewForConfigOrDie(clientConfig),</span><br><span class="line">		custom_metrics.NewForConfig(clientConfig, ctx.RESTMapper, apiVersionsGetter),</span><br><span class="line">		external_metrics.NewForConfigOrDie(clientConfig),</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">return</span> startHPAControllerWithMetricsClient(ctx, metricsClient)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startHPAControllerWithMetricsClient</span><span class="params">(ctx ControllerContext, metricsClient metrics.MetricsClient)</span> <span class="params">(http.Handler, <span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// scale类型解析器，用于给定特定资源解析出奇`Scacle`子资源类型</span></span><br><span class="line">	scaleKindResolver := scale.NewDiscoveryScaleKindResolver(hpaClient.Discovery())</span><br><span class="line">	scaleClient, err := scale.NewForConfig(hpaClientConfig, ctx.RESTMapper, dynamic.LegacyAPIPathResolverFunc, scaleKindResolver)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 创建控制器，并异步运行</span></span><br><span class="line">	<span class="keyword">go</span> podautoscaler.NewHorizontalController(</span><br><span class="line">		hpaClient.CoreV1(),</span><br><span class="line">		scaleClient,</span><br><span class="line">		hpaClient.AutoscalingV1(),</span><br><span class="line">		ctx.RESTMapper,</span><br><span class="line">		metricsClient,</span><br><span class="line">		ctx.InformerFactory.Autoscaling().V1().HorizontalPodAutoscalers(),</span><br><span class="line">		ctx.InformerFactory.Core().V1().Pods(),</span><br><span class="line">		ctx.ComponentConfig.HPAController.HorizontalPodAutoscalerSyncPeriod.Duration,</span><br><span class="line">		ctx.ComponentConfig.HPAController.HorizontalPodAutoscalerDownscaleStabilizationWindow.Duration,</span><br><span class="line">		ctx.ComponentConfig.HPAController.HorizontalPodAutoscalerTolerance,</span><br><span class="line">		ctx.ComponentConfig.HPAController.HorizontalPodAutoscalerCPUInitializationPeriod.Duration,</span><br><span class="line">		ctx.ComponentConfig.HPAController.HorizontalPodAutoscalerInitialReadinessDelay.Duration,</span><br><span class="line">	).Run(ctx.Stop)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHorizontalController</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	evtNamespacer v1core.EventsGetter,</span></span></span><br><span class="line"><span class="function"><span class="params">	scaleNamespacer scaleclient.ScalesGetter,</span></span></span><br><span class="line"><span class="function"><span class="params">	hpaNamespacer autoscalingclient.HorizontalPodAutoscalersGetter,</span></span></span><br><span class="line"><span class="function"><span class="params">	mapper apimeta.RESTMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">	metricsClient metricsclient.MetricsClient,</span></span></span><br><span class="line"><span class="function"><span class="params">	hpaInformer autoscalinginformers.HorizontalPodAutoscalerInformer,</span></span></span><br><span class="line"><span class="function"><span class="params">	podInformer coreinformers.PodInformer,</span></span></span><br><span class="line"><span class="function"><span class="params">	resyncPeriod time.Duration,</span></span></span><br><span class="line"><span class="function"><span class="params">	downscaleStabilisationWindow time.Duration,</span></span></span><br><span class="line"><span class="function"><span class="params">	tolerance <span class="keyword">float64</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	cpuInitializationPeriod,</span></span></span><br><span class="line"><span class="function"><span class="params">	delayOfInitialReadinessStatus time.Duration,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">)</span> *<span class="title">HorizontalController</span></span> &#123;</span><br><span class="line">	hpaController := &amp;HorizontalController&#123;</span><br><span class="line">		eventRecorder:                recorder,</span><br><span class="line">		scaleNamespacer:              scaleNamespacer,</span><br><span class="line">		hpaNamespacer:                hpaNamespacer,</span><br><span class="line">		downscaleStabilisationWindow: downscaleStabilisationWindow,</span><br><span class="line">		queue:                        workqueue.NewNamedRateLimitingQueue(NewDefaultHPARateLimiter(resyncPeriod), <span class="string">"horizontalpodautoscaler"</span>),</span><br><span class="line">		mapper:                       mapper,</span><br><span class="line">		recommendations:              <span class="keyword">map</span>[<span class="keyword">string</span>][]timestampedRecommendation&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">// 监听资源更新并回调相应的处理函数</span></span><br><span class="line">	hpaInformer.Informer().AddEventHandlerWithResyncPeriod(</span><br><span class="line">		cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">			AddFunc:    hpaController.enqueueHPA,</span><br><span class="line">			UpdateFunc: hpaController.updateHPA,</span><br><span class="line">			DeleteFunc: hpaController.deleteHPA,</span><br><span class="line">		&#125;,</span><br><span class="line">		resyncPeriod,</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// 创建分片计算器，基于目标资源利用率来计算预期的分片数</span></span><br><span class="line">	replicaCalc := NewReplicaCalculator(</span><br><span class="line">		metricsClient,</span><br><span class="line">		hpaController.podLister,</span><br><span class="line">		tolerance,</span><br><span class="line">		cpuInitializationPeriod,</span><br><span class="line">		delayOfInitialReadinessStatus,</span><br><span class="line">	)</span><br><span class="line">	hpaController.replicaCalc = replicaCalc</span><br><span class="line">	<span class="keyword">return</span> hpaController</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>HorizontalController</code>的初始化过程流程主要做了以下几件事：</p>
<ol>
<li>创建<code>Metrics</code>查询客户端；</li>
<li>创建分片计算器；</li>
<li>创建<code>hpa</code>资源<code>informer</code>，监听该资源变更并回调相应的函数<code>enqueueHPA</code>、<code>updateHPA</code>、<code>deleteHPA</code></li>
</ol>
<p>下面将来详细介绍其运行原理：<br>通过<code>kubectl</code>执行<code>autoscale</code>命令<code>kubectl autoscale deployment nginx-deployment --cpu-percent=30 --min=7 --max=8</code>后，<strong>HorizontalController</strong>会接收到<code>HorizontalPodAutoscaler</code>新增消息，最终会执行<code>HorizontalController.reconcileAutoscaler</code>方法。该方法是控制器的<strong>核心逻辑</strong>，其执行过程如下：</p>
<ol>
<li>通过<code>hpa</code>的属性获取对应资源（可以是<code>Deployment</code>也可以是其他）的<code>Scale</code>中的分片数信息；</li>
<li>进行逻辑判断：<ol>
<li>若当前分片数为0但最小分片数不为0，则不进行自动扩容；</li>
<li>若当前分片数大于<code>hpa</code>定义的最大分片数则将目标分片数（<code>desiredReplicas</code>）设置成最大分片数；</li>
<li>若当前分片数小于<code>hpa</code>定义的最小分片数则将目标分片数设置成该最小分片数；</li>
<li>都不满足的话则执行第三步跟据<code>Metrics</code>信息计算需要部署的分片数</li>
</ol>
</li>
<li>执行<code>HorizontalController.computeReplicasForMetrics</code>方法计算目标分片数：<ol>
<li>定义<code>hpa</code>时可以定义多个指标维度的扩缩容策略，比如<code>cpu</code>等。因此这里会按每个指标信息依次计算目标分片数，最后取最大值作为最终的目标值；</li>
<li>对于指标（<code>MetricSpec</code>），<code>k8s</code>对齐进行了分类，主要分为四类，没类的计算方式也不同：<ol>
<li><strong>Object：</strong> 描述 <code>k8s</code> 对象，如<code>hits-per-second</code>；</li>
<li><strong>Pods：</strong> 描述目标中每个<code>Pod</code>信息，如<code>transactions-processed-per-second</code>，而这些值在比较前会进行求平均；</li>
<li><strong>Resource：</strong>是<code>k8s</code>中一个知名度量信息，在<code>request</code>和<code>limit</code>中进行定义的资源；</li>
<li><strong>External：</strong>拓展指标信息，来自于<code>k8s</code>集群之外的信息。<ol start="3">
<li>下面以<code>Resource</code>为例，来讲解其计算过程（<code>HorizontalController.computeStatusForResourceMetric</code>）：</li>
</ol>
</li>
<li>最终调用的是<code>ReplicaCalculator</code>分片计算器的<code>GetRawResourceReplicas</code>方法；</li>
<li>首先，通过<code>metricsClient</code>查询每个<code>Pod</code>的<code>Metrics</code>信息；</li>
<li>进行以下条件判断和计算目标分片数<ul>
<li>首先计算当前测量的<code>metric</code>的平均值和目标值的比例（<code>usageRatio</code>）；</li>
<li>若没有未就绪的<code>pod</code>且当前指标大于目标值时：<ul>
<li>当差值在<strong>10%</strong>（默认<code>可容忍值</code>）之内，则直接<strong>返回</strong>原值；</li>
<li>若大于<strong>10%</strong>时，则<strong>返回</strong>分片数：<code>usageRatio</code>乘以当前<code>Pod</code>数；</li>
</ul>
</li>
<li>如有<code>Pod</code>未收集到指标信息<ul>
<li>当<code>usageRatio</code>小于0，将未收集到的指标设置零时为<code>目标值</code>；</li>
<li>若<code>usageRatio</code>大于0，将未收集的指标设置零时为<code>0</code>；<ul>
<li>当<code>usageRatio</code>大于0，将所有未就绪的<code>Pod</code>指标设置为<code>0</code></li>
<li>对修改过的数据重新计算<code>usageRatio</code>；</li>
<li>当新的<code>usageRatio&lt;1.1</code>(0.1是容忍度)或者<code>oldUageRatio&lt;1&amp;&amp;newUsageRatio&gt;1</code>或者<code>oldUageRatio&gt;1&amp;&amp;newUsageRatio&lt;1</code>时，直接返回原值；</li>
<li>否则返回<code>newUsageRatio</code>乘以所有<code>pod</code>数量（也及以<code>newUsageRatio</code>比例来扩容）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>并不是计算出来就用这个值</strong>，还需要对伸缩速率做一次调整(<code>normalizeDesiredReplicas</code>)：<ul>
<li><strong>根据历史值来调整该值</strong>（<code>stabilizeRecommendation</code>）：<ul>
<li><code>HPA</code>中保存每次计算结果和时间戳，<code>timestampedRecommendation</code>；</li>
<li><code>HPA</code>启动时会设置一个窗口期<code>downscaleStabilisationWindow</code>（默认<code>5min</code>）</li>
<li>找到窗口期之内历史计算结果，若历史推荐分片数比当前推荐的大，则覆盖当前的</li>
</ul>
</li>
<li><strong>速率限制</strong>（<code>convertDesiredReplicasWithRules</code>）<ul>
<li>防止扩容过快，限制最大不能超过当前实例数的两倍；<ol start="4">
<li>获取目标分片数时，若与原值不相等则通过<code>Scales</code>接口将分片数修改成目标值（实际，<code>Scales</code>只是一个包装，其实质是更新<code>Deployment</code>的<code>Replica</code>只）</li>
<li>当<code>DeploymentController</code>接收到更新后，就会引发其扩缩容操作，上一小节中已经介绍。<br>到此，<code>HPA</code>的单次操作执行流程就介绍完了，下面以一张图来简要描述该过程：<br><img src="/media/15812690927770.jpg" alt=""></li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><h3 id="1-控制器列表"><a href="#1-控制器列表" class="headerlink" title="1. 控制器列表"></a>1. 控制器列表</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">controllers := <span class="keyword">map</span>[<span class="keyword">string</span>]InitFunc&#123;&#125;</span><br><span class="line">controllers[<span class="string">"endpoint"</span>] = startEndpointController</span><br><span class="line">controllers[<span class="string">"endpointslice"</span>] = startEndpointSliceController</span><br><span class="line">controllers[<span class="string">"replicationcontroller"</span>] = startReplicationController</span><br><span class="line">controllers[<span class="string">"podgc"</span>] = startPodGCController</span><br><span class="line">controllers[<span class="string">"resourcequota"</span>] = startResourceQuotaController</span><br><span class="line">controllers[<span class="string">"namespace"</span>] = startNamespaceController</span><br><span class="line">controllers[<span class="string">"serviceaccount"</span>] = startServiceAccountController</span><br><span class="line">controllers[<span class="string">"garbagecollector"</span>] = startGarbageCollectorController</span><br><span class="line">controllers[<span class="string">"daemonset"</span>] = startDaemonSetController</span><br><span class="line">controllers[<span class="string">"job"</span>] = startJobController</span><br><span class="line">controllers[<span class="string">"deployment"</span>] = startDeploymentController</span><br><span class="line">controllers[<span class="string">"replicaset"</span>] = startReplicaSetController</span><br><span class="line">controllers[<span class="string">"horizontalpodautoscaling"</span>] = startHPAController</span><br><span class="line">controllers[<span class="string">"disruption"</span>] = startDisruptionController</span><br><span class="line">controllers[<span class="string">"statefulset"</span>] = startStatefulSetController</span><br><span class="line">controllers[<span class="string">"cronjob"</span>] = startCronJobController</span><br><span class="line">controllers[<span class="string">"csrsigning"</span>] = startCSRSigningController</span><br><span class="line">controllers[<span class="string">"csrapproving"</span>] = startCSRApprovingController</span><br><span class="line">controllers[<span class="string">"csrcleaner"</span>] = startCSRCleanerController</span><br><span class="line">controllers[<span class="string">"ttl"</span>] = startTTLController</span><br><span class="line">controllers[<span class="string">"bootstrapsigner"</span>] = startBootstrapSignerController</span><br><span class="line">controllers[<span class="string">"tokencleaner"</span>] = startTokenCleanerController</span><br><span class="line">controllers[<span class="string">"nodeipam"</span>] = startNodeIpamController</span><br><span class="line">controllers[<span class="string">"nodelifecycle"</span>] = startNodeLifecycleController</span><br><span class="line"><span class="keyword">if</span> loopMode == IncludeCloudLoops &#123;</span><br><span class="line">	controllers[<span class="string">"service"</span>] = startServiceController</span><br><span class="line">	controllers[<span class="string">"route"</span>] = startRouteController</span><br><span class="line">	controllers[<span class="string">"cloud-node-lifecycle"</span>] = startCloudNodeLifecycleController</span><br><span class="line">&#125;</span><br><span class="line">controllers[<span class="string">"persistentvolume-binder"</span>] = startPersistentVolumeBinderController</span><br><span class="line">controllers[<span class="string">"attachdetach"</span>] = startAttachDetachController</span><br><span class="line">controllers[<span class="string">"persistentvolume-expander"</span>] = startVolumeExpandController</span><br><span class="line">controllers[<span class="string">"clusterrole-aggregation"</span>] = startClusterRoleAggregrationController</span><br><span class="line">controllers[<span class="string">"pvc-protection"</span>] = startPVCProtectionController</span><br><span class="line">controllers[<span class="string">"pv-protection"</span>] = startPVProtectionController</span><br><span class="line">controllers[<span class="string">"ttl-after-finished"</span>] = startTTLAfterFinishedController</span><br><span class="line">controllers[<span class="string">"root-ca-cert-publisher"</span>] = startRootCACertPublisher</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2020/02/05/k8s/4.k8s-informer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/05/k8s/4.k8s-informer/" itemprop="url">通信组件 Informer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-05T00:00:00+08:00">2020-02-05</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="2-Informer"><a href="#2-Informer" class="headerlink" title="2. Informer"></a>2. Informer</h1><p>[TOC]</p>
<p>在介绍完<code>apiserver</code>之后，在介绍其他重要组件之前，本章将介绍各组件与<code>apiserver</code>交互的重要工具<code>Informer</code>。通过其我们可以轻松<code>List\Get</code>所有资源对象，同时可以监听资源的变更事件，当变化发生时触发回调函数。<br>下面将从<code>Informer</code>的初始化过程、更新变更两个方便来讲解其工作原理。</p>
<h2 id="初始化-amp-监听更新变更流程"><a href="#初始化-amp-监听更新变更流程" class="headerlink" title="初始化&amp;监听更新变更流程"></a>初始化&amp;监听更新变更流程</h2><p>首先，<code>k8s</code> 里 <code>Informer</code> 的创建需要借助于<code>SharedInformerFactory</code>，其可以提供<code>k8s</code>中已知所有API组版本资源的 <code>informer</code> ，其接口定义如下 ：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SharedInformerFactory <span class="keyword">interface</span> &#123;</span><br><span class="line">	internalinterfaces.SharedInformerFactory</span><br><span class="line">	ForResource(resource schema.GroupVersionResource) (GenericInformer, error)</span><br><span class="line">	WaitForCacheSync(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="keyword">map</span>[reflect.Type]<span class="keyword">bool</span></span><br><span class="line">	Admissionregistration() admissionregistration.Interface</span><br><span class="line">	Apps() apps.Interface</span><br><span class="line">	Auditregistration() auditregistration.Interface</span><br><span class="line">	Autoscaling() autoscaling.Interface</span><br><span class="line">	Batch() batch.Interface</span><br><span class="line">	Certificates() certificates.Interface</span><br><span class="line">	Coordination() coordination.Interface</span><br><span class="line">	Core() core.Interface</span><br><span class="line">	Discovery() discovery.Interface</span><br><span class="line">	Events() events.Interface</span><br><span class="line">	Extensions() extensions.Interface</span><br><span class="line">	Flowcontrol() flowcontrol.Interface</span><br><span class="line">	Networking() networking.Interface</span><br><span class="line">	Node() node.Interface</span><br><span class="line">	Policy() policy.Interface</span><br><span class="line">	Rbac() rbac.Interface</span><br><span class="line">	Scheduling() scheduling.Interface</span><br><span class="line">	Settings() settings.Interface</span><br><span class="line">	Storage() storage.Interface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> internalinterfaces.SharedInformerFactory <span class="keyword">interface</span> &#123;</span><br><span class="line">	Start(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	InformerFor(obj runtime.Object, newFunc NewInformerFunc) cache.SharedIndexInformer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出其包含所有资源（Api组、版本）操作的接口定义。<code>SharedInformerFactory</code>的默认实现如下：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sharedInformerFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">	client           kubernetes.Interface</span><br><span class="line">	namespace        <span class="keyword">string</span></span><br><span class="line">	tweakListOptions internalinterfaces.TweakListOptionsFunc</span><br><span class="line">	lock             sync.Mutex</span><br><span class="line">	<span class="comment">//重同步间隔</span></span><br><span class="line">	defaultResync    time.Duration</span><br><span class="line">	<span class="comment">// 自定义特定类型重同步时间</span></span><br><span class="line">	customResync     <span class="keyword">map</span>[reflect.Type]time.Duration</span><br><span class="line">    <span class="comment">// 指定类型的Informer</span></span><br><span class="line">	informers <span class="keyword">map</span>[reflect.Type]cache.SharedIndexInformer</span><br><span class="line">    <span class="comment">// 指定类型的Informer是否开启</span></span><br><span class="line">	startedInformers <span class="keyword">map</span>[reflect.Type]<span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>client</code>是<code>k8s</code>中所有<code>API</code>资源操作（更删改查）的工具（其通过http与<code>apiserver</code>通信）。<br>下面，就以<code>PodInformer</code>为例来讲解其创建过程：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sharedInformerFactory.Core().V1().Pods().Informer()</span><br><span class="line">|- core.New(f, f.namespace, f.tweakListOptions)</span><br><span class="line">    |- v1.New(g.factory, g.namespace, g.tweakListOptions)</span><br><span class="line">        |- podInformer&#123;factory: v.factory, namespace: v.namespace, tweakListOptions: v.tweakListOptions&#125;</span><br></pre></td></tr></table></figure>
<p><code>podInformer</code>实际只是包装类，其包含两个方法，其中<code>Informer()</code>方法用来创建最重要的<code>ShardIndexInformer</code>，<code>Lister()</code>用来构建<code>pod</code>信息查询器：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PodInformer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Informer() cache.SharedIndexInformer</span><br><span class="line">	Lister() v1.PodLister</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面来重点讲解<code>Informer()</code>方法：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *podInformer)</span> <span class="title">defaultInformer</span><span class="params">(client kubernetes.Interface, resyncPeriod time.Duration)</span> <span class="title">cache</span>.<span class="title">SharedIndexInformer</span></span> &#123;</span><br><span class="line">  <span class="comment">// 创建ShardInformer</span></span><br><span class="line">	<span class="keyword">return</span> NewFilteredPodInformer(client, f.namespace, resyncPeriod, cache.Indexers&#123;cache.NamespaceIndex: cache.MetaNamespaceIndexFunc&#125;, f.tweakListOptions)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *podInformer)</span> <span class="title">Informer</span><span class="params">()</span> <span class="title">cache</span>.<span class="title">SharedIndexInformer</span></span> &#123;</span><br><span class="line">    <span class="comment">// 向`ShardInformerFactory`中注册`Pod`的Informer</span></span><br><span class="line">	<span class="keyword">return</span> f.factory.InformerFor(&amp;corev1.Pod&#123;&#125;, f.defaultInformer)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建 SharedIndexInformer</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSharedIndexInformer</span><span class="params">(lw ListerWatcher, objType runtime.Object, defaultEventHandlerResyncPeriod time.Duration, indexers Indexers)</span> <span class="title">SharedIndexInformer</span></span> &#123;</span><br><span class="line">	realClock := &amp;clock.RealClock&#123;&#125;</span><br><span class="line">	sharedIndexInformer := &amp;sharedIndexInformer&#123;</span><br><span class="line">		<span class="comment">// 处理器，维护事件变更监听</span></span><br><span class="line">		processor:                       &amp;sharedProcessor&#123;clock: realClock&#125;,</span><br><span class="line">		<span class="comment">// 存储索引，支持通过多个索引函数来查询对象</span></span><br><span class="line">		indexer:                         NewIndexer(DeletionHandlingMetaNamespaceKeyFunc, indexers),</span><br><span class="line">		<span class="comment">// 查询监听器，用时实时请求apiserver查询监听数据</span></span><br><span class="line">		listerWatcher:                   lw,</span><br><span class="line">		<span class="comment">// 资源对象类型 pod</span></span><br><span class="line">		objectType:                      objType,</span><br><span class="line">		resyncCheckPeriod:               defaultEventHandlerResyncPeriod,</span><br><span class="line">		defaultEventHandlerResyncPeriod: defaultEventHandlerResyncPeriod,</span><br><span class="line">		cacheMutationDetector:           NewCacheMutationDetector(fmt.Sprintf(<span class="string">"%T"</span>, objType)),</span><br><span class="line">		clock:                           realClock,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sharedIndexInformer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此，即看到了<code>pod</code>的<code>shardIndexInformer</code>的创建过程，接下来看<code>shardIndexInformer</code>的运行机制。</p>
<p><code>sharedIndexInformer</code>的<strong>定义</strong>如下：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sharedIndexInformer <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 存储索引，支持通过多个索引函数来查询对象</span></span><br><span class="line">	indexer    Indexer</span><br><span class="line">	<span class="comment">// 通用控制器</span></span><br><span class="line">	controller Controller</span><br><span class="line">	<span class="comment">// 处理器，事件监听维护者</span></span><br><span class="line">	processor             *sharedProcessor</span><br><span class="line">	<span class="comment">// 变更探测器</span></span><br><span class="line">	cacheMutationDetector MutationDetector</span><br><span class="line">   <span class="comment">// 查询监听器，用时实时请求apiserver查询监听数据</span></span><br><span class="line">	listerWatcher ListerWatcher</span><br><span class="line">	<span class="comment">// 资源对象类型</span></span><br><span class="line">	objectType    runtime.Object</span><br><span class="line">   <span class="comment">// 重同步验证周期</span></span><br><span class="line">	resyncCheckPeriod time.Duration</span><br><span class="line">	defaultEventHandlerResyncPeriod time.Duration</span><br><span class="line">	started, stopped <span class="keyword">bool</span></span><br><span class="line">	startedLock      sync.Mutex</span><br><span class="line">	blockDeltas sync.Mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过执行<code>Run</code>方法开启<code>Informer</code>的运行：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sharedIndexInformer)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 创建 DeltaFIFO 先进先出队列，并且允许处理删除操作；其是一个生产者-消费者队列，Reflector 是生产者，调用`Pop`方法的都是消费者</span></span><br><span class="line">	fifo := NewDeltaFIFO(MetaNamespaceKeyFunc, s.indexer)</span><br><span class="line">	cfg := &amp;Config&#123;</span><br><span class="line">		Queue:            fifo,</span><br><span class="line">		ListerWatcher:    s.listerWatcher,</span><br><span class="line">		ObjectType:       s.objectType,</span><br><span class="line">		FullResyncPeriod: s.resyncCheckPeriod,</span><br><span class="line">		RetryOnError:     <span class="literal">false</span>,</span><br><span class="line">		ShouldResync:     s.processor.shouldResync,</span><br><span class="line">		<span class="comment">//处理变更</span></span><br><span class="line">		Process: s.HandleDeltas,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建控制器</span></span><br><span class="line">	s.controller = New(cfg)</span><br><span class="line">	wg.StartWithChannel(processorStopCh, s.cacheMutationDetector.Run)</span><br><span class="line">	<span class="comment">// 运行处理器，接收变更运行处理</span></span><br><span class="line">	wg.StartWithChannel(processorStopCh, s.processor.run)</span><br><span class="line">	<span class="comment">// 运行控制器</span></span><br><span class="line">	s.controller.Run(stopCh)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *sharedProcessor)</span> <span class="title">run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    	<span class="keyword">for</span> _, listener := <span class="keyword">range</span> p.listeners &#123;</span><br><span class="line">    	   <span class="comment">// 接收处理之后的变更通知</span></span><br><span class="line">			p.wg.Start(listener.run)</span><br><span class="line">			<span class="comment">// 接收外部的变更事件，通过ringbuffer（无限大）进行缓存变更事件</span></span><br><span class="line">			p.wg.Start(listener.pop)</span><br><span class="line">		&#125;</span><br><span class="line">		p.listenersStarted = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的内容可以看出，最关键的内容在<code>Controller.Run</code>中：<br>首先创建反射器<code>Reflector</code>并运行。再异步执行<code>c.processLoop</code>。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Reflector:监听资源，并应用到DeltaFIFO</span></span><br><span class="line">	r := NewReflector(</span><br><span class="line">		c.config.ListerWatcher,</span><br><span class="line">		c.config.ObjectType,</span><br><span class="line">		c.config.Queue,</span><br><span class="line">		c.config.FullResyncPeriod,</span><br><span class="line">	)</span><br><span class="line">	r.ShouldResync = c.config.ShouldResync</span><br><span class="line">	c.reflector = r</span><br><span class="line">	wg.StartWithChannel(stopCh, r.Run)</span><br><span class="line">	wait.Until(c.processLoop, time.Second, stopCh)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *controller)</span> <span class="title">processLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">	   <span class="comment">// 当Queue中有数据时，执行c.config.Process方法实际则是`sharedIndexInformer.HandleDeltas`</span></span><br><span class="line">		obj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Reflector</strong>的作用是与<code>k8s</code>交互，并将获取和更新数据传递到<code>Queue</code>中，而<code>Queue</code>获取的事件会回调<code>sharedIndexInformer.HandleDeltas</code>方法。下面是 <strong>Reflector</strong> 的主要执行流程：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reflector)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    r.ListAndWatch(stopCh)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reflector)</span> <span class="title">ListAndWatch</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// 查询资源所有数据</span></span><br><span class="line">	list, err := r.listerWatcher.List(options)</span><br><span class="line">	listMetaInterface, err := meta.ListAccessor(list)</span><br><span class="line">	resourceVersion = listMetaInterface.GetResourceVersion()</span><br><span class="line">	items, err := meta.ExtractList(list)</span><br><span class="line">	<span class="comment">// 同步资源到`Queue`</span></span><br><span class="line">	r.syncWith(items, resourceVersion)</span><br><span class="line">	r.setLastSyncResourceVersion(resourceVersion)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		w, err := r.listerWatcher.Watch(options)</span><br><span class="line">		<span class="comment">// 监听资源更新</span></span><br><span class="line">		r.watchHandler(w, &amp;resourceVersion, resyncerrc, stopCh)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reflector)</span> <span class="title">watchHandler</span><span class="params">(w watch.Interface, resourceVersion *<span class="keyword">string</span>, errc <span class="keyword">chan</span> error, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> event, ok := &lt;-w.ResultChan():</span><br><span class="line">		    <span class="comment">// ...校验</span></span><br><span class="line">			meta, err := meta.Accessor(event.Object)</span><br><span class="line">			newResourceVersion := meta.GetResourceVersion()</span><br><span class="line">			<span class="comment">//将更新对象添加到Queue中</span></span><br><span class="line">			<span class="keyword">switch</span> event.Type &#123;</span><br><span class="line">			<span class="keyword">case</span> watch.Added:</span><br><span class="line">				err := r.store.Add(event.Object)</span><br><span class="line">			<span class="keyword">case</span> watch.Modified:</span><br><span class="line">				err := r.store.Update(event.Object)</span><br><span class="line">			<span class="keyword">case</span> watch.Deleted:</span><br><span class="line">				err := r.store.Delete(event.Object)			&#125;</span><br><span class="line">			*resourceVersion = newResourceVersion</span><br><span class="line">			r.setLastSyncResourceVersion(newResourceVersion)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面将详细研究<code>sharedIndexInformer.HandleDeltas</code>：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sharedIndexInformer)</span> <span class="title">HandleDeltas</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// from oldest to newest</span></span><br><span class="line">	<span class="keyword">for</span> _, d := <span class="keyword">range</span> obj.(Deltas) &#123;</span><br><span class="line">		<span class="keyword">switch</span> d.Type &#123;</span><br><span class="line">		<span class="keyword">case</span> Sync, Added, Updated:</span><br><span class="line">			isSync := d.Type == Sync</span><br><span class="line">			<span class="keyword">if</span> old, exists, err := s.indexer.Get(d.Object); err == <span class="literal">nil</span> &amp;&amp; exists &#123;</span><br><span class="line">			   <span class="comment">//更新索引中数据</span></span><br><span class="line">				s.indexer.Update(d.Object)</span><br><span class="line">				<span class="comment">// 分发更新通知，通知注册到Informer上的EventHandler</span></span><br><span class="line">				s.processor.distribute(updateNotification&#123;oldObj: old, newObj: d.Object&#125;, isSync)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 向索引中添加数据</span></span><br><span class="line">				s.indexer.Add(d.Object)</span><br><span class="line">				<span class="comment">// 分发新增通知</span></span><br><span class="line">				s.processor.distribute(addNotification&#123;newObj: d.Object&#125;, isSync)</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> Deleted:</span><br><span class="line">		   <span class="comment">// 从索引中删除数据</span></span><br><span class="line">			s.indexer.Delete(d.Object)</span><br><span class="line">			<span class="comment">// 分发删除通知		</span></span><br><span class="line">			s.processor.distribute(deleteNotification&#123;oldObj: d.Object&#125;, <span class="literal">false</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>总结起来：</strong>更新流程如下：<br><img src="/media/15810929307162.jpg" alt=""></p>
<h2 id="重同步"><a href="#重同步" class="headerlink" title="重同步"></a>重同步</h2><p><strong>重同步</strong>也是<code>Informer</code>的关键功能之一，<code>k8s</code>中众多实现基于此来做<code>recheck</code>，如单次部署失败，重同步可以修复自动修复部署失败的问题；再比如<code>HPA</code>模块，若单次需要扩容分片数超过自身分片数的2倍时，需要执行多次<code>reconcileAutoscaler</code>方法才能到达目标状态。<br>在创建<code>informer</code>时，会传入参数<code>resyncPeriod</code>，表示重同步的间隔，每过一个这样的接个，<code>informer</code>就会捞出相应的所有数据执行相应逻辑。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">resyncerrc := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</span><br><span class="line">cancelCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(cancelCh)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// 重同步Timer</span></span><br><span class="line">	resyncCh, cleanup := r.resyncChan()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-resyncCh:</span><br><span class="line">		<span class="keyword">if</span> r.ShouldResync() &#123;</span><br><span class="line">			r.store.Resync()</span><br><span class="line">		&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		cleanup()</span><br><span class="line">		resyncCh, cleanup = r.resyncChan()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *DeltaFIFO)</span> <span class="title">Resync</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	keys := f.knownObjects.ListKeys()</span><br><span class="line">	<span class="keyword">for</span> _, k := <span class="keyword">range</span> keys &#123;</span><br><span class="line">		f.syncKeyLocked(k)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *sharedProcessor)</span> <span class="title">shouldResync</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	p.syncingListeners = []*processorListener&#123;&#125;</span><br><span class="line">	resyncNeeded := <span class="literal">false</span></span><br><span class="line">	now := p.clock.Now()</span><br><span class="line">	<span class="keyword">for</span> _, listener := <span class="keyword">range</span> p.listeners &#123;</span><br><span class="line">		<span class="keyword">if</span> listener.shouldResync(now) &#123;</span><br><span class="line">			resyncNeeded = <span class="literal">true</span></span><br><span class="line">			p.syncingListeners = <span class="built_in">append</span>(p.syncingListeners, listener)</span><br><span class="line">			listener.determineNextResync(now)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> resyncNeeded</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到会起一个 <code>Timer</code> 来定时重同步，重同步之前<code>ShouldResync</code>筛选出需要接收本次重同步的<code>Listener</code>放到<code>syncingListeners</code>，同步时只会同步这些<code>syncingListeners</code>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2020/02/04/k8s/3.k8s-apiserver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/04/k8s/3.k8s-apiserver/" itemprop="url">k8s-apiserver</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-04T00:00:00+08:00">2020-02-04</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-kube-apiserver（-v1-17-2）"><a href="#1-kube-apiserver（-v1-17-2）" class="headerlink" title="1. kube-apiserver（@v1.17.2）"></a>1. kube-apiserver（<code>@v1.17.2</code>）</h1><p>[TOC]</p>
<p><code>ApiServer</code>是<code>K8S</code>服务调度的核心，其同时负责与外界的交互、集群内其他组件的交互，也是<code>K8S</code>中唯一与持久化存储<code>Etcd</code>交互的组件。</p>
<p>下面将从以下几点来解析 <code>ApiSever</code>：</p>
<ul>
<li>启动过程<ul>
<li><code>Scheme</code>构建过程  </li>
<li>路由构建过程</li>
<li>认证、授权、准入构建过程</li>
</ul>
</li>
<li>请求过程<ul>
<li>读写请求过程</li>
<li>watch机制</li>
</ul>
</li>
<li>其他组件与其交互过程<ul>
<li>informerFactory机制</li>
</ul>
</li>
</ul>
<h2 id="1-启动过程"><a href="#1-启动过程" class="headerlink" title="1. 启动过程"></a>1. 启动过程</h2><h3 id="1-1-启动主流程"><a href="#1-1-启动主流程" class="headerlink" title="1.1 启动主流程"></a>1.1 启动主流程</h3><p><code>ApiServer</code>启动位置：<code>cmd/kube-apiserver/apiserver.go</code>，启动先需要先启动一个<code>Etcd</code>。调试启动参数如下：</p>
<blockquote>
<p>–secure-port=6445 –storage-backend=etcd3 –etcd-servers=<a href="http://127.0.0.1:2379" target="_blank" rel="noopener">http://127.0.0.1:2379</a> –enable-swagger-ui=true</p>
</blockquote>
<p>首先创建<code>ApiServerCommond</code>，然后执行命令：(整个<code>k8s</code>代码体系都引用<code>CLI</code>框架<code>Cobra</code>)<br>创建命令的过程：</p>
<ol>
<li>创建默认服务启动参数 <code>ServerRunOption</code>；</li>
<li>通过<code>Cobra</code>获取程序启动参数并应用到<code>ServerRunOption</code>。</li>
</ol>
<p>执行的过程，如下：</p>
<ol>
<li>首先设置默认参数：<code>apiserver</code>的<code>AdvertiseAddress</code>（ip），<code>apiserver</code>的<code>SericeIp</code>、集群里所有<code>Service</code>Ip范围、授权配置、服务账户配置、etcd缓存配置、api开关配置；</li>
<li>校验启动参数：如未配置<code>Etcd</code>服务节点信息，则返回异常，终止启动。</li>
<li>基于<code>ServerRunOption</code>运行服务（核心流程）<ol>
<li><strong>创建服务链：</strong>创建<code>APiServer</code>、<code>ApiExtensionServer</code>、<code>AggregatorServer</code>，建立非安全服务端口（默认<code>8080</code>）提供服务；</li>
<li><strong>预运行：</strong>（安装健康检查探针、存活探针、就绪探针。装配 <code>OpenAPI</code>（<code>/openapi/v2</code>路径））；</li>
<li><strong>运行：</strong>运行审计后台（<code>AuditBackend</code>），建立安全服务端口（默认<code>6445</code>）监听提供服务。</li>
</ol>
</li>
</ol>
<p>因此，启动过程最重要的内容在：<code>CreateServerChain</code>创建服务链中。<br>其过程如下：</p>
<ol>
<li><strong>创建节点拨号器组件</strong>（<code>NodeTunneler</code>），设置<code>SSH</code>等信息，对于不同的云服务提供商其区别即在于<code>AddSSHKeyToAllInstances</code>：<code>sshKey</code>分发函数，将<code>SSH</code>key分发到所有节点上；</li>
<li><strong>创建<code>APIServer</code>配置</strong>（<code>CreateKubeAPIServerConfig</code>）:创建为运行APIServer所需要的资源。将<code>ServerRunOption</code>中配置转换成其所需要的资源。<ol>
<li>构建<code>apiserver</code>配置<code>genericapiserver.Config(legacyscheme.Codecs)</code>，<ul>
<li><code>legacyscheme.Codecs</code> 是<code>ApiServer</code>核心设计，其用于编解码<code>API</code>资源，后面讲重点讲解</li>
<li>设置<code>BuildHandlerChainFunc</code>，其是<code>ApiServer</code>的拓展机制。每次请求到达后台处理逻辑之前，会先运行<code>处理链逻辑</code>，目前其默认实现<code>server.DefaultBuildHandlerChain</code>见 ^附件1 。其内部包含<code>认证</code>、<code>授权</code>、<code>审计</code>、<code>准入</code>等处理逻辑。</li>
</ul>
</li>
<li>设置<code>MergedResourceConfig</code>，其用于表示配置哪些<code>groupVersion</code>被开启，哪个资源被启用和禁用；</li>
<li>将服务启动<code>ServerRunOption</code>的部分参数应用到<code>genericapiserver.Config</code>中；</li>
<li>根据<code>ServerRunOption</code>中的<code>InsecureServing</code>、<code>SecureServing</code>、<code>Authentication</code>、<code>Features</code>、<code>APIEnablement</code>应用到<code>genericapiserver.Config</code>中；</li>
<li>创建<code>OpenAPI</code>配置；</li>
<li>创建存储工厂<code>storageFactory</code>，并聚合<code>Etcd</code>的配置创建<code>genericapiserver.Config</code>需要的组件<code>RESTOptionsGetter</code>（其用于构建<code>RESTStorage</code>，用来访问存储层）<ul>
<li><code>storageFactory</code>的创建过程存在很多细节：<ul>
<li><code>StorageConfig</code>：存储配置</li>
<li><code>Overrides</code>：覆盖设置，根据<code>EtcdServersOverrides</code>转换而得，其作用是对于某种特定资源转换到其他<code>etcd</code>服务上；</li>
<li><code>ResourceEncodingConfig</code>：用来判断对于某种资源使用什么版本标识（存储的版本、内存中表示的版本）；</li>
<li><code>DefaultSerializer</code>：序列化工具<code>legacyscheme.Codecs</code>；</li>
<li><code>APIResoureceConfigSource</code>：存储哪些版本哪些资源可用或被禁用。</li>
</ul>
</li>
</ul>
</li>
<li>创建<code>Clientset</code>（包含请求所有资源的<code>Client</code>），其用来请求自己来获取各种类型资源；</li>
<li>创建<code>SharedInformerFactory</code>，其用来为所有已知api组版本的资源提供<code>Informer</code>（<code>k8s</code>体系中与<code>apiserver</code>交互的重要组件）；</li>
<li>构建认证器<code>Authenticator</code><ul>
<li>跟据<code>ServerRunOption</code>创建<code>authenticatorConfig</code></li>
<li>创建<code>ServiceAccountTokenGetter</code>，用于获取<code>ServiceAccount</code>、<code>Secrets</code>，<code>Pod</code>；</li>
<li>创建<code>BootstrapTokenAuthenticator</code>，；</li>
<li>构建多个认证器，并包装成一个联合认证插件，目前<code>k8s</code>支持如下认证插件（<code>authenticator/config.New</code>）：<ul>
<li>basic auth</li>
<li><code>X509证书</code>；</li>
<li><code>ServiceAccount</code></li>
<li>静态 <code>Token</code> 文件</li>
<li>引导 <code>Token</code></li>
<li><code>OpenID</code></li>
<li><code>WebHook</code></li>
</ul>
</li>
</ul>
</li>
<li>创建授权工具<code>Authorizer</code>，目前<code>k8s</code>支持6种授权模式：<ul>
<li><code>ModeNode</code>：显示<code>kubelet</code>只能访问其自身所在的<code>Node</code></li>
<li><code>ModeRBAC</code>：基于角色的访问控制</li>
<li><code>ModeABAC</code>：基于属性（<code>Attribute</code>）的访问控制</li>
<li><code>ModeWebhook</code>：通过webhook的访问控制</li>
<li><code>ModeAlwaysDeny</code>：拒绝所有</li>
<li><code>ModeAlwaysAllow</code>：允许所有</li>
</ul>
</li>
<li>创建服务调节器<code>ServiceResolver</code> 给定命名空间、名称、端口返回<code>Service</code>的URL；</li>
<li>创建审计策略检测器<code>AuditPolicyChecker</code>，审计后台<code>AuditBackend</code>；</li>
<li>创建准入控制<code>AdmissionControl</code><ul>
<li><code>k8s</code>目前支持<strong>13</strong>种准入插件：<code>NamespaceLifecycle,LimitRanger,ServiceAccount,TaintNodesByCondition,Priority,DefaultTolerationSeconds,DefaultStorageClass,StorageObjectInUseProtection,PersistentVolumeClaimResize,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,RuntimeClass,ResourceQuota</code>；</li>
<li>插件初始化时会用<code>PluginInitializers</code>来对所有的插件进行填充，这也是<code>k8s</code>设计比较巧妙的点；<ul>
<li>插件需要什么属性，实现相应接口即可。</li>
</ul>
</li>
</ul>
</li>
<li>解析<code>ServiceIpRange</code>和<code>apiServerServiceIp</code>；</li>
<li>创建<code>master.Config</code>，并进行赋值返回。</li>
</ol>
</li>
<li>构建配置<code>APIExtensionsConfig</code>，为创建<code>ApiExtensionServer</code>做准备，<code>ApiExtensionServer</code>和<code>KubeAPIServer</code>的区别在于，<code>ApiExtensionServer</code>为<code>k8s</code>的拓展服务，其负责API：<code>CustomResourceDefinitions</code>（简称<code>CRD</code>）的管理；</li>
<li>创建<code>apiExtensionsServer</code>，首先填充参数再创建：<ol>
<li>创建<code>GenericAPIServer</code><ol>
<li>创建<code>APIServerHandler</code>（<code>apiserver/pkg/server/handler.go</code>），其是众多<code>Hanlder</code>的包装器和分发器<ol>
<li>其包含属性：<code>FullHandlerChain</code>(过滤链)、<code>GoRestfulContainer</code>、<code>NOGoRestfulMux</code>、<code>Director</code>；</li>
<li>其处理请求的顺序：<code>FullHandlerChain -&gt; Director -&gt; {GoRestfulContainer,NonGoRestfulMux}</code></li>
</ol>
</li>
<li>创建<code>GenericAPIServer</code>，填充参数</li>
</ol>
</li>
<li>创建<code>ApiGroupInfo</code>，标识<code>API</code>组，包含组内元素的所有数据，其包含主要信息如下：<ul>
<li><code>PrioritizedVersions</code>：标识该<code>API</code>组有哪些版本；</li>
<li><code>VersionedResourcesStorageMap</code>：存储<code>API</code>组中每个版本的每种资源的存储API；</li>
<li><code>Scheme</code>：包含该组内所有类型，并且可以做不同类型之间的相互转换，同时可以转换来自组外的对象；</li>
<li><code>NegotiatedSerializer</code>：<code>API</code>组内数据编解码；</li>
<li><code>ParameterCodec</code>：查询参数转换</li>
</ul>
</li>
<li>填充<code>apiGroupInfo</code><ul>
<li>填充<code>VersionedResourcesStorageMap</code></li>
</ul>
</li>
<li>安装<code>APIGroupInfo</code><ul>
<li>安装<code>APIResources</code><ul>
<li>对于每个版本，首先创建<code>APIGroupVersion</code>（用于将存储对象暴露为<code>http.Handlers</code>的<code>helper</code>）(每个<code>APIGroupVersion</code>是一个<code>WebService</code>)</li>
<li>调用<code>apiGroupVersion.InstallREST(s.Handler.GoRestfulContainer)</code>方法安装<code>Restful</code> API；</li>
<li>创建<code>APIInstaller</code>执行<code>Install</code>方法进行安装<code>APIResource</code>；<ul>
<li>对于<code>APIGroupVersion</code>中每种资源执行<code>registerResourceHandlers</code>方法进行 <strong>最核心的转换</strong>（<code>rest.Storage-&gt; http.Handler</code>），详细见<code>1.3</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>创建<code>KubeApiServer</code>，其创建过程与创建<code>apiextensionServer</code>类似<ol>
<li>创建<code>GenericAPIServer</code>，但与上面不一样的地方是：其将<code>apiextensionServer</code>带入其中当<code>nofoundHandler</code>，当<code>kubeApiServer</code>不能处理请求时，会将请求转发到<code>apiextensionServer</code>；</li>
<li>安装<code>api/</code>路径的核心资源（<code>LeagyAPI</code>）（<code>endpoint</code>、<code>node</code>、<code>pod</code>）。其内部安装逻辑与上面过程类似，则将不累述；</li>
<li>安装<code>apis/</code>路径其他拓展资源；</li>
</ol>
</li>
<li>创建<code>APIAggregator</code>，聚合服务，其是<code>apiserver</code>重要拓展机制，用户可以自定义API服务，然后以<code>APIService</code>形式告知<code>apiserver</code><ol>
<li>同样先创建<code>GenericAPIServer</code>，传入<code>KubeApiServer</code>作为<code>nofoundHandler</code>；</li>
<li>安装<code>apiregistration</code>API组；</li>
<li>初始化<code>apiserviceRegistrationController</code>，其用于管理<code>APIService</code>。当有<code>APIService</code>更新时，其会将其转换成<code>proxyHandler</code>然后注册到<code>APIAggregator</code>的<code>NonGoRestfulMux</code>中，用于将请求转发到<code>APIService</code>中定义的自定义<strong>API服务</strong>；</li>
</ol>
</li>
<li>构建<code>InsecureHandlerChain</code>，并监听<code>insecureServer</code>端口，接收请求</li>
</ol>
</li>
</ol>
<p>总结其运行图如下：</p>
<p><img src="/media/15815943647079.jpg" alt=""></p>
<p><img src="/media/15810695608846.jpg" alt=""></p>
<blockquote>
<p>k8s现阶段，API一共分为13个Group：Core、apps、authentication、authorization、autoscaling、batch、certificates、componentconfig、extensions、imagepolicy、policy、rbac、storage。</p>
</blockquote>
<h3 id="1-2-Scheme"><a href="#1-2-Scheme" class="headerlink" title="1.2 Scheme"></a>1.2 Scheme</h3><p><code>Scheme</code>是<code>k8s</code>中最重要的组件。其存储API资源信息（类型信息、版本信息等），支持API资源的序列化、反序列化、版本转化。<br>首先，我们将来分析其结构：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Scheme <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// GroupVersionKind到具体反射类型的映射</span></span><br><span class="line">	gvkToType <span class="keyword">map</span>[schema.GroupVersionKind]reflect.Type</span><br><span class="line">	<span class="comment">// 反射类型到GroupVersionKind列表的映射</span></span><br><span class="line">	typeToGVK <span class="keyword">map</span>[reflect.Type][]schema.GroupVersionKind</span><br><span class="line">	<span class="comment">// 不带版本的类型</span></span><br><span class="line">	unversionedTypes <span class="keyword">map</span>[reflect.Type]schema.GroupVersionKind</span><br><span class="line">  <span class="comment">// 可以在任意组合版本中创建的类型</span></span><br><span class="line">	unversionedKinds <span class="keyword">map</span>[<span class="keyword">string</span>]reflect.Type</span><br><span class="line">	<span class="comment">// 类型，属性标签转换函数</span></span><br><span class="line">	fieldLabelConversionFuncs <span class="keyword">map</span>[schema.GroupVersionKind]FieldLabelConversionFunc</span><br><span class="line">   <span class="comment">// 默认初始化函数</span></span><br><span class="line">	defaulterFuncs <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line">   <span class="comment">// 转换函数</span></span><br><span class="line">	converter *conversion.Converter</span><br><span class="line">   <span class="comment">// 版本优先级</span></span><br><span class="line">	versionPriority <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span></span><br><span class="line">   <span class="comment">//记录类型注入时版本的顺序</span></span><br><span class="line">	observedVersions []schema.GroupVersion</span><br><span class="line">	schemeName <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Scheme</code>内容的注册时机发生在创建<code>ApiServerCommand</code>的时候，其引入<code>k8s.io/kubernetes/pkg/master</code>包，而这个包中包含<code>import_known_versions.go</code>类，其引入众多<code>install</code>包：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="comment">// These imports are the API groups the API server will support.</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/admission/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/admissionregistration/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/apps/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/auditregistration/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/authentication/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/authorization/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/autoscaling/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/batch/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/certificates/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/coordination/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/core/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/discovery/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/events/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/extensions/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/flowcontrol/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/imagepolicy/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/networking/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/node/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/policy/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/rbac/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/scheduling/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/settings/install"</span></span><br><span class="line">	_ <span class="string">"k8s.io/kubernetes/pkg/apis/storage/install"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>而，<code>Scheme</code>内容的注入则是在这些<code>install</code>中进行。下面以<code>k8s.io/kubernetes/pkg/apis/core/install</code>为例来介绍其注册过程：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	Install(legacyscheme.Scheme)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Install</span><span class="params">(scheme *runtime.Scheme)</span></span> &#123;</span><br><span class="line">	utilruntime.Must(core.AddToScheme(scheme))</span><br><span class="line">	utilruntime.Must(v1.AddToScheme(scheme))</span><br><span class="line">	utilruntime.Must(scheme.SetVersionPriority(v1.SchemeGroupVersion))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，会将<code>core</code>包下的<code>API</code>资源注册到<code>Scheme</code>，再将<code>v1</code>包下的<code>API</code>资源注册到<code>Scheme</code>中，设置版本的优先级。<br><code>core</code>包下的注册内容如下：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addKnownTypes</span><span class="params">(scheme *runtime.Scheme)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   <span class="comment">// 添加converter的忽略转换类型</span></span><br><span class="line">	<span class="keyword">if</span> err := scheme.AddIgnoredConversionType(&amp;metav1.TypeMeta&#123;&#125;, &amp;metav1.TypeMeta&#123;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	scheme.AddKnownTypes(SchemeGroupVersion,</span><br><span class="line">		&amp;Pod&#123;&#125;,</span><br><span class="line">		&amp;PodList&#123;&#125;,</span><br><span class="line">		&amp;PodStatusResult&#123;&#125;,</span><br><span class="line">		&amp;PodTemplate&#123;&#125;,</span><br><span class="line">		&amp;PodTemplateList&#123;&#125;,</span><br><span class="line">		&amp;ReplicationControllerList&#123;&#125;,</span><br><span class="line">		&amp;ReplicationController&#123;&#125;,</span><br><span class="line">		&amp;ServiceList&#123;&#125;,</span><br><span class="line">		&amp;Service&#123;&#125;,</span><br><span class="line">		&amp;ServiceProxyOptions&#123;&#125;,</span><br><span class="line">		&amp;NodeList&#123;&#125;,</span><br><span class="line">		&amp;Node&#123;&#125;,</span><br><span class="line">		&amp;NodeProxyOptions&#123;&#125;,</span><br><span class="line">		&amp;Endpoints&#123;&#125;,</span><br><span class="line">		&amp;EndpointsList&#123;&#125;,</span><br><span class="line">		&amp;Binding&#123;&#125;,</span><br><span class="line">		&amp;Event&#123;&#125;,</span><br><span class="line">		&amp;EventList&#123;&#125;,</span><br><span class="line">		&amp;List&#123;&#125;</span><br><span class="line">      ...</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将<code>core</code>包中关键<code>API</code>资源加入到<code>Scheme</code>中：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddKnownTypes</span><span class="params">(gv schema.GroupVersion, types ...Object)</span></span> &#123;</span><br><span class="line">	s.addObservedVersion(gv)</span><br><span class="line">	<span class="keyword">for</span> _, obj := <span class="keyword">range</span> types &#123;</span><br><span class="line">    	t := reflect.TypeOf(obj)</span><br><span class="line">		t = t.Elem()</span><br><span class="line">		s.AddKnownTypeWithName(gv.WithKind(t.Name()), obj)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddKnownTypeWithName</span><span class="params">(gvk schema.GroupVersionKind, obj Object)</span></span> &#123;</span><br><span class="line">	s.addObservedVersion(gvk.GroupVersion())</span><br><span class="line">	t := reflect.TypeOf(obj)</span><br><span class="line">	t = t.Elem()</span><br><span class="line">	<span class="comment">// 设置`GroupVersionKind`到类型反射的映射</span></span><br><span class="line">	s.gvkToType[gvk] = t</span><br><span class="line">	<span class="keyword">for</span> _, existingGvk := <span class="keyword">range</span> s.typeToGVK[t] &#123;</span><br><span class="line">		<span class="keyword">if</span> existingGvk == gvk &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 建立类型反射到`GroupVersionKind`列表的映射</span></span><br><span class="line">	s.typeToGVK[t] = <span class="built_in">append</span>(s.typeToGVK[t], gvk)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看<code>v1.AddToScheme</code>，向<code>Scheme</code>中添加类型初始化函数<code>v1.addDefaultingFuncs</code>，向<code>Scheme</code>中添加转换函数<code>v1.addConversionFuncs</code></p>
<h3 id="1-3-rest-Storage-gt-http-Handler"><a href="#1-3-rest-Storage-gt-http-Handler" class="headerlink" title="1.3 rest.Storage -&gt; http.Handler"></a>1.3 rest.Storage -&gt; http.Handler</h3><p><code>rest.Storage</code>到<code>http.Handler</code>的转换是<code>apiServer</code>中的重要部分。也是其抽象的精髓。位于<code>apiserver/pkg/endpoints/installer.go/registerResourceHandlers</code>。下面将详细阐述其实现过程：</p>
<ol>
<li>通过<code>Scheme</code>、<code>GroupVersion</code>、<code>Storage</code> 获取类型信息，<code>GroupVersionKind</code>；</li>
<li>通过<code>Scheme</code>和<code>GroupVersionKind</code>创建类型实例；</li>
<li>判断 <code>rest.Storage</code>实现了哪些接口：是否有创建接口（<code>isCreater</code>）、是否可列举（<code>isLister</code>）、是否可查询（<code>isGetter</code>）。判断的意义在于：确定该类型可以生成的<strong>Http行为</strong>；</li>
<li>区分是否对命名空间敏感，形成不同的资源路径；其次，跟据前面的判断结果集生成可以生成httpHandler的<code>actions</code>。如 <code>LIST</code>、<code>POST</code>、<code>GET</code>、<code>WATCH</code>…；</li>
<li>针对每种<code>action</code>，为其创建一个<code>route</code>（go-restful），同时为其构建一个处理函数<code>RouteFunction</code>；</li>
<li>需要特别说明的一点是：对于修改操作，同时会将<code>Admit</code>传入<code>RouteFunction</code>中，为了在操作前进行准入的控制；</li>
<li>最后，将每种<code>route</code>加入到<code>WebService</code>中。</li>
</ol>
<h2 id="单次请求过程"><a href="#单次请求过程" class="headerlink" title="单次请求过程"></a>单次请求过程</h2><p>下面本节将以创建一个<code>deployment</code>为例来讲解请求执行过程：<br>首先通过<code>kubectl</code>向<code>k8s-apiserver</code>发起创建<code>deployment</code>命令，<code>kubectl create -f nginx-deployment.yaml</code>。<br>其执行流程如下图：<br><img src="/media/15810696269545.jpg" alt=""></p>
<p>总结起来，其过程如下：</p>
<ol>
<li>首先经过过滤链进行处理，包括认证、准入等通用的功能链；</li>
<li>开始依次经过aggregator、apiserver的<code>go-restful</code>的<code>Container</code>，查看是否匹配注册的规则；</li>
<li>本次请求你<code>deploymenet</code>是<code>apps</code>API组中的资源，因此分发到对应的<code>apps/v1</code>WebService下<code>POST</code>route进行处理；</li>
<li>route对应function是一个包装的handler<code>handlers.createHandlers</code>，其是整个请求核心逻辑模块，首先利用解码请求体（利用<code>Scheme</code>保障的<code>ParamterCocdec</code>），再通过准入控制插件（<strong>13种</strong>）的检测以及修改，调用<code>rest.Storage</code>进行操作etcd写入数据。</li>
</ol>
<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><h3 id="1-处理链"><a href="#1-处理链" class="headerlink" title="1. 处理链"></a>1. 处理链</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">handler := genericapifilters.WithAuthorization(apiHandler, c.Authorization.Authorizer, c.Serializer)</span><br><span class="line">handler = genericfilters.WithMaxInFlightLimit(handler, c.MaxRequestsInFlight, c.MaxMutatingRequestsInFlight, c.LongRunningFunc)</span><br><span class="line">handler = genericapifilters.WithImpersonation(handler, c.Authorization.Authorizer, c.Serializer)</span><br><span class="line">handler = genericapifilters.WithAudit(handler, c.AuditBackend, c.AuditPolicyChecker, c.LongRunningFunc)</span><br><span class="line">failedHandler := genericapifilters.Unauthorized(c.Serializer, c.Authentication.SupportsBasicAuth)</span><br><span class="line">failedHandler = genericapifilters.WithFailedAuthenticationAudit(failedHandler, c.AuditBackend, c.AuditPolicyChecker)</span><br><span class="line">handler = genericapifilters.WithAuthentication(handler, c.Authentication.Authenticator, failedHandler, c.Authentication.APIAudiences)</span><br><span class="line">handler = genericfilters.WithCORS(handler, c.CorsAllowedOriginList, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="string">"true"</span>)</span><br><span class="line">handler = genericfilters.WithTimeoutForNonLongRunningRequests(handler, c.LongRunningFunc, c.RequestTimeout)</span><br><span class="line">handler = genericfilters.WithWaitGroup(handler, c.LongRunningFunc, c.HandlerChainWaitGroup)</span><br><span class="line">handler = genericapifilters.WithRequestInfo(handler, c.RequestInfoResolver)</span><br><span class="line">handler = genericfilters.WithPanicRecovery(handler)</span><br><span class="line"><span class="keyword">return</span> handler</span><br></pre></td></tr></table></figure>


<p>拓展阅读：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/K2LrmpYdmQRrb5NLT6A6eA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/K2LrmpYdmQRrb5NLT6A6eA</a>    </li>
<li><a href="https://feisky.gitbooks.io/kubernetes/components/apiserver.html" target="_blank" rel="noopener">https://feisky.gitbooks.io/kubernetes/components/apiserver.html</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2020/02/04/k8s/2.k8s%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/04/k8s/2.k8s%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95/" itemprop="url">k8s本地调试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-04T00:00:00+08:00">2020-02-04</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0-本地调试"><a href="#0-本地调试" class="headerlink" title="0. 本地调试"></a>0. 本地调试</h1><p><code>k8s</code>各组件之间的交互需要用到加密通信，如果简单配置各组件的启动参数，相互之间无法正常通信。本节将介绍如何在配置进而可以在本地进行<code>debug</code>k8s集群。</p>
<h2 id="0-1-本地运行调试"><a href="#0-1-本地运行调试" class="headerlink" title="0.1 本地运行调试"></a>0.1 本地运行调试</h2><p><code>k8s</code>有个文件<code>hack/local-up-cluster.sh</code>用于起一个本地<code>k8s</code>集群，而该脚本生成的证书等同样可以用于<code>idea</code>debug时使用。这里进行了以下修改：将执行组件的命令，<strong>转换成输出命令参数</strong><code>echo</code>命令见附件^1。</p>
<h2 id="0-2-远程debug"><a href="#0-2-远程debug" class="headerlink" title="0.2 远程debug"></a>0.2 远程debug</h2><p>还有一种方式则是在另一台机器上运行一个<code>k8s</code>集群，通过<code>dlv</code>来远程<code>debug</code>，可以参考此篇： <a href="https://cloud.tencent.com/developer/article/1402449" target="_blank" rel="noopener">搭建k8s的开发调试环境</a></p>
<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><h3 id="1-本地生成密钥以及组件命令参数"><a href="#1-本地生成密钥以及组件命令参数" class="headerlink" title="[^1]: 本地生成密钥以及组件命令参数"></a>[^1]: 本地生成密钥以及组件命令参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copyright 2014 The Kubernetes Authors.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Licensed under the Apache License, Version 2.0 (the <span class="string">"License"</span>);</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you may not use this file except <span class="keyword">in</span> compliance with the License.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Unless required by applicable law or agreed to <span class="keyword">in</span> writing, software</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">"AS IS"</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"></span><br><span class="line">KUBE_ROOT=$(dirname "$&#123;BASH_SOURCE[0]&#125;")/..</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This <span class="built_in">command</span> builds and runs a <span class="built_in">local</span> kubernetes cluster.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You may need to run this as root to allow kubelet to open docker<span class="string">'s socket,</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and to write the <span class="built_in">test</span> CA <span class="keyword">in</span> /var/run/kubernetes.</span></span><br><span class="line">DOCKER_OPTS=$&#123;DOCKER_OPTS:-""&#125;</span><br><span class="line">export DOCKER=(docker "$&#123;DOCKER_OPTS[@]&#125;")</span><br><span class="line">DOCKER_ROOT=$&#123;DOCKER_ROOT:-""&#125;</span><br><span class="line">ALLOW_PRIVILEGED=$&#123;ALLOW_PRIVILEGED:-""&#125;</span><br><span class="line">DENY_SECURITY_CONTEXT_ADMISSION=$&#123;DENY_SECURITY_CONTEXT_ADMISSION:-""&#125;</span><br><span class="line">PSP_ADMISSION=$&#123;PSP_ADMISSION:-""&#125;</span><br><span class="line">NODE_ADMISSION=$&#123;NODE_ADMISSION:-""&#125;</span><br><span class="line">RUNTIME_CONFIG=$&#123;RUNTIME_CONFIG:-""&#125;</span><br><span class="line">KUBELET_AUTHORIZATION_WEBHOOK=$&#123;KUBELET_AUTHORIZATION_WEBHOOK:-""&#125;</span><br><span class="line">KUBELET_AUTHENTICATION_WEBHOOK=$&#123;KUBELET_AUTHENTICATION_WEBHOOK:-""&#125;</span><br><span class="line">POD_MANIFEST_PATH=$&#123;POD_MANIFEST_PATH:-"/var/run/kubernetes/static-pods"&#125;</span><br><span class="line">KUBELET_FLAGS=$&#123;KUBELET_FLAGS:-""&#125;</span><br><span class="line">KUBELET_IMAGE=$&#123;KUBELET_IMAGE:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> many dev environments run with swap on, so we don<span class="string">'t fail in this env</span></span></span><br><span class="line">FAIL_SWAP_ON=$&#123;FAIL_SWAP_ON:-"false"&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Name of the network plugin, eg: <span class="string">"kubenet"</span></span></span><br><span class="line">NET_PLUGIN=$&#123;NET_PLUGIN:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Place the config files and binaries required by NET_PLUGIN <span class="keyword">in</span> these directory,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> eg: <span class="string">"/etc/cni/net.d"</span> <span class="keyword">for</span> config files, and <span class="string">"/opt/cni/bin"</span> <span class="keyword">for</span> binaries.</span></span><br><span class="line">CNI_CONF_DIR=$&#123;CNI_CONF_DIR:-""&#125;</span><br><span class="line">CNI_BIN_DIR=$&#123;CNI_BIN_DIR:-""&#125;</span><br><span class="line">SERVICE_CLUSTER_IP_RANGE=$&#123;SERVICE_CLUSTER_IP_RANGE:-10.0.0.0/24&#125;</span><br><span class="line">FIRST_SERVICE_CLUSTER_IP=$&#123;FIRST_SERVICE_CLUSTER_IP:-10.0.0.1&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> enabled, must <span class="built_in">set</span> CGROUP_ROOT</span></span><br><span class="line">CGROUPS_PER_QOS=$&#123;CGROUPS_PER_QOS:-true&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> name of the cgroup driver, i.e. cgroupfs or systemd</span></span><br><span class="line">CGROUP_DRIVER=$&#123;CGROUP_DRIVER:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> cgroups per qos is enabled, optionally change cgroup root</span></span><br><span class="line">CGROUP_ROOT=$&#123;CGROUP_ROOT:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> owner of client certs, default to current user <span class="keyword">if</span> not specified</span></span><br><span class="line">USER=$&#123;USER:-$(whoami)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> enables testing eviction scenarios locally.</span></span><br><span class="line">EVICTION_HARD=$&#123;EVICTION_HARD:-"memory.available&lt;100Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5%"&#125;</span><br><span class="line">EVICTION_SOFT=$&#123;EVICTION_SOFT:-""&#125;</span><br><span class="line">EVICTION_PRESSURE_TRANSITION_PERIOD=$&#123;EVICTION_PRESSURE_TRANSITION_PERIOD:-"1m"&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This script uses docker0 (or whatever container bridge docker is currently using)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and we don<span class="string">'t know the IP of the DNS pod to pass in as --cluster-dns.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> To <span class="built_in">set</span> this up by hand, <span class="built_in">set</span> this flag and change DNS_SERVER_IP.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note also that you need API_HOST (defined above) <span class="keyword">for</span> correct DNS.</span></span><br><span class="line">KUBE_PROXY_MODE=$&#123;KUBE_PROXY_MODE:-""&#125;</span><br><span class="line">ENABLE_CLUSTER_DNS=$&#123;KUBE_ENABLE_CLUSTER_DNS:-true&#125;</span><br><span class="line">ENABLE_NODELOCAL_DNS=$&#123;KUBE_ENABLE_NODELOCAL_DNS:-false&#125;</span><br><span class="line">DNS_SERVER_IP=$&#123;KUBE_DNS_SERVER_IP:-10.0.0.10&#125;</span><br><span class="line">LOCAL_DNS_IP=$&#123;KUBE_LOCAL_DNS_IP:-169.254.20.10&#125;</span><br><span class="line">DNS_MEMORY_LIMIT=$&#123;KUBE_DNS_MEMORY_LIMIT:-170Mi&#125;</span><br><span class="line">DNS_DOMAIN=$&#123;KUBE_DNS_NAME:-"cluster.local"&#125;</span><br><span class="line">KUBECTL=$&#123;KUBECTL:-"$&#123;KUBE_ROOT&#125;/cluster/kubectl.sh"&#125;</span><br><span class="line">WAIT_FOR_URL_API_SERVER=$&#123;WAIT_FOR_URL_API_SERVER:-60&#125;</span><br><span class="line">MAX_TIME_FOR_URL_API_SERVER=$&#123;MAX_TIME_FOR_URL_API_SERVER:-1&#125;</span><br><span class="line">ENABLE_DAEMON=$&#123;ENABLE_DAEMON:-false&#125;</span><br><span class="line">HOSTNAME_OVERRIDE=$&#123;HOSTNAME_OVERRIDE:-"127.0.0.1"&#125;</span><br><span class="line">EXTERNAL_CLOUD_PROVIDER=$&#123;EXTERNAL_CLOUD_PROVIDER:-false&#125;</span><br><span class="line">EXTERNAL_CLOUD_PROVIDER_BINARY=$&#123;EXTERNAL_CLOUD_PROVIDER_BINARY:-""&#125;</span><br><span class="line">CLOUD_PROVIDER=$&#123;CLOUD_PROVIDER:-""&#125;</span><br><span class="line">CLOUD_CONFIG=$&#123;CLOUD_CONFIG:-""&#125;</span><br><span class="line">FEATURE_GATES=$&#123;FEATURE_GATES:-"AllAlpha=false"&#125;</span><br><span class="line">STORAGE_BACKEND=$&#123;STORAGE_BACKEND:-"etcd3"&#125;</span><br><span class="line">STORAGE_MEDIA_TYPE=$&#123;STORAGE_MEDIA_TYPE:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> preserve etcd data. you also need to <span class="built_in">set</span> ETCD_DIR.</span></span><br><span class="line">PRESERVE_ETCD="$&#123;PRESERVE_ETCD:-false&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> kubernetes dashboard</span></span><br><span class="line">ENABLE_CLUSTER_DASHBOARD=$&#123;KUBE_ENABLE_CLUSTER_DASHBOARD:-false&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> RBAC Mode options</span></span><br><span class="line">AUTHORIZATION_MODE=$&#123;AUTHORIZATION_MODE:-"Node,RBAC"&#125;</span><br><span class="line">KUBECONFIG_TOKEN=$&#123;KUBECONFIG_TOKEN:-""&#125;</span><br><span class="line">AUTH_ARGS=$&#123;AUTH_ARGS:-""&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> WebHook Authentication and Authorization</span></span><br><span class="line">AUTHORIZATION_WEBHOOK_CONFIG_FILE=$&#123;AUTHORIZATION_WEBHOOK_CONFIG_FILE:-""&#125;</span><br><span class="line">AUTHENTICATION_WEBHOOK_CONFIG_FILE=$&#123;AUTHENTICATION_WEBHOOK_CONFIG_FILE:-""&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Install a default storage class (enabled by default)</span></span><br><span class="line">DEFAULT_STORAGE_CLASS=$&#123;KUBE_DEFAULT_STORAGE_CLASS:-true&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Do not run the mutation detector by default on a <span class="built_in">local</span> cluster.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is intended <span class="keyword">for</span> a specific <span class="built_in">type</span> of testing and inherently leaks memory.</span></span><br><span class="line">KUBE_CACHE_MUTATION_DETECTOR="$&#123;KUBE_CACHE_MUTATION_DETECTOR:-false&#125;"</span><br><span class="line">export KUBE_CACHE_MUTATION_DETECTOR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> panic the server on watch decode errors since they are considered coder mistakes</span></span><br><span class="line">KUBE_PANIC_WATCH_DECODE_ERROR="$&#123;KUBE_PANIC_WATCH_DECODE_ERROR:-true&#125;"</span><br><span class="line">export KUBE_PANIC_WATCH_DECODE_ERROR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Default list of admission Controllers to invoke prior to persisting objects <span class="keyword">in</span> cluster</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The order defined here does not matter.</span></span><br><span class="line">ENABLE_ADMISSION_PLUGINS=$&#123;ENABLE_ADMISSION_PLUGINS:-"NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,Priority,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota"&#125;</span><br><span class="line">DISABLE_ADMISSION_PLUGINS=$&#123;DISABLE_ADMISSION_PLUGINS:-""&#125;</span><br><span class="line">ADMISSION_CONTROL_CONFIG_FILE=$&#123;ADMISSION_CONTROL_CONFIG_FILE:-""&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> START_MODE can be <span class="string">'all'</span>, <span class="string">'kubeletonly'</span>, <span class="string">'nokubelet'</span>, or <span class="string">'nokubeproxy'</span></span></span><br><span class="line">START_MODE=$&#123;START_MODE:-"all"&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A list of controllers to <span class="built_in">enable</span></span></span><br><span class="line">KUBE_CONTROLLERS="$&#123;KUBE_CONTROLLERS:-"*"&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Audit policy</span></span><br><span class="line">AUDIT_POLICY_FILE=$&#123;AUDIT_POLICY_FILE:-""&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> sanity check <span class="keyword">for</span> OpenStack provider</span></span><br><span class="line">if [ "$&#123;CLOUD_PROVIDER&#125;" == "openstack" ]; then</span><br><span class="line">    if [ "$&#123;CLOUD_CONFIG&#125;" == "" ]; then</span><br><span class="line">        echo "Missing CLOUD_CONFIG env for OpenStack provider!"</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ ! -f "$&#123;CLOUD_CONFIG&#125;" ]; then</span><br><span class="line">        echo "Cloud config $&#123;CLOUD_CONFIG&#125; doesn't exist"</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> warn <span class="keyword">if</span> users are running with swap allowed</span></span><br><span class="line">if [ "$&#123;FAIL_SWAP_ON&#125;" == "false" ]; then</span><br><span class="line">    echo "WARNING : The kubelet is configured to not fail even if swap is enabled; production deployments should disable swap."</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$(id -u)" != "0" ]; then</span><br><span class="line">    echo "WARNING : This script MAY be run as root for docker socket / iptables functionality; if failures occur, retry as root." 2&gt;&amp;1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Stop right away <span class="keyword">if</span> the build fails</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">source "$&#123;KUBE_ROOT&#125;/hack/lib/init.sh"</span><br><span class="line">kube::util::ensure-gnu-sed</span><br><span class="line"></span><br><span class="line">function usage &#123;</span><br><span class="line">            echo "This script starts a local kube cluster. "</span><br><span class="line">            echo "Example 0: hack/local-up-cluster.sh -h  (this 'help' usage description)"</span><br><span class="line">            echo "Example 1: hack/local-up-cluster.sh -o _output/dockerized/bin/linux/amd64/ (run from docker output)"</span><br><span class="line">            echo "Example 2: hack/local-up-cluster.sh -O (auto-guess the bin path for your platform)"</span><br><span class="line">            echo "Example 3: hack/local-up-cluster.sh (build a local copy of the source)"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This <span class="keyword">function</span> guesses <span class="built_in">where</span> the existing cached binary build is <span class="keyword">for</span> the `-O`</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> flag</span></span><br><span class="line">function guess_built_binary_path &#123;</span><br><span class="line">  local apiserver_path</span><br><span class="line">  apiserver_path=$(kube::util::find-binary "kube-apiserver")</span><br><span class="line">  if [[ -z "$&#123;apiserver_path&#125;" ]]; then</span><br><span class="line">    return</span><br><span class="line">  fi</span><br><span class="line">  echo -n "$(dirname "$&#123;apiserver_path&#125;")"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## Allow user to supply the source directory.</span></span></span><br><span class="line">GO_OUT=$&#123;GO_OUT:-&#125;</span><br><span class="line">while getopts "ho:O" OPTION</span><br><span class="line">do</span><br><span class="line">    case $&#123;OPTION&#125; in</span><br><span class="line">        o)</span><br><span class="line">            echo "skipping build"</span><br><span class="line">            GO_OUT="$&#123;OPTARG&#125;"</span><br><span class="line">            echo "using source $&#123;GO_OUT&#125;"</span><br><span class="line">            ;;</span><br><span class="line">        O)</span><br><span class="line">            GO_OUT=$(guess_built_binary_path)</span><br><span class="line">            if [ "$&#123;GO_OUT&#125;" == "" ]; then</span><br><span class="line">                echo "Could not guess the correct output directory to use."</span><br><span class="line">                exit 1</span><br><span class="line">            fi</span><br><span class="line">            ;;</span><br><span class="line">        h)</span><br><span class="line">            usage</span><br><span class="line">            exit</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            usage</span><br><span class="line">            exit</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ "x$&#123;GO_OUT&#125;" == "x" ]; then</span><br><span class="line">    make -C "$&#123;KUBE_ROOT&#125;" WHAT="cmd/kubectl cmd/kube-apiserver cmd/kube-controller-manager cmd/cloud-controller-manager cmd/kubelet cmd/kube-proxy cmd/kube-scheduler"</span><br><span class="line">else</span><br><span class="line">    echo "skipped the build."</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Shut down anyway <span class="keyword">if</span> there<span class="string">'s an error.</span></span></span><br><span class="line">set +e</span><br><span class="line"></span><br><span class="line">API_PORT=$&#123;API_PORT:-8080&#125;</span><br><span class="line">API_SECURE_PORT=$&#123;API_SECURE_PORT:-6443&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> WARNING: For DNS to work on most setups you should <span class="built_in">export</span> API_HOST as the docker0 ip address,</span></span><br><span class="line">API_HOST=$&#123;API_HOST:-localhost&#125;</span><br><span class="line">API_HOST_IP=$&#123;API_HOST_IP:-"127.0.0.1"&#125;</span><br><span class="line">ADVERTISE_ADDRESS=$&#123;ADVERTISE_ADDRESS:-""&#125;</span><br><span class="line">NODE_PORT_RANGE=$&#123;NODE_PORT_RANGE:-""&#125;</span><br><span class="line">API_BIND_ADDR=$&#123;API_BIND_ADDR:-"0.0.0.0"&#125;</span><br><span class="line">EXTERNAL_HOSTNAME=$&#123;EXTERNAL_HOSTNAME:-localhost&#125;</span><br><span class="line"></span><br><span class="line">KUBELET_HOST=$&#123;KUBELET_HOST:-"127.0.0.1"&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> By default only allow CORS <span class="keyword">for</span> requests on localhost</span></span><br><span class="line">API_CORS_ALLOWED_ORIGINS=$&#123;API_CORS_ALLOWED_ORIGINS:-/127.0.0.1(:[0-9]+)?$,/localhost(:[0-9]+)?$&#125;</span><br><span class="line">KUBELET_PORT=$&#123;KUBELET_PORT:-10250&#125;</span><br><span class="line">LOG_LEVEL=$&#123;LOG_LEVEL:-3&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Use to increase verbosity on particular files, e.g. LOG_SPEC=token_controller*=5,other_controller*=4</span></span><br><span class="line">LOG_SPEC=$&#123;LOG_SPEC:-""&#125;</span><br><span class="line">LOG_DIR=$&#123;LOG_DIR:-"/tmp"&#125;</span><br><span class="line">CONTAINER_RUNTIME=$&#123;CONTAINER_RUNTIME:-"docker"&#125;</span><br><span class="line">CONTAINER_RUNTIME_ENDPOINT=$&#123;CONTAINER_RUNTIME_ENDPOINT:-""&#125;</span><br><span class="line">RUNTIME_REQUEST_TIMEOUT=$&#123;RUNTIME_REQUEST_TIMEOUT:-"2m"&#125;</span><br><span class="line">IMAGE_SERVICE_ENDPOINT=$&#123;IMAGE_SERVICE_ENDPOINT:-""&#125;</span><br><span class="line">CHAOS_CHANCE=$&#123;CHAOS_CHANCE:-0.0&#125;</span><br><span class="line">CPU_CFS_QUOTA=$&#123;CPU_CFS_QUOTA:-true&#125;</span><br><span class="line">ENABLE_HOSTPATH_PROVISIONER=$&#123;ENABLE_HOSTPATH_PROVISIONER:-"false"&#125;</span><br><span class="line">CLAIM_BINDER_SYNC_PERIOD=$&#123;CLAIM_BINDER_SYNC_PERIOD:-"15s"&#125; # current k8s default</span><br><span class="line">ENABLE_CONTROLLER_ATTACH_DETACH=$&#123;ENABLE_CONTROLLER_ATTACH_DETACH:-"true"&#125; # current default</span><br><span class="line"><span class="meta">#</span><span class="bash"> This is the default dir and filename <span class="built_in">where</span> the apiserver will generate a self-signed cert</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">which</span> should be able to be used as the CA to verify itself</span></span><br><span class="line">CERT_DIR=$&#123;CERT_DIR:-"/etc/run/kubernetes"&#125;</span><br><span class="line">ROOT_CA_FILE=$&#123;CERT_DIR&#125;/server-ca.crt</span><br><span class="line">ROOT_CA_KEY=$&#123;CERT_DIR&#125;/server-ca.key</span><br><span class="line">CLUSTER_SIGNING_CERT_FILE=$&#123;CLUSTER_SIGNING_CERT_FILE:-"$&#123;ROOT_CA_FILE&#125;"&#125;</span><br><span class="line">CLUSTER_SIGNING_KEY_FILE=$&#123;CLUSTER_SIGNING_KEY_FILE:-"$&#123;ROOT_CA_KEY&#125;"&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Reuse certs will skip generate new ca/cert files under CERT_DIR</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it<span class="string">'s useful with PRESERVE_ETCD=true because new ca will make existed service account secrets invalided</span></span></span><br><span class="line">REUSE_CERTS=$&#123;REUSE_CERTS:-false&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> name of the cgroup driver, i.e. cgroupfs or systemd</span></span><br><span class="line">if [[ $&#123;CONTAINER_RUNTIME&#125; == "docker" ]]; then</span><br><span class="line"><span class="meta">  #</span><span class="bash"> default cgroup driver to match what is reported by docker to simplify <span class="built_in">local</span> development</span></span><br><span class="line">  if [[ -z $&#123;CGROUP_DRIVER&#125; ]]; then</span><br><span class="line">    # match driver with docker runtime reported value (they must match)</span><br><span class="line">    CGROUP_DRIVER=$(docker info | grep "Cgroup Driver:" |  sed -e 's/^[[:space:]]*//'|cut -f3- -d' ')</span><br><span class="line">    echo "Kubelet cgroup driver defaulted to use: $&#123;CGROUP_DRIVER&#125;"</span><br><span class="line">  fi</span><br><span class="line">  if [[ -f /var/log/docker.log &amp;&amp; ! -f "$&#123;LOG_DIR&#125;/docker.log" ]]; then</span><br><span class="line">    ln -s /var/log/docker.log "$&#123;LOG_DIR&#125;/docker.log"</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Ensure CERT_DIR is created <span class="keyword">for</span> auto-generated crt/key and kubeconfig</span></span><br><span class="line">mkdir -p "$&#123;CERT_DIR&#125;" &amp;&gt;/dev/null || sudo mkdir -p "$&#123;CERT_DIR&#125;"</span><br><span class="line">CONTROLPLANE_SUDO=$(test -w "$&#123;CERT_DIR&#125;" || echo "sudo -E")</span><br><span class="line"></span><br><span class="line">function test_apiserver_off &#123;</span><br><span class="line">    # For the common local scenario, fail fast if server is already running.</span><br><span class="line">    # this can happen if you run local-up-cluster.sh twice and kill etcd in between.</span><br><span class="line">    if [[ "$&#123;API_PORT&#125;" -gt "0" ]]; then</span><br><span class="line">        if ! curl --silent -g "$&#123;API_HOST&#125;:$&#123;API_PORT&#125;" ; then</span><br><span class="line">            echo "API SERVER insecure port is free, proceeding..."</span><br><span class="line">        else</span><br><span class="line">            echo "ERROR starting API SERVER, exiting. Some process on $&#123;API_HOST&#125; is serving already on $&#123;API_PORT&#125;"</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if ! curl --silent -k -g "$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125;" ; then</span><br><span class="line">        echo "API SERVER secure port is free, proceeding..."</span><br><span class="line">    else</span><br><span class="line">        echo "ERROR starting API SERVER, exiting. Some process on $&#123;API_HOST&#125; is serving already on $&#123;API_SECURE_PORT&#125;"</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function detect_binary &#123;</span><br><span class="line">    # Detect the OS name/arch so that we can find our binary</span><br><span class="line">    case "$(uname -s)" in</span><br><span class="line">      Darwin)</span><br><span class="line">        host_os=darwin</span><br><span class="line">        ;;</span><br><span class="line">      Linux)</span><br><span class="line">        host_os=linux</span><br><span class="line">        ;;</span><br><span class="line">      *)</span><br><span class="line">        echo "Unsupported host OS.  Must be Linux or Mac OS X." &gt;&amp;2</span><br><span class="line">        exit 1</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line"></span><br><span class="line">    case "$(uname -m)" in</span><br><span class="line">      x86_64*)</span><br><span class="line">        host_arch=amd64</span><br><span class="line">        ;;</span><br><span class="line">      i?86_64*)</span><br><span class="line">        host_arch=amd64</span><br><span class="line">        ;;</span><br><span class="line">      amd64*)</span><br><span class="line">        host_arch=amd64</span><br><span class="line">        ;;</span><br><span class="line">      aarch64*)</span><br><span class="line">        host_arch=arm64</span><br><span class="line">        ;;</span><br><span class="line">      arm64*)</span><br><span class="line">        host_arch=arm64</span><br><span class="line">        ;;</span><br><span class="line">      arm*)</span><br><span class="line">        host_arch=arm</span><br><span class="line">        ;;</span><br><span class="line">      i?86*)</span><br><span class="line">        host_arch=x86</span><br><span class="line">        ;;</span><br><span class="line">      s390x*)</span><br><span class="line">        host_arch=s390x</span><br><span class="line">        ;;</span><br><span class="line">      ppc64le*)</span><br><span class="line">        host_arch=ppc64le</span><br><span class="line">        ;;</span><br><span class="line">      *)</span><br><span class="line">        echo "Unsupported host arch. Must be x86_64, 386, arm, arm64, s390x or ppc64le." &gt;&amp;2</span><br><span class="line">        exit 1</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line"></span><br><span class="line">   GO_OUT="$&#123;KUBE_ROOT&#125;/_output/local/bin/$&#123;host_os&#125;/$&#123;host_arch&#125;"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cleanup()</span><br><span class="line">&#123;</span><br><span class="line">  echo "Cleaning up..."</span><br><span class="line"><span class="meta">  #</span><span class="bash"> delete running images</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;ENABLE_CLUSTER_DNS&#125;</span>"</span> == <span class="literal">true</span> ]]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Still need to figure why this commands throw an error: Error from server: client: etcd cluster is unavailable or misconfigured</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">     <span class="variable">$&#123;KUBECTL&#125;</span> --namespace=kube-system delete service kube-dns</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> And this one hang forever:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">     <span class="variable">$&#123;KUBECTL&#125;</span> --namespace=kube-system delete rc kube-dns-v10</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="keyword">fi</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the API server is still running</span></span><br><span class="line">  [[ -n "$&#123;APISERVER_PID-&#125;" ]] &amp;&amp; kube::util::read-array APISERVER_PIDS &lt; &lt;(pgrep -P "$&#123;APISERVER_PID&#125;" ; ps -o pid= -p "$&#123;APISERVER_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;APISERVER_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;APISERVER_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the controller-manager is still running</span></span><br><span class="line">  [[ -n "$&#123;CTLRMGR_PID-&#125;" ]] &amp;&amp; kube::util::read-array CTLRMGR_PIDS &lt; &lt;(pgrep -P "$&#123;CTLRMGR_PID&#125;" ; ps -o pid= -p "$&#123;CTLRMGR_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;CTLRMGR_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;CTLRMGR_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the kubelet is still running</span></span><br><span class="line">  [[ -n "$&#123;KUBELET_PID-&#125;" ]] &amp;&amp; kube::util::read-array KUBELET_PIDS &lt; &lt;(pgrep -P "$&#123;KUBELET_PID&#125;" ; ps -o pid= -p "$&#123;KUBELET_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;KUBELET_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;KUBELET_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the proxy is still running</span></span><br><span class="line">  [[ -n "$&#123;PROXY_PID-&#125;" ]] &amp;&amp; kube::util::read-array PROXY_PIDS &lt; &lt;(pgrep -P "$&#123;PROXY_PID&#125;" ; ps -o pid= -p "$&#123;PROXY_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;PROXY_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;PROXY_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the scheduler is still running</span></span><br><span class="line">  [[ -n "$&#123;SCHEDULER_PID-&#125;" ]] &amp;&amp; kube::util::read-array SCHEDULER_PIDS &lt; &lt;(pgrep -P "$&#123;SCHEDULER_PID&#125;" ; ps -o pid= -p "$&#123;SCHEDULER_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;SCHEDULER_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;SCHEDULER_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the etcd is still running</span></span><br><span class="line">  [[ -n "$&#123;ETCD_PID-&#125;" ]] &amp;&amp; kube::etcd::stop</span><br><span class="line">  if [[ "$&#123;PRESERVE_ETCD&#125;" == "false" ]]; then</span><br><span class="line">    [[ -n "$&#123;ETCD_DIR-&#125;" ]] &amp;&amp; kube::etcd::clean_etcd_dir</span><br><span class="line">  fi</span><br><span class="line">  exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Check <span class="keyword">if</span> all processes are still running. Prints a warning once each time</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a process dies unexpectedly.</span></span><br><span class="line">function healthcheck &#123;</span><br><span class="line">  if [[ -n "$&#123;APISERVER_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;APISERVER_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "API server terminated unexpectedly, see $&#123;APISERVER_LOG&#125;"</span><br><span class="line">    APISERVER_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;CTLRMGR_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;CTLRMGR_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "kube-controller-manager terminated unexpectedly, see $&#123;CTLRMGR_LOG&#125;"</span><br><span class="line">    CTLRMGR_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;KUBELET_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;KUBELET_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "kubelet terminated unexpectedly, see $&#123;KUBELET_LOG&#125;"</span><br><span class="line">    KUBELET_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;PROXY_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;PROXY_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "kube-proxy terminated unexpectedly, see $&#123;PROXY_LOG&#125;"</span><br><span class="line">    PROXY_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;SCHEDULER_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;SCHEDULER_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "scheduler terminated unexpectedly, see $&#123;SCHEDULER_LOG&#125;"</span><br><span class="line">    SCHEDULER_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;ETCD_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;ETCD_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "etcd terminated unexpectedly"</span><br><span class="line">    ETCD_PID=</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function print_color &#123;</span><br><span class="line">  message=$1</span><br><span class="line">  prefix=$&#123;2:+$2: &#125; # add colon only if defined</span><br><span class="line">  color=$&#123;3:-1&#125;     # default is red</span><br><span class="line">  echo -n "$(tput bold)$(tput setaf "$&#123;color&#125;")"</span><br><span class="line">  echo "$&#123;prefix&#125;$&#123;message&#125;"</span><br><span class="line">  echo -n "$(tput sgr0)"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function warning_log &#123;</span><br><span class="line">  print_color "$1" "W$(date "+%m%d %H:%M:%S")]" 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_etcd &#123;</span><br><span class="line">    echo "Starting etcd"</span><br><span class="line">    #export ETCD_LOGFILE=$&#123;LOG_DIR&#125;/etcd.log</span><br><span class="line">    #kube::etcd::start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function set_service_accounts &#123;</span><br><span class="line">    SERVICE_ACCOUNT_LOOKUP=$&#123;SERVICE_ACCOUNT_LOOKUP:-true&#125;</span><br><span class="line">    SERVICE_ACCOUNT_KEY=$&#123;SERVICE_ACCOUNT_KEY:-/tmp/kube-serviceaccount.key&#125;</span><br><span class="line">    # Generate ServiceAccount key if needed</span><br><span class="line">    if [[ ! -f "$&#123;SERVICE_ACCOUNT_KEY&#125;" ]]; then</span><br><span class="line">      mkdir -p "$(dirname "$&#123;SERVICE_ACCOUNT_KEY&#125;")"</span><br><span class="line">      openssl genrsa -out "$&#123;SERVICE_ACCOUNT_KEY&#125;" 2048 2&gt;/dev/null</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function generate_certs &#123;</span><br><span class="line">    # Create CA signers</span><br><span class="line">    if [[ "$&#123;ENABLE_SINGLE_CA_SIGNER:-&#125;" = true ]]; then</span><br><span class="line">        kube::util::create_signing_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" server '"client auth","server auth"'</span><br><span class="line">        sudo cp "$&#123;CERT_DIR&#125;/server-ca.key" "$&#123;CERT_DIR&#125;/client-ca.key"</span><br><span class="line">        sudo cp "$&#123;CERT_DIR&#125;/server-ca.crt" "$&#123;CERT_DIR&#125;/client-ca.crt"</span><br><span class="line">        sudo cp "$&#123;CERT_DIR&#125;/server-ca-config.json" "$&#123;CERT_DIR&#125;/client-ca-config.json"</span><br><span class="line">    else</span><br><span class="line">        kube::util::create_signing_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" server '"server auth"'</span><br><span class="line">        kube::util::create_signing_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" client '"client auth"'</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Create auth proxy client ca</span><br><span class="line">    kube::util::create_signing_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" request-header '"client auth"'</span><br><span class="line"></span><br><span class="line">    # serving cert for kube-apiserver</span><br><span class="line">    kube::util::create_serving_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "server-ca" kube-apiserver kubernetes.default kubernetes.default.svc "localhost" "$&#123;API_HOST_IP&#125;" "$&#123;API_HOST&#125;" "$&#123;FIRST_SERVICE_CLUSTER_IP&#125;"</span><br><span class="line"></span><br><span class="line">    # Create client certs signed with client-ca, given id, given CN and a number of groups</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' controller system:kube-controller-manager</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' scheduler  system:kube-scheduler</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' admin system:admin system:masters</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' kube-apiserver kube-apiserver</span><br><span class="line"></span><br><span class="line">    # Create matching certificates for kube-aggregator</span><br><span class="line">    kube::util::create_serving_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "server-ca" kube-aggregator api.kube-public.svc "localhost" "$&#123;API_HOST_IP&#125;"</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" request-header-ca auth-proxy system:auth-proxy</span><br><span class="line"></span><br><span class="line">    # TODO remove masters and add rolebinding</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' kube-aggregator system:kube-aggregator system:masters</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" kube-aggregator</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function generate_kubeproxy_certs &#123;</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' kube-proxy system:kube-proxy system:nodes</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" kube-proxy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function generate_kubelet_certs &#123;</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' kubelet "system:node:$&#123;HOSTNAME_OVERRIDE&#125;" system:nodes</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" kubelet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_apiserver &#123;</span><br><span class="line">    security_admission=""</span><br><span class="line">    if [[ -n "$&#123;DENY_SECURITY_CONTEXT_ADMISSION&#125;" ]]; then</span><br><span class="line">      security_admission=",SecurityContextDeny"</span><br><span class="line">    fi</span><br><span class="line">    if [[ -n "$&#123;PSP_ADMISSION&#125;" ]]; then</span><br><span class="line">      security_admission=",PodSecurityPolicy"</span><br><span class="line">    fi</span><br><span class="line">    if [[ -n "$&#123;NODE_ADMISSION&#125;" ]]; then</span><br><span class="line">      security_admission=",NodeRestriction"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Append security_admission plugin</span><br><span class="line">    ENABLE_ADMISSION_PLUGINS="$&#123;ENABLE_ADMISSION_PLUGINS&#125;$&#123;security_admission&#125;"</span><br><span class="line"></span><br><span class="line">    authorizer_arg=""</span><br><span class="line">    if [[ -n "$&#123;AUTHORIZATION_MODE&#125;" ]]; then</span><br><span class="line">      authorizer_arg="--authorization-mode=$&#123;AUTHORIZATION_MODE&#125;"</span><br><span class="line">    fi</span><br><span class="line">    priv_arg=""</span><br><span class="line">    if [[ -n "$&#123;ALLOW_PRIVILEGED&#125;" ]]; then</span><br><span class="line">      priv_arg="--allow-privileged=$&#123;ALLOW_PRIVILEGED&#125;"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    runtime_config=""</span><br><span class="line">    if [[ -n "$&#123;RUNTIME_CONFIG&#125;" ]]; then</span><br><span class="line">      runtime_config="--runtime-config=$&#123;RUNTIME_CONFIG&#125;"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Let the API server pick a default address when API_HOST_IP</span><br><span class="line">    # is set to 127.0.0.1</span><br><span class="line">    advertise_address=""</span><br><span class="line">    if [[ "$&#123;API_HOST_IP&#125;" != "127.0.0.1" ]]; then</span><br><span class="line">        advertise_address="--advertise-address=$&#123;API_HOST_IP&#125;"</span><br><span class="line">    fi</span><br><span class="line">    if [[ "$&#123;ADVERTISE_ADDRESS&#125;" != "" ]] ; then</span><br><span class="line">        advertise_address="--advertise-address=$&#123;ADVERTISE_ADDRESS&#125;"</span><br><span class="line">    fi</span><br><span class="line">    node_port_range=""</span><br><span class="line">    if [[ "$&#123;NODE_PORT_RANGE&#125;" != "" ]] ; then</span><br><span class="line">        node_port_range="--service-node-port-range=$&#123;NODE_PORT_RANGE&#125;"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [[ "$&#123;REUSE_CERTS&#125;" != true ]]; then</span><br><span class="line">      # Create Certs</span><br><span class="line">      generate_certs</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    cloud_config_arg="--cloud-provider=$&#123;CLOUD_PROVIDER&#125; --cloud-config=$&#123;CLOUD_CONFIG&#125;"</span><br><span class="line">    if [[ "$&#123;EXTERNAL_CLOUD_PROVIDER:-&#125;" == "true" ]]; then</span><br><span class="line">      cloud_config_arg="--cloud-provider=external"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [[ -z "$&#123;AUDIT_POLICY_FILE&#125;" ]]; then</span><br><span class="line">      cat &lt;&lt;EOF &gt; /tmp/kube-audit-policy-file</span><br><span class="line"><span class="meta">#</span><span class="bash"> Log all requests at the Metadata level.</span></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line">EOF</span><br><span class="line">      AUDIT_POLICY_FILE="/tmp/kube-audit-policy-file"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    APISERVER_LOG=$&#123;LOG_DIR&#125;/kube-apiserver.log</span><br><span class="line">    # shellcheck disable=SC2086</span><br><span class="line">    echo "go build apiserver.go $&#123;authorizer_arg&#125; $&#123;priv_arg&#125; $&#123;runtime_config&#125; $&#123;cloud_config_arg&#125; $&#123;advertise_address&#125; $&#123;node_port_range&#125; --v=$&#123;LOG_LEVEL&#125; --vmodule=$&#123;LOG_SPEC&#125; --audit-policy-file=$&#123;AUDIT_POLICY_FILE&#125; --audit-log-path=$&#123;LOG_DIR&#125;/kube-apiserver-audit.log --authorization-webhook-config-file=$&#123;AUTHORIZATION_WEBHOOK_CONFIG_FILE&#125; --authentication-token-webhook-config-file=$&#123;AUTHENTICATION_WEBHOOK_CONFIG_FILE&#125; --cert-dir=$&#123;CERT_DIR&#125; --client-ca-file=$&#123;CERT_DIR&#125;/client-ca.crt --kubelet-client-certificate=$&#123;CERT_DIR&#125;/client-kube-apiserver.crt --kubelet-client-key=$&#123;CERT_DIR&#125;/client-kube-apiserver.key --service-account-key-file=$&#123;SERVICE_ACCOUNT_KEY&#125; --service-account-lookup=$&#123;SERVICE_ACCOUNT_LOOKUP&#125; --enable-admission-plugins=$&#123;ENABLE_ADMISSION_PLUGINS&#125; --disable-admission-plugins=$&#123;DISABLE_ADMISSION_PLUGINS&#125; --admission-control-config-file=$&#123;ADMISSION_CONTROL_CONFIG_FILE&#125; --bind-address=$&#123;API_BIND_ADDR&#125; --secure-port=$&#123;API_SECURE_PORT&#125; --tls-cert-file=$&#123;CERT_DIR&#125;/serving-kube-apiserver.crt --tls-private-key-file=$&#123;CERT_DIR&#125;/serving-kube-apiserver.key --insecure-bind-address=$&#123;API_HOST_IP&#125; --insecure-port=$&#123;API_PORT&#125; --storage-backend=$&#123;STORAGE_BACKEND&#125; --storage-media-type=$&#123;STORAGE_MEDIA_TYPE&#125; --etcd-servers=http://$&#123;ETCD_HOST&#125;:$&#123;ETCD_PORT&#125; --service-cluster-ip-range=$&#123;SERVICE_CLUSTER_IP_RANGE&#125; --feature-gates=$&#123;FEATURE_GATES&#125; --external-hostname=$&#123;EXTERNAL_HOSTNAME&#125; --requestheader-username-headers=X-Remote-User --requestheader-group-headers=X-Remote-Group --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-client-ca-file=$&#123;CERT_DIR&#125;/request-header-ca.crt --requestheader-allowed-names=system:auth-proxy --proxy-client-cert-file=$&#123;CERT_DIR&#125;/client-auth-proxy.crt --proxy-client-key-file=$&#123;CERT_DIR&#125;/client-auth-proxy.key --cors-allowed-origins=$&#123;API_CORS_ALLOWED_ORIGINS&#125; &gt;$&#123;APISERVER_LOG&#125; 2&gt;&amp;1 &amp; "</span><br><span class="line"></span><br><span class="line">    # Wait for kube-apiserver to come up before launching the rest of the components.</span><br><span class="line">    echo "Waiting for apiserver to come up"</span><br><span class="line">    #kube::util::wait_for_url "https://$&#123;API_HOST_IP&#125;:$&#123;API_SECURE_PORT&#125;/healthz" "apiserver: " 1 "$&#123;WAIT_FOR_URL_API_SERVER&#125;" "$&#123;MAX_TIME_FOR_URL_API_SERVER&#125;" \</span><br><span class="line">    #    || &#123; echo "check apiserver logs: $&#123;APISERVER_LOG&#125;" ; exit 1 ; &#125;</span><br><span class="line"></span><br><span class="line">    # Create kubeconfigs for all components, using client certs</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" admin</span><br><span class="line">    $&#123;CONTROLPLANE_SUDO&#125; chown "$&#123;USER&#125;" "$&#123;CERT_DIR&#125;/client-admin.key" # make readable for kubectl</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" controller</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" scheduler</span><br><span class="line"></span><br><span class="line">    if [[ -z "$&#123;AUTH_ARGS&#125;" ]]; then</span><br><span class="line">        AUTH_ARGS="--client-key=$&#123;CERT_DIR&#125;/client-admin.key --client-certificate=$&#123;CERT_DIR&#125;/client-admin.crt"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Grant apiserver permission to speak to the kubelet</span><br><span class="line">    $&#123;KUBECTL&#125; --kubeconfig "$&#123;CERT_DIR&#125;/admin.kubeconfig" create clusterrolebinding kube-apiserver-kubelet-admin --clusterrole=system:kubelet-api-admin --user=kube-apiserver</span><br><span class="line"></span><br><span class="line">    $&#123;CONTROLPLANE_SUDO&#125; cp "$&#123;CERT_DIR&#125;/admin.kubeconfig" "$&#123;CERT_DIR&#125;/admin-kube-aggregator.kubeconfig"</span><br><span class="line">    $&#123;CONTROLPLANE_SUDO&#125; chown "$(whoami)" "$&#123;CERT_DIR&#125;/admin-kube-aggregator.kubeconfig"</span><br><span class="line">    $&#123;KUBECTL&#125; config set-cluster local-up-cluster --kubeconfig="$&#123;CERT_DIR&#125;/admin-kube-aggregator.kubeconfig" --server="https://$&#123;API_HOST_IP&#125;:31090"</span><br><span class="line">    echo "use 'kubectl --kubeconfig=$&#123;CERT_DIR&#125;/admin-kube-aggregator.kubeconfig' to use the aggregated API server"</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_controller_manager &#123;</span><br><span class="line">    node_cidr_args=()</span><br><span class="line">    if [[ "$&#123;NET_PLUGIN&#125;" == "kubenet" ]]; then</span><br><span class="line">      node_cidr_args=("--allocate-node-cidrs=true" "--cluster-cidr=10.1.0.0/16")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    cloud_config_arg=("--cloud-provider=$&#123;CLOUD_PROVIDER&#125;" "--cloud-config=$&#123;CLOUD_CONFIG&#125;")</span><br><span class="line">    if [[ "$&#123;EXTERNAL_CLOUD_PROVIDER:-&#125;" == "true" ]]; then</span><br><span class="line">      cloud_config_arg=("--cloud-provider=external")</span><br><span class="line">      cloud_config_arg+=("--external-cloud-volume-plugin=$&#123;CLOUD_PROVIDER&#125;")</span><br><span class="line">      cloud_config_arg+=("--cloud-config=$&#123;CLOUD_CONFIG&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    CTLRMGR_LOG=$&#123;LOG_DIR&#125;/kube-controller-manager.log</span><br><span class="line"></span><br><span class="line">    echo "go build controller-manager.go $&#123;GO_OUT&#125;/kube-controller-manager --v=$&#123;LOG_LEVEL&#125; --vmodule=$&#123;LOG_SPEC&#125; --service-account-private-key-file=$&#123;SERVICE_ACCOUNT_KEY&#125; --root-ca-file=$&#123;ROOT_CA_FILE&#125; --cluster-signing-cert-file=$&#123;CLUSTER_SIGNING_CERT_FILE&#125; --cluster-signing-key-file=$&#123;CLUSTER_SIGNING_KEY_FILE&#125; --enable-hostpath-provisioner=$&#123;ENABLE_HOSTPATH_PROVISIONER&#125; $&#123;node_cidr_args[@]+$&#123;node_cidr_args[@]&#125;&#125; --pvclaimbinder-sync-period=$&#123;CLAIM_BINDER_SYNC_PERIOD&#125; --feature-gates=$&#123;FEATURE_GATES&#125; $&#123;cloud_config_arg[@]&#125; --kubeconfig $&#123;CERT_DIR&#125;/controller.kubeconfig --use-service-account-credentials --controllers=$&#123;KUBE_CONTROLLERS&#125; --leader-elect=false --cert-dir=$&#123;CERT_DIR&#125; --master=https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125; &gt;$&#123;CTLRMGR_LOG&#125; 2&gt;&amp;1 &amp;"</span><br><span class="line"><span class="meta">#</span><span class="bash">    CTLRMGR_PID=$!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_cloud_controller_manager &#123;</span><br><span class="line">    if [ -z "$&#123;CLOUD_CONFIG&#125;" ]; then</span><br><span class="line">      echo "CLOUD_CONFIG cannot be empty!"</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ ! -f "$&#123;CLOUD_CONFIG&#125;" ]; then</span><br><span class="line">      echo "Cloud config $&#123;CLOUD_CONFIG&#125; doesn't exist"</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    node_cidr_args=()</span><br><span class="line">    if [[ "$&#123;NET_PLUGIN&#125;" == "kubenet" ]]; then</span><br><span class="line">      node_cidr_args=("--allocate-node-cidrs=true" "--cluster-cidr=10.1.0.0/16")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    CLOUD_CTLRMGR_LOG=$&#123;LOG_DIR&#125;/cloud-controller-manager.log</span><br><span class="line">    $&#123;CONTROLPLANE_SUDO&#125; "$&#123;EXTERNAL_CLOUD_PROVIDER_BINARY:-"$&#123;GO_OUT&#125;/cloud-controller-manager"&#125;" \</span><br><span class="line">      --v="$&#123;LOG_LEVEL&#125;" \</span><br><span class="line">      --vmodule="$&#123;LOG_SPEC&#125;" \</span><br><span class="line">      "$&#123;node_cidr_args[@]:-&#125;" \</span><br><span class="line">      --feature-gates="$&#123;FEATURE_GATES&#125;" \</span><br><span class="line">      --cloud-provider="$&#123;CLOUD_PROVIDER&#125;" \</span><br><span class="line">      --cloud-config="$&#123;CLOUD_CONFIG&#125;" \</span><br><span class="line">      --kubeconfig "$&#123;CERT_DIR&#125;"/controller.kubeconfig \</span><br><span class="line">      --use-service-account-credentials \</span><br><span class="line">      --leader-elect=false \</span><br><span class="line">      --master="https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125;" &gt;"$&#123;CLOUD_CTLRMGR_LOG&#125;" 2&gt;&amp;1 &amp;</span><br><span class="line">    export CLOUD_CTLRMGR_PID=$!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function wait_node_ready()&#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> check the nodes information after kubelet daemon start</span></span><br><span class="line">  local nodes_stats="$&#123;KUBECTL&#125; --kubeconfig '$&#123;CERT_DIR&#125;/admin.kubeconfig' get nodes"</span><br><span class="line">  local node_name=$HOSTNAME_OVERRIDE</span><br><span class="line">  local system_node_wait_time=30</span><br><span class="line">  local interval_time=2</span><br><span class="line">  kube::util::wait_for_success "$system_node_wait_time" "$interval_time" "$nodes_stats | grep $node_name"</span><br><span class="line">  if [ $? == "1" ]; then</span><br><span class="line">    echo "time out on waiting $node_name info"</span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubelet &#123;</span><br><span class="line">    KUBELET_LOG=$&#123;LOG_DIR&#125;/kubelet.log</span><br><span class="line">    mkdir -p "$&#123;POD_MANIFEST_PATH&#125;" &amp;&gt;/dev/null || sudo mkdir -p "$&#123;POD_MANIFEST_PATH&#125;"</span><br><span class="line"></span><br><span class="line">    cloud_config_arg=("--cloud-provider=$&#123;CLOUD_PROVIDER&#125;" "--cloud-config=$&#123;CLOUD_CONFIG&#125;")</span><br><span class="line">    if [[ "$&#123;EXTERNAL_CLOUD_PROVIDER:-&#125;" == "true" ]]; then</span><br><span class="line">       cloud_config_arg=("--cloud-provider=external")</span><br><span class="line">       cloud_config_arg+=("--provider-id=$(hostname)")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    mkdir -p "/var/lib/kubelet" &amp;&gt;/dev/null || sudo mkdir -p "/var/lib/kubelet"</span><br><span class="line">    # Enable dns</span><br><span class="line">    if [[ "$&#123;ENABLE_CLUSTER_DNS&#125;" = true ]]; then</span><br><span class="line">      if [[ "$&#123;ENABLE_NODELOCAL_DNS:-&#125;" == "true" ]]; then</span><br><span class="line">        dns_args=("--cluster-dns=$&#123;LOCAL_DNS_IP&#125;" "--cluster-domain=$&#123;DNS_DOMAIN&#125;")</span><br><span class="line">      else</span><br><span class="line">        dns_args=("--cluster-dns=$&#123;DNS_SERVER_IP&#125;" "--cluster-domain=$&#123;DNS_DOMAIN&#125;")</span><br><span class="line">      fi</span><br><span class="line">    else</span><br><span class="line">      # To start a private DNS server set ENABLE_CLUSTER_DNS and</span><br><span class="line">      # DNS_SERVER_IP/DOMAIN. This will at least provide a working</span><br><span class="line">      # DNS server for real world hostnames.</span><br><span class="line">      dns_args=("--cluster-dns=8.8.8.8")</span><br><span class="line">    fi</span><br><span class="line">    net_plugin_args=()</span><br><span class="line">    if [[ -n "$&#123;NET_PLUGIN&#125;" ]]; then</span><br><span class="line">      net_plugin_args=("--network-plugin=$&#123;NET_PLUGIN&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    auth_args=()</span><br><span class="line">    if [[ "$&#123;KUBELET_AUTHORIZATION_WEBHOOK:-&#125;" != "false" ]]; then</span><br><span class="line">      auth_args+=("--authorization-mode=Webhook")</span><br><span class="line">    fi</span><br><span class="line">    if [[ "$&#123;KUBELET_AUTHENTICATION_WEBHOOK:-&#125;" != "false" ]]; then</span><br><span class="line">      auth_args+=("--authentication-token-webhook")</span><br><span class="line">    fi</span><br><span class="line">    if [[ -n "$&#123;CLIENT_CA_FILE:-&#125;" ]]; then</span><br><span class="line">      auth_args+=("--client-ca-file=$&#123;CLIENT_CA_FILE&#125;")</span><br><span class="line">    else</span><br><span class="line">      auth_args+=("--client-ca-file=$&#123;CERT_DIR&#125;/client-ca.crt")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    cni_conf_dir_args=()</span><br><span class="line">    if [[ -n "$&#123;CNI_CONF_DIR&#125;" ]]; then</span><br><span class="line">      cni_conf_dir_args=("--cni-conf-dir=$&#123;CNI_CONF_DIR&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    cni_bin_dir_args=()</span><br><span class="line">    if [[ -n "$&#123;CNI_BIN_DIR&#125;" ]]; then</span><br><span class="line">      cni_bin_dir_args=("--cni-bin-dir=$&#123;CNI_BIN_DIR&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    container_runtime_endpoint_args=()</span><br><span class="line">    if [[ -n "$&#123;CONTAINER_RUNTIME_ENDPOINT&#125;" ]]; then</span><br><span class="line">      container_runtime_endpoint_args=("--container-runtime-endpoint=$&#123;CONTAINER_RUNTIME_ENDPOINT&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    image_service_endpoint_args=()</span><br><span class="line">    if [[ -n "$&#123;IMAGE_SERVICE_ENDPOINT&#125;" ]]; then</span><br><span class="line">      image_service_endpoint_args=("--image-service-endpoint=$&#123;IMAGE_SERVICE_ENDPOINT&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # shellcheck disable=SC2206</span><br><span class="line">    all_kubelet_flags=(</span><br><span class="line">      "--v=$&#123;LOG_LEVEL&#125;"</span><br><span class="line">      "--vmodule=$&#123;LOG_SPEC&#125;"</span><br><span class="line">      "--chaos-chance=$&#123;CHAOS_CHANCE&#125;"</span><br><span class="line">      "--container-runtime=$&#123;CONTAINER_RUNTIME&#125;"</span><br><span class="line">      "--hostname-override=$&#123;HOSTNAME_OVERRIDE&#125;"</span><br><span class="line">      "$&#123;cloud_config_arg[@]&#125;"</span><br><span class="line">      "--address=$&#123;KUBELET_HOST&#125;"</span><br><span class="line">      --kubeconfig "$&#123;CERT_DIR&#125;"/kubelet.kubeconfig</span><br><span class="line">      "--feature-gates=$&#123;FEATURE_GATES&#125;"</span><br><span class="line">      "--cpu-cfs-quota=$&#123;CPU_CFS_QUOTA&#125;"</span><br><span class="line">      "--enable-controller-attach-detach=$&#123;ENABLE_CONTROLLER_ATTACH_DETACH&#125;"</span><br><span class="line">      "--cgroups-per-qos=$&#123;CGROUPS_PER_QOS&#125;"</span><br><span class="line">      "--cgroup-driver=$&#123;CGROUP_DRIVER&#125;"</span><br><span class="line">      "--cgroup-root=$&#123;CGROUP_ROOT&#125;"</span><br><span class="line">      "--eviction-hard=$&#123;EVICTION_HARD&#125;"</span><br><span class="line">      "--eviction-soft=$&#123;EVICTION_SOFT&#125;"</span><br><span class="line">      "--eviction-pressure-transition-period=$&#123;EVICTION_PRESSURE_TRANSITION_PERIOD&#125;"</span><br><span class="line">      "--pod-manifest-path=$&#123;POD_MANIFEST_PATH&#125;"</span><br><span class="line">      "--fail-swap-on=$&#123;FAIL_SWAP_ON&#125;"</span><br><span class="line">      $&#123;auth_args[@]+"$&#123;auth_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;dns_args[@]+"$&#123;dns_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;cni_conf_dir_args[@]+"$&#123;cni_conf_dir_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;cni_bin_dir_args[@]+"$&#123;cni_bin_dir_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;net_plugin_args[@]+"$&#123;net_plugin_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;container_runtime_endpoint_args[@]+"$&#123;container_runtime_endpoint_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;image_service_endpoint_args[@]+"$&#123;image_service_endpoint_args[@]&#125;"&#125;</span><br><span class="line">      "--runtime-request-timeout=$&#123;RUNTIME_REQUEST_TIMEOUT&#125;"</span><br><span class="line">      "--port=$&#123;KUBELET_PORT&#125;"</span><br><span class="line">      $&#123;KUBELET_FLAGS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    if [[ "$&#123;REUSE_CERTS&#125;" != true ]]; then</span><br><span class="line">        generate_kubelet_certs</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # shellcheck disable=SC2024</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubeproxy &#123;</span><br><span class="line">    PROXY_LOG=$&#123;LOG_DIR&#125;/kube-proxy.log</span><br><span class="line"></span><br><span class="line">    # wait for kubelet collect node information</span><br><span class="line">    echo "wait kubelet ready"</span><br><span class="line">    #wait_node_ready</span><br><span class="line"></span><br><span class="line">    cat &lt;&lt;EOF &gt; /tmp/kube-proxy.yaml</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: $&#123;CERT_DIR&#125;/kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: $&#123;HOSTNAME_OVERRIDE&#125;</span><br><span class="line">mode: $&#123;KUBE_PROXY_MODE&#125;</span><br><span class="line">EOF</span><br><span class="line">    if [[ -n $&#123;FEATURE_GATES&#125; ]]; then</span><br><span class="line">      echo "featureGates:"</span><br><span class="line">      # Convert from foo=true,bar=false to</span><br><span class="line">      #   foo: true</span><br><span class="line">      #   bar: false</span><br><span class="line">      for gate in $(echo "$&#123;FEATURE_GATES&#125;" | tr ',' ' '); do</span><br><span class="line">        echo "$&#123;gate&#125;" | $&#123;SED&#125; -e 's/\(.*\)=\(.*\)/  \1: \2/'</span><br><span class="line">      done</span><br><span class="line">    fi &gt;&gt;/tmp/kube-proxy.yaml</span><br><span class="line"></span><br><span class="line">    if [[ "$&#123;REUSE_CERTS&#125;" != true ]]; then</span><br><span class="line">        generate_kubeproxy_certs</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # shellcheck disable=SC2024</span><br><span class="line">    echo "go build proxy.go --v=$&#123;LOG_LEVEL&#125; --config=/tmp/kube-proxy.yaml --master=https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125; &gt;$&#123;PROXY_LOG&#125; 2&gt;&amp;1 &amp;"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubescheduler &#123;</span><br><span class="line"></span><br><span class="line">    SCHEDULER_LOG=$&#123;LOG_DIR&#125;/kube-scheduler.log</span><br><span class="line">    echo "go build scheduler.go --v=$&#123;LOG_LEVEL&#125; --leader-elect=false --kubeconfig $&#123;CERT_DIR&#125;/scheduler.kubeconfig --feature-gates=$&#123;FEATURE_GATES&#125; --master=https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125; &gt;$&#123;SCHEDULER_LOG&#125; 2&gt;&amp;1 &amp;"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubedns &#123;</span><br><span class="line">    if [[ "$&#123;ENABLE_CLUSTER_DNS&#125;" = true ]]; then</span><br><span class="line">        cp "$&#123;KUBE_ROOT&#125;/cluster/addons/dns/kube-dns/kube-dns.yaml.in" kube-dns.yaml</span><br><span class="line">        $&#123;SED&#125; -i -e "s/&#123;&#123; pillar\['dns_domain'\] &#125;&#125;/$&#123;DNS_DOMAIN&#125;/g" kube-dns.yaml</span><br><span class="line">        $&#123;SED&#125; -i -e "s/&#123;&#123; pillar\['dns_server'\] &#125;&#125;/$&#123;DNS_SERVER_IP&#125;/g" kube-dns.yaml</span><br><span class="line">        $&#123;SED&#125; -i -e "s/&#123;&#123; pillar\['dns_memory_limit'\] &#125;&#125;/$&#123;DNS_MEMORY_LIMIT&#125;/g" kube-dns.yaml</span><br><span class="line">        # TODO update to dns role once we have one.</span><br><span class="line">        # use kubectl to create kubedns addon</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" --namespace=kube-system create -f kube-dns.yaml</span><br><span class="line">        echo "Kube-dns addon successfully deployed."</span><br><span class="line">        rm kube-dns.yaml</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_nodelocaldns &#123;</span><br><span class="line">  cp "$&#123;KUBE_ROOT&#125;/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml" nodelocaldns.yaml</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SED&#125; -i -e <span class="string">"s/__PILLAR__DNS__DOMAIN__/<span class="variable">$&#123;DNS_DOMAIN&#125;</span>/g"</span> nodelocaldns.yaml</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SED&#125; -i -e <span class="string">"s/__PILLAR__DNS__SERVER__/<span class="variable">$&#123;DNS_SERVER_IP&#125;</span>/g"</span> nodelocaldns.yaml</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SED&#125; -i -e <span class="string">"s/__PILLAR__LOCAL__DNS__/<span class="variable">$&#123;LOCAL_DNS_IP&#125;</span>/g"</span> nodelocaldns.yaml</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> use kubectl to create nodelocaldns addon</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;KUBECTL&#125; --kubeconfig=<span class="string">"<span class="variable">$&#123;CERT_DIR&#125;</span>/admin.kubeconfig"</span> --namespace=kube-system create -f nodelocaldns.yaml</span></span><br><span class="line">  echo "NodeLocalDNS addon successfully deployed."</span><br><span class="line">  rm nodelocaldns.yaml</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubedashboard &#123;</span><br><span class="line">    if [[ "$&#123;ENABLE_CLUSTER_DASHBOARD&#125;" = true ]]; then</span><br><span class="line">        echo "Creating kubernetes-dashboard"</span><br><span class="line">        # use kubectl to create the dashboard</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-secret.yaml"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-configmap.yaml"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-rbac.yaml"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-deployment.yaml"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-service.yaml"</span><br><span class="line">        echo "kubernetes-dashboard deployment and service successfully deployed."</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function create_psp_policy &#123;</span><br><span class="line">    echo "Create podsecuritypolicy policies for RBAC."</span><br><span class="line">    $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" create -f "$&#123;KUBE_ROOT&#125;/examples/podsecuritypolicy/rbac/policies.yaml"</span><br><span class="line">    $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" create -f "$&#123;KUBE_ROOT&#125;/examples/podsecuritypolicy/rbac/roles.yaml"</span><br><span class="line">    $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" create -f "$&#123;KUBE_ROOT&#125;/examples/podsecuritypolicy/rbac/bindings.yaml"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function create_storage_class &#123;</span><br><span class="line">    if [ -z "$&#123;CLOUD_PROVIDER&#125;" ]; then</span><br><span class="line">        CLASS_FILE=$&#123;KUBE_ROOT&#125;/cluster/addons/storage-class/local/default.yaml</span><br><span class="line">    else</span><br><span class="line">        CLASS_FILE=$&#123;KUBE_ROOT&#125;/cluster/addons/storage-class/$&#123;CLOUD_PROVIDER&#125;/default.yaml</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -e "$&#123;CLASS_FILE&#125;" ]; then</span><br><span class="line">        echo "Create default storage class for $&#123;CLOUD_PROVIDER&#125;"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" create -f "$&#123;CLASS_FILE&#125;"</span><br><span class="line">    else</span><br><span class="line">        echo "No storage class available for $&#123;CLOUD_PROVIDER&#125;."</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function print_success &#123;</span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  if [[ "$&#123;ENABLE_DAEMON&#125;" = false ]]; then</span><br><span class="line">    echo "Local Kubernetes cluster is running. Press Ctrl-C to shut it down."</span><br><span class="line">  else</span><br><span class="line">    echo "Local Kubernetes cluster is running."</span><br><span class="line">  fi</span><br><span class="line">  cat &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">Logs:</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;APISERVER_LOG:-&#125;</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;CTLRMGR_LOG:-&#125;</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;CLOUD_CTLRMGR_LOG:-&#125;</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;PROXY_LOG:-&#125;</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SCHEDULER_LOG:-&#125;</span></span><br><span class="line">EOF</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$&#123;START_MODE&#125;" == "all" ]]; then</span><br><span class="line">  echo "  $&#123;KUBELET_LOG&#125;"</span><br><span class="line">elif [[ "$&#123;START_MODE&#125;" == "nokubelet" ]]; then</span><br><span class="line">  echo</span><br><span class="line">  echo "No kubelet was started because you set START_MODE=nokubelet"</span><br><span class="line">  echo "Run this script again with START_MODE=kubeletonly to run a kubelet"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  echo</span><br><span class="line">  if [[ "$&#123;ENABLE_DAEMON&#125;" = false ]]; then</span><br><span class="line">    echo "To start using your cluster, you can open up another terminal/tab and run:"</span><br><span class="line">  else</span><br><span class="line">    echo "To start using your cluster, run:"</span><br><span class="line">  fi</span><br><span class="line">  cat &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">  export KUBECONFIG=$&#123;CERT_DIR&#125;/admin.kubeconfig</span><br><span class="line">  cluster/kubectl.sh</span><br><span class="line"></span><br><span class="line">Alternatively, you can write to the default kubeconfig:</span><br><span class="line"></span><br><span class="line">  export KUBERNETES_PROVIDER=local</span><br><span class="line"></span><br><span class="line">  cluster/kubectl.sh config set-cluster local --server=https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125; --certificate-authority=$&#123;ROOT_CA_FILE&#125;</span><br><span class="line">  cluster/kubectl.sh config set-credentials myself $&#123;AUTH_ARGS&#125;</span><br><span class="line">  cluster/kubectl.sh config set-context local --cluster=local --user=myself</span><br><span class="line">  cluster/kubectl.sh config use-context local</span><br><span class="line">  cluster/kubectl.sh</span><br><span class="line">EOF</span><br><span class="line">else</span><br><span class="line">  cat &lt;&lt;EOF</span><br><span class="line">The kubelet was started.</span><br><span class="line"></span><br><span class="line">Logs:</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;KUBELET_LOG&#125;</span></span><br><span class="line">EOF</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [ "$&#123;CONTAINER_RUNTIME&#125;" == "docker" ] &amp;&amp; ! kube::util::ensure_docker_daemon_connectivity; then</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  test_apiserver_off</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">kube::util::test_openssl_installed</span><br><span class="line">kube::util::ensure-cfssl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## IF the user didn't supply an output/ for the build... Then we detect.</span></span></span><br><span class="line">if [ "$&#123;GO_OUT&#125;" == "" ]; then</span><br><span class="line">  detect_binary</span><br><span class="line">fi</span><br><span class="line">echo "Detected host and ready to start services.  Doing some housekeeping first..."</span><br><span class="line">echo "Using GO_OUT $&#123;GO_OUT&#125;"</span><br><span class="line">export KUBELET_CIDFILE=/tmp/kubelet.cid</span><br><span class="line">if [[ "$&#123;ENABLE_DAEMON&#125;" = false ]]; then</span><br><span class="line">  trap cleanup EXIT</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo "Starting services now!"</span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  start_etcd</span><br><span class="line">  set_service_accounts</span><br><span class="line">  start_apiserver</span><br><span class="line">  start_controller_manager</span><br><span class="line">  start_kubescheduler</span><br><span class="line"><span class="meta">  #</span><span class="bash">start_kubedashboard</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;START_MODE&#125;</span>"</span> != <span class="string">"nokubelet"</span> ]]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="comment">## TODO remove this check if/when kubelet is supported on darwin</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="comment"># Detect the OS name/arch and display appropriate error.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="keyword">case</span> <span class="string">"<span class="variable">$(uname -s)</span>"</span> <span class="keyword">in</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">      Darwin)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        print_color <span class="string">"kubelet is not currently supported in darwin, kubelet aborted."</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">        KUBELET_LOG=<span class="string">""</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ;;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      Linux)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        start_kubelet</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ;;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      *)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        print_color <span class="string">"Unsupported host OS.  Must be Linux or Mac OS X, kubelet aborted."</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ;;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="keyword">esac</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">fi</span></span></span><br><span class="line"></span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  if [[ "$&#123;START_MODE&#125;" != "nokubeproxy" ]]; then</span><br><span class="line">    start_kubeproxy</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">print_success</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;ENABLE_DAEMON&#125;</span>"</span> = <span class="literal">false</span> ]]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> sleep 1; healthcheck; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">fi</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;KUBETEST_IN_DOCKER:-&#125;</span>"</span> == <span class="string">"true"</span> ]]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  cluster/kubectl.sh config <span class="built_in">set</span>-cluster <span class="built_in">local</span> --server=https://localhost:6443 --certificate-authority=/var/run/kubernetes/server-ca.crt</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  cluster/kubectl.sh config <span class="built_in">set</span>-credentials myself --client-key=/var/run/kubernetes/client-admin.key --client-certificate=/var/run/kubernetes/client-admin.crt</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  cluster/kubectl.sh config <span class="built_in">set</span>-context <span class="built_in">local</span> --cluster=<span class="built_in">local</span> --user=myself</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  cluster/kubectl.sh config use-context <span class="built_in">local</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">fi</span></span></span><br></pre></td></tr></table></figure>




<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">go build apiserver.go --authorization-mode&#x3D;Node,RBAC   --cloud-provider&#x3D; --cloud-config&#x3D;   --v&#x3D;3 --vmodule&#x3D; --audit-policy-file&#x3D;&#x2F;tmp&#x2F;kube-audit-policy-file --audit-log-path&#x3D;&#x2F;tmp&#x2F;kube-apiserver-audit.log --authorization-webhook-config-file&#x3D; --authentication-token-webhook-config-file&#x3D; --cert-dir&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes --client-ca-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-ca.crt --kubelet-client-certificate&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-kube-apiserver.crt --kubelet-client-key&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-kube-apiserver.key --service-account-key-file&#x3D;&#x2F;tmp&#x2F;kube-serviceaccount.key --service-account-lookup&#x3D;true --enable-admission-plugins&#x3D;NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,Priority,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota --disable-admission-plugins&#x3D; --admission-control-config-file&#x3D; --bind-address&#x3D;0.0.0.0 --secure-port&#x3D;6443 --tls-cert-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;serving-kube-apiserver.crt --tls-private-key-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;serving-kube-apiserver.key --insecure-bind-address&#x3D;127.0.0.1 --insecure-port&#x3D;8080 --storage-backend&#x3D;etcd3 --storage-media-type&#x3D; --etcd-servers&#x3D;http:&#x2F;&#x2F;127.0.0.1:2379 --service-cluster-ip-range&#x3D;10.0.0.0&#x2F;24 --feature-gates&#x3D;AllAlpha&#x3D;false --external-hostname&#x3D;localhost --requestheader-username-headers&#x3D;X-Remote-User --requestheader-group-headers&#x3D;X-Remote-Group --requestheader-extra-headers-prefix&#x3D;X-Remote-Extra- --requestheader-client-ca-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;request-header-ca.crt --requestheader-allowed-names&#x3D;system:auth-proxy --proxy-client-cert-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-auth-proxy.crt --proxy-client-key-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-auth-proxy.key --cors-allowed-origins&#x3D;&#x2F;127.0.0.1(:[0-9]+)?$,&#x2F;localhost(:[0-9]+)?$ &gt;&#x2F;tmp&#x2F;kube-apiserver.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">go build controller-manager.go --v&#x3D;3 --service-account-private-key-file&#x3D;&#x2F;tmp&#x2F;kube-serviceaccount.key --root-ca-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;server-ca.crt --cluster-signing-cert-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;server-ca.crt --cluster-signing-key-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;server-ca.key --enable-hostpath-provisioner&#x3D;false  --pvclaimbinder-sync-period&#x3D;15s --feature-gates&#x3D;AllAlpha&#x3D;false --cloud-provider&#x3D; --cloud-config&#x3D; --kubeconfig &#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;controller.kubeconfig --use-service-account-credentials --controllers&#x3D;* --leader-elect&#x3D;false --cert-dir&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes --master&#x3D;https:&#x2F;&#x2F;localhost:6443 &gt;&#x2F;tmp&#x2F;kube-controller-manager.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">go build scheduler.go --v&#x3D;3 --leader-elect&#x3D;false --kubeconfig &#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;scheduler.kubeconfig --feature-gates&#x3D;AllAlpha&#x3D;false --master&#x3D;https:&#x2F;&#x2F;localhost:6443 &gt;&#x2F;tmp&#x2F;kube-scheduler.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">go build proxy.go --v&#x3D;3 --config&#x3D;&#x2F;tmp&#x2F;kube-proxy.yaml --master&#x3D;https:&#x2F;&#x2F;localhost:6443 &gt;&#x2F;tmp&#x2F;kube-proxy.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2020/02/03/k8s/1.k8s%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/03/k8s/1.k8s%E7%AE%80%E4%BB%8B/" itemprop="url">k8s简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-03T00:00:00+08:00">2020-02-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="k8s简介"><a href="#k8s简介" class="headerlink" title="k8s简介"></a>k8s简介</h1><p><code>k8s</code> 是谷歌开源的容器集群管理系统，主要功能包括：</p>
<ol>
<li><p>基于容器的应用部署、维护和滚动升级</p>
</li>
<li><p>负载均衡和服务发现</p>
</li>
<li><p>跨机器和跨地区的集群调度</p>
</li>
<li><p>自动伸缩</p>
</li>
<li><p>无状态服务和有状态服务</p>
</li>
<li><p>广泛的 Volume 支持</p>
</li>
<li><p>插件机制保证扩展性<br>现如今，<code>k8s</code> 发展非常迅速，已经成为容器编排领域的领导者。<code>k8s</code>由以下重要组件组成</p>
</li>
<li><p>ETCD ：是用来存储所有 Kubernetes 的集群状态的，它除了具备状态存储的功能，还有事件监听和订阅、Leader选举的功能，所谓事件监听和订阅，各个其他组件通信，都并不是互相调用 API 来完成的，而是把状态写入 ETCD（相当于写入一个消息），其他组件通过监听 ETCD 的状态的的变化（相当于订阅消息），然后做后续的处理，然后再一次把更新的数据写入 ETCD。所谓 Leader 选举，其它一些组件比如 Scheduler，为了做实现高可用，通过 ETCD 从多个（通常是3个）实例里面选举出来一个做Master，其他都是Standby。</p>
</li>
<li><p>API Server：刚才说了 ETCD 是整个系统的最核心，所有组件之间通信都需要通过 ETCD，实际上，他们并不是直接访问 ETCD，而是访问一个代理，这个代理是通过标准的RESTFul API，重新封装了对 ETCD 接口调用，除此之外，这个代理还实现了一些附加功能，比如身份的认证、缓存等。这个代理就是 API Server。</p>
</li>
<li><p>Controller Manager：是实现任务调度的，关于任务调度可以参考之前的文章，简单说，直接请求 Kubernetes 做调度的都是任务，比如 Deployment 、Deamon Set 或者 Job，每一个任务请求发送给Kubernetes之后，都是由Controller Manager来处理的，每一个任务类型对应一个Controller Manager，比如 Deployment对应一个叫做 Deployment Controller，DaemonSet 对应一个 DaemonSet Controller。</p>
</li>
<li><p>Scheduler：是用来做资源调度的，Controller Manager会把任务对资源要求，其实就是Pod，写入到ETCD里面，Scheduler监听到有新的资源需要调度（新的Pod），就会根据整个集群的状态，给Pod分配到具体的节点上。</p>
</li>
<li><p>Kubelet：是一个Agent，运行在每一个节点上，它会监听ETCD中的Pod信息，发现有分配给它所在节点的Pod需要运行，就在节点上运行相应的Pod，并且把状态更新回到ETCD。</p>
</li>
<li><p>Kubectl: 是一个命令行工具，它会调用 API Server发送请求写入状态到ETCD，或者查询ETCD的状态。</p>
</li>
</ol>
<p>其代码结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">| 目录 | 说明 |</span><br><span class="line">| ----------- | ---------------------------------------- |</span><br><span class="line">| api | 输出接口文档用 |</span><br><span class="line">| build | 构建脚本 |</span><br><span class="line">| cluster | 适配不同I层的云，例如亚马逊AWS，微软Azure，谷歌GCE的集群启动脚本 |</span><br><span class="line">| cmd | 所有的二进制可执行文件入口代码，例如apiserver&#x2F;scheduler&#x2F;kubelet |</span><br><span class="line">| contrib | 项目贡献者 |</span><br><span class="line">| docs | 文档，包括了用户文档、管理员文档、设计、新功能提议 |</span><br><span class="line">| example | 使用案例 |</span><br><span class="line">| Godeps | 项目中依赖使用的Go第三方包，例如docker客户端SDK，rest等 |</span><br><span class="line">| hack | 工具箱，各种编译、构建、测试、校验的脚本都在这里面 |</span><br><span class="line">| hooks | git提交前后触发的脚本 |</span><br><span class="line">| pkg | 项目代码主目录，cmd的只是个入口，这里是所有的具体实现 |</span><br><span class="line">| plugin | 插件，k8s认为调度器是插件的一部分，所以调度器的代码在这里 |</span><br><span class="line">| release | 应该是Google发版本用的？ |</span><br><span class="line">| test | 测试相关的工具 |</span><br><span class="line">| third_party | 一些第三方工具，应该不是强依赖的？ |</span><br><span class="line">| www | UI，不过已经被移动到新项目了 |</span><br><span class="line"></span><br><span class="line">可以看到，关键实现代码都放在pkg这个目录下。对于apiserver这种跨度很广的组件而言，唯一有效的阅读方式估计就是</span><br><span class="line">遍历pkg下所有的目录，概览大概知道这个目录是干啥的</span><br><span class="line">从cmd这个入口来看apiserver的代码，然后一点点由浅入深，看apiserver的大致实现</span><br><span class="line">分特性，看具体某个大的特性是怎么实现的，例如安全，例如和etcd存储对接</span><br><span class="line">在上面这几步的过程中可以看看别人的代码阅读文档，能有效的节省时间</span><br></pre></td></tr></table></figure>
<p>本系列文章，将分五节来介绍<code>k8s</code>组件：</p>
<ol start="0">
<li>本地调试</li>
<li>apiserver工作原理</li>
<li>Informer工作原理</li>
<li>kube-controller-manager工作原理</li>
<li>kube-scheduler工作原理</li>
</ol>
<p>在阅读<code>k8s</code>代码之前，先需要了解一下基础包的使用方式，<a href="https://github.com/emicklei/go-restful" target="_blank" rel="noopener">go-restful</a>（REST-style Web服务包）、<code>CLI</code>工具包<a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">Cobra</a>以及存储<code>ectd</code>的使用方式。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ol>
<li><a href="https://feisky.gitbooks.io/kubernetes/components/apiserver.html" target="_blank" rel="noopener">k8s指南</a></li>
<li><a href="https://kubernetes.io/docs" target="_blank" rel="noopener">k8s文档</a></li>
<li><a href="http://docs.kubernetes.org.cn/" target="_blank" rel="noopener">k8s中文文档</a></li>
<li><a href="https://github.com/caicloud/kube-ladder/blob/master/README.md" target="_blank" rel="noopener">Kubernetes 学习路径</a></li>
<li><a href="https://mp.weixin.qq.com/s/ctdvbasKE-vpLRxDJjwVMw" target="_blank" rel="noopener">kubectl 创建 Pod 背后到底发生了什么？</a></li>
<li><a href="https://github.com/TeamStuQ/skill-map/blob/master/data/map-Kubernetes.md" target="_blank" rel="noopener">Kubernetes 技能图谱</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2019/11/25/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/etcd/8.etcd-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/25/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/etcd/8.etcd-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/" itemprop="url">ETCD 集群管理(is comming)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-25T00:00:00+08:00">2019-11-25</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/etcd/" itemprop="url" rel="index"><span itemprop="name">etcd</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="7-集群管理"><a href="#7-集群管理" class="headerlink" title="7. 集群管理"></a>7. 集群管理</h1><h2 id="7-1-集群间数据同步"><a href="#7-1-集群间数据同步" class="headerlink" title="7.1 集群间数据同步"></a>7.1 集群间数据同步</h2><h2 id="7-2-变更节点"><a href="#7-2-变更节点" class="headerlink" title="7.2 变更节点"></a>7.2 变更节点</h2><h3 id="7-2-1-新增节点"><a href="#7-2-1-新增节点" class="headerlink" title="7.2.1 新增节点"></a>7.2.1 新增节点</h3><h3 id="7-2-2-下线节点"><a href="#7-2-2-下线节点" class="headerlink" title="7.2.2 下线节点"></a>7.2.2 下线节点</h3><h2 id="7-3-节点宕机"><a href="#7-3-节点宕机" class="headerlink" title="7.3 节点宕机"></a>7.3 节点宕机</h2><h3 id="7-3-1-主节点宕机"><a href="#7-3-1-主节点宕机" class="headerlink" title="7.3.1 主节点宕机"></a>7.3.1 主节点宕机</h3><h3 id="7-3-2-follower节点宕机"><a href="#7-3-2-follower节点宕机" class="headerlink" title="7.3.2 follower节点宕机"></a>7.3.2 follower节点宕机</h3><h2 id="7-4-节点迁移、替换"><a href="#7-4-节点迁移、替换" class="headerlink" title="7.4 节点迁移、替换"></a>7.4 节点迁移、替换</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2019/11/25/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/etcd/7.etcd-watch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/25/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/etcd/7.etcd-watch/" itemprop="url">ETCD Watch机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-25T00:00:00+08:00">2019-11-25</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/etcd/" itemprop="url" rel="index"><span itemprop="name">etcd</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="6-Watch机制"><a href="#6-Watch机制" class="headerlink" title="6. Watch机制"></a>6. Watch机制</h1><p><code>watch</code>用于监听指定<code>key</code>或指定<code>key</code>前缀的键值对的变动。其 <code>api</code> 如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl watch --prefix[=<span class="literal">false</span>] <span class="comment">// 带前缀</span></span><br><span class="line">              --prev-kv[=<span class="literal">false</span>]<span class="comment">// 是否获取之前的key-val对</span></span><br><span class="line">              --rev=<span class="number">0</span> <span class="comment">// 开始监听的主Revision</span></span><br></pre></td></tr></table></figure>
<p>下面将详细解析其工作原理。首先将介绍其初始化过程，其次介绍创建<code>watch</code>过程以及相关键值对修改时的操作。</p>
<h2 id="6-1-初始化过程"><a href="#6-1-初始化过程" class="headerlink" title="6.1 初始化过程"></a>6.1 初始化过程</h2><p>在初始化存储的时候，提到了<code>newWatchableStore</code>方法，其对<code>boltDB</code>进行了一次封装。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">s := &amp;watchableStore&#123;</span><br><span class="line">	store:    NewStore(lg, b, le, ig),</span><br><span class="line">	victimc:  <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>),</span><br><span class="line">	unsynced: newWatcherGroup(), <span class="comment">// 包含所有未同步的watchers，有事件发生需要进行同步</span></span><br><span class="line">	synced:   newWatcherGroup(), <span class="comment">// 包含与存储进程同步的所有同步了的watchers，map的key即为watcher监听的key。</span></span><br><span class="line">	stopc:    <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> s.syncWatchersLoop()<span class="comment">// 启动每100ms一次的同步未同步映射中的监听者</span></span><br><span class="line"><span class="keyword">go</span> s.syncVictimsLoop()<span class="comment">// 同步预先发送未成功的watchers</span></span><br></pre></td></tr></table></figure>
<p>首先来看下<code>WatcherGroup</code>的数据结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> watcherGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">// key到监听此key的watcher集合</span></span><br><span class="line">	keyWatchers watcherSetByKey</span><br><span class="line"> <span class="comment">// 监听范围的监听者 (红黑树)</span></span><br><span class="line">	ranges adt.IntervalTree</span><br><span class="line">  <span class="comment">// watcher 集合</span></span><br><span class="line">	watchers watcherSet</span><br><span class="line">&#125;</span><br><span class="line">watchableStore.syncWatchers</span><br><span class="line">|- curRev := s.store.currentRev</span><br><span class="line">|- compactionRev := s.store.compactMainRev</span><br><span class="line">|- wg, minRev := s.unsynced.choose(maxWatchersPerSync, curRev, compactionRev) <span class="comment">// 从未同步的监听组中获取watcher集合</span></span><br><span class="line">    |- wg.chooseAll <span class="comment">// 选择所有watcher中最小`Revision`</span></span><br><span class="line">        |- <span class="keyword">for</span> w := <span class="keyword">range</span> wg.watchers &#123;</span><br><span class="line">            <span class="keyword">if</span> w.minRev &lt; compactRev &#123; <span class="comment">// 当小于当前压缩版本的时候直接做一次响应</span></span><br><span class="line">                <span class="keyword">select</span> &#123;</span><br><span class="line">           			<span class="keyword">case</span> w.ch &lt;- WatchResponse&#123;WatchID: w.id, CompactRevision: compactRev&#125;:</span><br><span class="line">           				w.compacted = <span class="literal">true</span></span><br><span class="line">           				wg.<span class="built_in">delete</span>(w)</span><br><span class="line">           			<span class="keyword">default</span>:</span><br><span class="line">           				<span class="comment">// retry next time</span></span><br><span class="line">       			&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> minRev &gt; w.minRev &#123;</span><br><span class="line">    			minRev = w.minRev</span><br><span class="line">    		&#125;</span><br><span class="line">         &#125;</span><br><span class="line">    |- revs, vs := tx.UnsafeRange(keyBucketName, minBytes, maxBytes, <span class="number">0</span>) <span class="comment">// 查询大于revision的所有 key-val</span></span><br><span class="line">    |- evs = kvsToEvents(s.store.lg, wg, revs, vs) <span class="comment">// 转变成 事件</span></span><br><span class="line">        |- <span class="keyword">for</span> i, v := <span class="keyword">range</span> vals &#123;</span><br><span class="line">            |- kv.Unmarshal(v)</span><br><span class="line">            |- <span class="keyword">if</span> !wg.contains(<span class="keyword">string</span>(kv.Key)) &#123; <span class="comment">// 查询是否有监听此key的watcher</span></span><br><span class="line">       			<span class="keyword">continue</span></span><br><span class="line">       		 &#125;</span><br><span class="line">       		 |- ty := mvccpb.PUT</span><br><span class="line">        		<span class="keyword">if</span> isTombstone(revs[i]) &#123;</span><br><span class="line">        			ty = mvccpb.DELETE</span><br><span class="line">        			kv.ModRevision = bytesToRev(revs[i]).main</span><br><span class="line">        		&#125;</span><br><span class="line">       		 |- evs = <span class="built_in">append</span>(evs, mvccpb.Event&#123;Kv: &amp;kv, Type: ty&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        |- newWatcherBatch(wg, evs)<span class="comment">// 将变更事件与关注该事件的watcher建立映射 map[*watcher]*eventBatch</span></span><br><span class="line">        |- 对<span class="string">`WatcherBatch`</span>中的每一项作如下处理：</span><br><span class="line">            |- 如果一次性未发送完成，则设置下次发送的Rev <span class="string">`w.minRev = eb.moreRev`</span></span><br><span class="line">            |- <span class="keyword">if</span> w.send(WatchResponse&#123;WatchID: w.id, Events: eb.evs, Revision: curRev&#125;) &#123; <span class="comment">// 发送变更响应。将消息传递到`watcher.ch`中</span></span><br><span class="line">        		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        			<span class="keyword">if</span> victims == <span class="literal">nil</span> &#123;</span><br><span class="line">        				victims = <span class="built_in">make</span>(watcherBatch)</span><br><span class="line">        			&#125;</span><br><span class="line">        			w.victim = <span class="literal">true</span></span><br><span class="line">        		&#125;</span><br><span class="line">        	|- <span class="keyword">if</span> w.victim &#123; <span class="comment">// 若发送未成功，则将要发送的`WatcherBatch`存储到`victims`中</span></span><br><span class="line">        			victims[w] = eb</span><br><span class="line">        		&#125; <span class="keyword">else</span> &#123; <span class="comment">//发送成功的话，则</span></span><br><span class="line">        			<span class="keyword">if</span> eb.moreRev != <span class="number">0</span> &#123;</span><br><span class="line">        				<span class="keyword">continue</span></span><br><span class="line">        			&#125;</span><br><span class="line">        			s.synced.add(w)</span><br><span class="line">        		&#125;</span><br><span class="line">        	|- s.unsynced.<span class="built_in">delete</span>(w)</span><br><span class="line">   	|- s.addVictim(victims)</span><br></pre></td></tr></table></figure>
<p>总结整体流程如下：</p>
<ol>
<li>首先从未同步watcherGroup中获取最多<code>maxWatchersPerSync</code>个<code>watcher</code>对应的关注最小的<code>Revision</code>，并删除已经被压缩的<code>watcher</code>；</li>
<li>使用上面得到的最小<code>Revision</code>去获取所有<code>key-val</code>对；</li>
<li>对所有<code>key-val</code>对，去寻找关注其变化的<code>watcher</code>最终生成WactherBatch</li>
<li>发送给客户端，然后将watcher从<code>unsync WatcherGroup</code>中移动到<code>sync WatcherGroup</code>中。对于未发送完成的消息添加到<code>victims</code>中，在<code>syncVictimsLoop</code>中重试。</li>
</ol>
<p>接下来即系了解<code>syncVictimsLoop</code>的实现逻辑：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123; <span class="comment">// 循环执行moveVictims方法</span></span><br><span class="line">	<span class="keyword">for</span> s.moveVictims() != <span class="number">0</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	isEmpty := <span class="built_in">len</span>(s.victims) == <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> tickc &lt;-<span class="keyword">chan</span> time.Time</span><br><span class="line">	<span class="keyword">if</span> !isEmpty &#123;</span><br><span class="line">		tickc = time.After(<span class="number">10</span> * time.Millisecond)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-tickc:</span><br><span class="line">	<span class="keyword">case</span> &lt;-s.victimc:</span><br><span class="line">	<span class="keyword">case</span> &lt;-s.stopc:</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">s.moveVictims</span><br><span class="line">|- 对victims中每一项：</span><br><span class="line">    |- 首先尝试进行发送<span class="string">`w.send(WatchResponse&#123;WatchID: w.id, Events: eb.evs, Revision: rev&#125;)`</span>。不成功的话，则加到<span class="string">`newVictim`</span>中</span><br><span class="line">    |- 其后根据当前集群情况将其加入到<span class="string">`unsynced WatcherGroup`</span>中（w.minRev &lt;= curRev）或者<span class="string">`synced WatcherGroup`</span>中</span><br></pre></td></tr></table></figure>

<h2 id="6-2-创建watch"><a href="#6-2-创建watch" class="headerlink" title="6.2 创建watch"></a>6.2 创建<code>watch</code></h2><p>当通过客户端执行如下命令<code>etcdctl watch /ty/dj --prefix</code>命令时，客户端与服务端建立<code>grpc</code>双工通道进行交互，其最终会调用<code>watchServer.Watch</code>方法，在其中建立双工通道交互方式。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sws := serverWatchStream&#123;</span><br><span class="line">	clusterID: ws.clusterID,</span><br><span class="line">	memberID:  ws.memberID,</span><br><span class="line">	maxRequestBytes: ws.maxRequestBytes,</span><br><span class="line">	sg:        ws.sg,</span><br><span class="line">	watchable: ws.watchable,</span><br><span class="line">	ag:        ws.ag,</span><br><span class="line">	gRPCStream:  stream,</span><br><span class="line">	watchStream: ws.watchable.NewWatchStream(),</span><br><span class="line">	ctrlStream: <span class="built_in">make</span>(<span class="keyword">chan</span> *pb.WatchResponse, ctrlStreamBufLen),</span><br><span class="line">	progress: <span class="built_in">make</span>(<span class="keyword">map</span>[mvcc.WatchID]<span class="keyword">bool</span>), <span class="comment">// 记录watcher是否需要发送精度</span></span><br><span class="line">	prevKV:   <span class="built_in">make</span>(<span class="keyword">map</span>[mvcc.WatchID]<span class="keyword">bool</span>), <span class="comment">// 是否需要查询历史值</span></span><br><span class="line">	fragment: <span class="built_in">make</span>(<span class="keyword">map</span>[mvcc.WatchID]<span class="keyword">bool</span>), <span class="comment">// 是否需要分片</span></span><br><span class="line">	closec: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> sws.sendLoop() <span class="comment">// 异步建立起发送消息的过程</span></span><br><span class="line"><span class="keyword">go</span> sws.recvLoop() <span class="comment">// 异步接收请求，并进行处理</span></span><br></pre></td></tr></table></figure>
<p>首先来看<code>sws.recvLoop</code>处理过程，通过<code>grpc</code>stream通道获取请求，然后调用<code>watchStream.Watch</code>方法创建<code>watch</code>，并注册到相应的<code>WatcherGroup</code>上。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ;;</span><br><span class="line">req, err := sws.gRPCStream.Recv() <span class="comment">// 接收请求</span></span><br><span class="line"><span class="keyword">switch</span> uv := req.RequestUnion.(<span class="keyword">type</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> *pb.WatchRequest_CreateRequest:</span><br><span class="line">	id, err := sws.watchStream.Watch(mvcc.WatchID(creq.WatchId), creq.Key, creq.RangeEnd, rev, filters...) <span class="comment">// 注册一个Watch</span></span><br><span class="line">    	|- watchableStore.watch</span><br><span class="line">    	   |- synced := startRev &gt; s.store.currentRev || startRev == <span class="number">0</span> <span class="comment">//查看需要同步</span></span><br><span class="line">    	   |- 如果不需要，则放入<span class="string">`synced WatcherGroup`</span>中，否则放入<span class="string">`unsynced WatcherGroup`</span></span><br></pre></td></tr></table></figure>

<p>再来看发送流程：<br>通过<code>watcher.send</code>发送变更消息的时候，实际上是传递到<code>watcher</code>的<code>ch</code>通道上，而这个通道则是<code>serverWatchStream</code>的发送通道：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> wresp, ok := &lt;-sws.watchStream.Chan():</span><br><span class="line">	evs := wresp.Events</span><br><span class="line">	events := <span class="built_in">make</span>([]*mvccpb.Event, <span class="built_in">len</span>(evs))</span><br><span class="line">	sws.mu.RLock()</span><br><span class="line">	needPrevKV := sws.prevKV[wresp.WatchID]</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> evs &#123;</span><br><span class="line">		events[i] = &amp;evs[i]</span><br><span class="line">		<span class="keyword">if</span> needPrevKV &#123; <span class="comment">// 对于需要查询历史版本的数据</span></span><br><span class="line">			opt := mvcc.RangeOptions&#123;Rev: evs[i].Kv.ModRevision - <span class="number">1</span>&#125;</span><br><span class="line">			r, err := sws.watchable.Range(evs[i].Kv.Key, <span class="literal">nil</span>, opt)</span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; <span class="built_in">len</span>(r.KVs) != <span class="number">0</span> &#123;</span><br><span class="line">				events[i].PrevKv = &amp;(r.KVs[<span class="number">0</span>])</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//是否需要分割发送</span></span><br><span class="line">	fragmented, ok := sws.fragment[wresp.WatchID]</span><br><span class="line">	<span class="keyword">if</span> !fragmented &amp;&amp; !ok &#123; <span class="comment">//不需要是，则直接发送</span></span><br><span class="line">		serr = sws.gRPCStream.Send(wr)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		serr = sendFragments(wr, sws.maxRequestBytes, sws.gRPCStream.Send)</span><br><span class="line">	&#125;</span><br><span class="line">	sws.mu.Lock()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(evs) &gt; <span class="number">0</span> &amp;&amp; sws.progress[wresp.WatchID] &#123;</span><br><span class="line">		<span class="comment">// elide next progress update if sent a key update</span></span><br><span class="line">		sws.progress[wresp.WatchID] = <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	sws.mu.Unlock()</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-3-键值对更改"><a href="#6-3-键值对更改" class="headerlink" title="6.3 键值对更改"></a>6.3 键值对更改</h2><p>建设有两个客户端A，B<br>A客户端先执行了操作<code>etcdctl watch /ty/dj</code>；B客户端随后执行了操作<code>etcdctl put /ty/dj hello</code>。那么在B执行该操作时<code>watcher</code>机制是如何work的？<br>对于<code>put</code>操作，会执行<code>storeTxnWrite.put</code>方法，会将更新的数据添加到 <code>tw.changes</code>中，最后会执行<code>watchableStoreTxnWrite.End</code>方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">changes := tw.Changes()</span><br><span class="line">rev := tw.Rev() + <span class="number">1</span></span><br><span class="line">evs := <span class="built_in">make</span>([]mvccpb.Event, <span class="built_in">len</span>(changes))</span><br><span class="line"><span class="keyword">for</span> i, change := <span class="keyword">range</span> changes &#123; <span class="comment">// 将变更转换为事件</span></span><br><span class="line">	evs[i].Kv = &amp;changes[i]</span><br><span class="line">	<span class="keyword">if</span> change.CreateRevision == <span class="number">0</span> &#123;</span><br><span class="line">		evs[i].Type = mvccpb.DELETE</span><br><span class="line">		evs[i].Kv.ModRevision = rev</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		evs[i].Type = mvccpb.PUT</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">tw.s.notify(rev, evs) <span class="comment">// 调用 watchableStore.notify方法</span></span><br><span class="line">|- <span class="keyword">for</span> w, eb := <span class="keyword">range</span> newWatcherBatch(&amp;s.synced, evs) &#123;</span><br><span class="line">		<span class="keyword">if</span> w.send(WatchResponse&#123;WatchID: w.id, Events: eb.evs, Revision: rev&#125;) &#123; <span class="comment">// 发送更新</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// move slow watcher to victims</span></span><br><span class="line">			w.minRev = rev + <span class="number">1</span></span><br><span class="line">			<span class="keyword">if</span> victim == <span class="literal">nil</span> &#123;</span><br><span class="line">				victim = <span class="built_in">make</span>(watcherBatch)</span><br><span class="line">			&#125;</span><br><span class="line">			w.victim = <span class="literal">true</span></span><br><span class="line">			victim[w] = eb</span><br><span class="line">			s.synced.<span class="built_in">delete</span>(w)</span><br><span class="line">			slowWatcherGauge.Inc()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	s.addVictim(victim)</span><br></pre></td></tr></table></figure>
<p>总结过程如下：在进行<code>put</code>操作时会将变更添加到<code>changes</code>中。当<code>put</code>操作结束时，执行<code>watchableStoreTxnWrite.End</code>方法，转换成<code>newWatcherBatch</code>事件，然后调用<code>watchableStore.notify</code>方法进行发送更新。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2019/11/24/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/etcd/6.etcd-ttl&lease/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/24/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/etcd/6.etcd-ttl&lease/" itemprop="url">TTL&Lease实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-24T00:00:00+08:00">2019-11-24</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/etcd/" itemprop="url" rel="index"><span itemprop="name">etcd</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="5-TTL-amp-Lease-实现"><a href="#5-TTL-amp-Lease-实现" class="headerlink" title="5. TTL &amp; Lease 实现"></a>5. TTL &amp; Lease 实现</h1><p><code>etcd</code>中用来实现<code>TTL</code>的机制叫<code>Lease</code>，<code>Lease</code>可以用来绑定多个key。<code>Lease</code>的主要用法如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> etcdctl lease grant <span class="number">1900</span> <span class="comment">// 申请一个租约，返回租约ID</span></span><br><span class="line"> - lease <span class="number">326969472</span>b0c5d05 granted with TTL(<span class="number">1900</span>s)</span><br><span class="line"><span class="number">2.</span> etcdctl lease revoke <span class="number">326969472</span>b0c5d05 <span class="comment">// 取消租约</span></span><br><span class="line">- lease <span class="number">326969472</span>b0c5d05 revoked</span><br><span class="line"><span class="number">3.</span> etcdctl lease timetolive  <span class="number">326969472</span>b0c5d08 <span class="comment">// 查询剩余多长时间</span></span><br><span class="line">- lease <span class="number">326969472</span>b0c5d08 granted with TTL(<span class="number">190</span>s), remaining(<span class="number">182</span>s)</span><br><span class="line"><span class="number">4.</span> etcdctl lease keep-alive <span class="number">326969472</span>b0c5d05 <span class="comment">// 到期续约</span></span><br><span class="line">- lease <span class="number">326969472</span>b0c5d05 keepalived with TTL(<span class="number">1900</span>)</span><br><span class="line"><span class="number">5.</span> etcdctl lease keep-alive --once=<span class="literal">true</span> <span class="number">326969472</span>b0c5d0c <span class="comment">// 单次续约</span></span><br><span class="line">- lease <span class="number">326969472</span>b0c5d0c keepalived with TTL(<span class="number">200</span>)</span><br></pre></td></tr></table></figure>
<p>下面将解析其工作原理，首先将介绍其初始化过程，然后介绍创建、以及绑定<code>key</code>以及过期的操作。</p>
<h2 id="5-1-初始化"><a href="#5-1-初始化" class="headerlink" title="5.1 初始化"></a>5.1 初始化</h2><p><code>Lessor</code>是在创建<code>EtcdServer</code>是进行初始化的：<code>lease.NewLessor(...)</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">minTTL := time.Duration((<span class="number">3</span>*cfg.ElectionTicks)/<span class="number">2</span>) * heartbeat <span class="comment">// 首先计算最小TTL单元，为选举跳数的1.5倍*心跳间隔时间</span></span><br><span class="line">srv.lessor = lease.NewLessor(log, srv.be, lease.LessorConfig&#123;MinLeaseTTL: <span class="keyword">int64</span>(math.Ceil(minTTL.Seconds())), CheckpointInterval: cfg.LeaseCheckpointInterval&#125;) <span class="comment">// 创建`Lessor`，传入最小租约TTL时间，和租约周期性检测时间间隔。租约的TTL时间最小不能小于最小租约时间（秒级别）</span></span><br><span class="line">|- <span class="keyword">if</span> checkpointInterval == <span class="number">0</span> &#123; <span class="comment">// 设置默认时间为5分钟</span></span><br><span class="line">		checkpointInterval = <span class="number">5</span> * time.Minute</span><br><span class="line">	&#125;</span><br><span class="line">|- l := &amp;lessor&#123;</span><br><span class="line">		leaseMap:            <span class="built_in">make</span>(<span class="keyword">map</span>[LeaseID]*Lease),</span><br><span class="line">		itemMap:             <span class="built_in">make</span>(<span class="keyword">map</span>[LeaseItem]LeaseID),</span><br><span class="line">		leaseHeap:           <span class="built_in">make</span>(LeaseQueue, <span class="number">0</span>), <span class="comment">// 根据租约到期时间排序的小根堆</span></span><br><span class="line">		leaseCheckpointHeap: <span class="built_in">make</span>(LeaseQueue, <span class="number">0</span>),</span><br><span class="line">		b:                   b,</span><br><span class="line">		minLeaseTTL:         cfg.MinLeaseTTL,</span><br><span class="line">		checkpointInterval:  checkpointInterval,</span><br><span class="line">		expiredC: <span class="built_in">make</span>(<span class="keyword">chan</span> []*Lease, <span class="number">16</span>),</span><br><span class="line">		stopC:    <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">		doneC:    <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">	&#125;</span><br><span class="line">|- l.initAndRecover() <span class="comment">// 初始化并恢复</span></span><br><span class="line">    |- vs := tx.UnsafeRange(leaseBucketName...) <span class="comment">// 从`boltDB`中，查询`lease` bucket中所有数组</span></span><br><span class="line">    |- 对于每个记录，解码<span class="string">`lpb.Unmarshal(vs[i])`</span>，然后插进<span class="string">`le.leaseMap`</span>中</span><br><span class="line">        |- le.leaseMap[ID] = &amp;Lease&#123;</span><br><span class="line">			ID:  ID,</span><br><span class="line">			ttl: lpb.TTL,</span><br><span class="line">			itemSet: <span class="built_in">make</span>(<span class="keyword">map</span>[LeaseItem]<span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">			expiry:  forever,</span><br><span class="line">			revokec: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">		&#125;</span><br><span class="line">	|- heap.Init(&amp;le.leaseHeap) <span class="comment">//初始化堆</span></span><br><span class="line">	|- heap.Init(&amp;le.leaseCheckpointHeap)</span><br><span class="line">|- <span class="keyword">go</span> l.runLoop() <span class="comment">// 运行500ms一次的任务，撤销过期的租约，周期性调度`Lease`检测。后续将详细分析其执行过程</span></span><br></pre></td></tr></table></figure>
<p>完成了<code>Lessor</code>的初始化后，随着进入<code>kvstore.restore</code>的初始化，会伴随着恢复<code>key</code>与<code>lease</code>的映射关系。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">当从 bucket<span class="string">`key`</span>中获取所有key-val后，执行<span class="string">`restoreChunk`</span>方法</span><br><span class="line">restoreChunk</span><br><span class="line">|- 其会检测kv是否带<span class="string">`Lease`</span>，若有则加入到<span class="string">`keyToLease`</span><span class="keyword">map</span>中</span><br><span class="line">|- 对<span class="string">`keyToLease`</span><span class="keyword">map</span>中的每个entry</span><br><span class="line">    |- s.le.Attach(lid, []lease.LeaseItem&#123;&#123;Key: key&#125;&#125;)</span><br><span class="line">        |- 将<span class="string">`key`</span>绑定到<span class="string">`lease`</span>中，并建立<span class="string">`key`</span>到<span class="string">`lease`</span>的映射</span><br></pre></td></tr></table></figure>
<h2 id="5-2-Lease创建"><a href="#5-2-Lease创建" class="headerlink" title="5.2 Lease创建"></a>5.2 <code>Lease</code>创建</h2><p>创建<code>Lease</code>，最终会调用<code>EtcdServer.LeaseGrant</code>方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">EtcdServer.LeaseGrant</span><br><span class="line">|- r.ID = <span class="keyword">int64</span>(s.reqIDGen.Next() &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">63</span>) - <span class="number">1</span>)) <span class="comment">// 首先创建 leaseId</span></span><br><span class="line">|- s.raftRequestOnce 发起提议</span><br><span class="line">    |- 当集群确认提交此提议后，会进行应用。调用<span class="string">`lessor.Grant`</span></span><br><span class="line">        |- l := &amp;Lease&#123; <span class="comment">// 创建 Lease</span></span><br><span class="line">        		ID:      id,</span><br><span class="line">        		ttl:     ttl,</span><br><span class="line">        		itemSet: <span class="built_in">make</span>(<span class="keyword">map</span>[LeaseItem]<span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">        		revokec: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">        	&#125;</span><br><span class="line">        |- <span class="keyword">if</span> l.ttl &lt; le.minLeaseTTL &#123; <span class="comment">// 保证租约ttl不小于`minLeaseTTL`</span></span><br><span class="line">        		l.ttl = le.minLeaseTTL</span><br><span class="line">        	&#125;</span><br><span class="line">        |- l.refresh(<span class="number">0</span>) <span class="comment">// 设置 `Lease`的 `expiry`时间</span></span><br><span class="line">        |- le.leaseMap[id] = l <span class="comment">// 放入 `leaseId`与`lease`的映射</span></span><br><span class="line">        |- item := &amp;LeaseWithTime&#123;id: l.ID, time: l.expiry.UnixNano()&#125; <span class="comment">// 过期时间戳、leaseId item</span></span><br><span class="line">        |- heap.Push(&amp;le.leaseHeap, item) <span class="comment">// 存入堆中</span></span><br><span class="line">        |- l.persistTo(le.b) <span class="comment">// 将lease信息存储 boltDB中</span></span><br><span class="line">        |- le.scheduleCheckpointIfNeeded(l)</span><br><span class="line">            |- <span class="keyword">if</span> lease.RemainingTTL() &gt; <span class="keyword">int64</span>(le.checkpointInterval.Seconds()) &#123; <span class="comment">// 若`lease`的剩余时间比`检测点间隔`大时，则存进`le.leaseCheckpointHeap`中</span></span><br><span class="line">                |- heap.Push(&amp;le.leaseCheckpointHeap, &amp;LeaseWithTime&#123;</span><br><span class="line">        			id:   lease.ID,</span><br><span class="line">        			time: time.Now().Add(le.checkpointInterval).UnixNano(),</span><br><span class="line">        		&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="5-3-Lease绑定key"><a href="#5-3-Lease绑定key" class="headerlink" title="5.3 Lease绑定key"></a>5.3 <code>Lease</code>绑定<code>key</code></h2><p>在<code>put</code>操作时通过添加参数<code>--lease=326969472b0c5d08</code>即将<code>key</code>绑定到<code>lease</code>上。直接定位<code>storeTxnWrite.put</code>方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">oldLease = tw.s.le.GetLease(lease.LeaseItem&#123;Key: <span class="keyword">string</span>(key)&#125;) <span class="comment">// 获取key之前绑定的`lease`</span></span><br><span class="line"><span class="keyword">if</span> oldLease != lease.NoLease &#123;</span><br><span class="line">    err = tw.s.le.Detach(oldLease, []lease.LeaseItem&#123;&#123;Key: <span class="keyword">string</span>(key)&#125;&#125;) <span class="comment">// 剔除`key`与老`lease`的映射关系</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> leaseID != lease.NoLease &#123;</span><br><span class="line">    err = tw.s.le.Attach(leaseID, []lease.LeaseItem&#123;&#123;Key: <span class="keyword">string</span>(key)&#125;&#125;)</span><br><span class="line">    |- <span class="keyword">for</span> _, it := <span class="keyword">range</span> items &#123;</span><br><span class="line">    		l.itemSet[it] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">    		le.itemMap[it] = id</span><br><span class="line">    	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-4-Lease过期"><a href="#5-4-Lease过期" class="headerlink" title="5.4 Lease过期"></a>5.4 <code>Lease</code>过期</h2><p>上文中介绍过在初始化<code>Lease</code>后，会启动<code>lessor.runLoop</code>任务：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="comment">// 注销过期的租约</span></span><br><span class="line">	le.revokeExpiredLeases()</span><br><span class="line">	<span class="comment">// 检测调度的租约</span></span><br><span class="line">	le.checkpointScheduledLeases()</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="comment">// 500ms 一次</span></span><br><span class="line">	<span class="keyword">case</span> &lt;-time.After(<span class="number">500</span> * time.Millisecond):</span><br><span class="line">	<span class="keyword">case</span> &lt;-le.stopC:</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">le.revokeExpiredLeases</span><br><span class="line">|- revokeLimit := leaseRevokeRate / <span class="number">2</span> <span class="comment">// 限流</span></span><br><span class="line">|- ls = le.findExpiredLeases(revokeLimit) <span class="comment">// 查询出过期的租约</span></span><br><span class="line">|- <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> le.expiredC &lt;- ls:</span><br><span class="line">   &#125;</span><br><span class="line">|- <span class="string">`EtcdServer`</span> 会监听<span class="string">`lessor.expiredC`</span>通道：</span><br><span class="line">|- 异步串行执行：<span class="string">`s.LeaseRevoke(ctx, &amp;pb.LeaseRevokeRequest&#123;ID: int64(lid)&#125;)`</span></span><br><span class="line">    |- 提交Revoke提议，最后进行应用：</span><br><span class="line">        |- lessor.Revoke</span><br><span class="line">            |- keys := l.Keys()</span><br><span class="line">            	sort.StringSlice(keys).Sort()</span><br><span class="line">            	<span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123; <span class="comment">// 删除key</span></span><br><span class="line">            		txn.DeleteRange([]<span class="keyword">byte</span>(key), <span class="literal">nil</span>)</span><br><span class="line">            	&#125;</span><br><span class="line">            |- <span class="built_in">delete</span>(le.leaseMap, l.ID)</span><br><span class="line">            |- le.b.BatchTx().UnsafeDelete(leaseBucketName, int64ToBytes(<span class="keyword">int64</span>(l.ID))) <span class="comment">// 从`lease`bucket中删除租约</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zamperini</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/%7C%7C%20archive">
                
                    <span class="site-state-item-count">55</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/DorgenJones" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:dblpfilter@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/1938368215" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zamperini</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
