<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://dorgenjones.github.io').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="0. 本地调试k8s各组件之间的交互需要用到加密通信，如果简单配置各组件的启动参数，相互之间无法正常通信。本节将介绍如何在配置进而可以在本地进行debugk8s集群。 0.1 本地运行调试k8s有个文件hack&#x2F;local-up-cluster.sh用于起一个本地k8s集群，而该脚本生成的证书等同样可以用于ideadebug时使用。这里进行了以下修改：将执行组件的命令，转换成输出命令参数echo命">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s本地调试">
<meta property="og:url" content="https://dorgenjones.github.io/2020/02/04/k8s/2.k8s%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95/index.html">
<meta property="og:site_name" content="Zamperini">
<meta property="og:description" content="0. 本地调试k8s各组件之间的交互需要用到加密通信，如果简单配置各组件的启动参数，相互之间无法正常通信。本节将介绍如何在配置进而可以在本地进行debugk8s集群。 0.1 本地运行调试k8s有个文件hack&#x2F;local-up-cluster.sh用于起一个本地k8s集群，而该脚本生成的证书等同样可以用于ideadebug时使用。这里进行了以下修改：将执行组件的命令，转换成输出命令参数echo命">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-02-03T16:00:00.000Z">
<meta property="article:modified_time" content="2020-03-03T14:18:07.243Z">
<meta property="article:author" content="Zamperini">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://dorgenjones.github.io/2020/02/04/k8s/2.k8s%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>k8s本地调试 | Zamperini</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zamperini</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">23</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">11</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">56</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dorgenjones.github.io/2020/02/04/k8s/2.k8s%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.png">
      <meta itemprop="name" content="Zamperini">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zamperini">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s本地调试
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-04 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-04T00:00:00+08:00">2020-02-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-03 22:18:07" itemprop="dateModified" datetime="2020-03-03T22:18:07+08:00">2020-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="0-本地调试"><a href="#0-本地调试" class="headerlink" title="0. 本地调试"></a>0. 本地调试</h1><p><code>k8s</code>各组件之间的交互需要用到加密通信，如果简单配置各组件的启动参数，相互之间无法正常通信。本节将介绍如何在配置进而可以在本地进行<code>debug</code>k8s集群。</p>
<h2 id="0-1-本地运行调试"><a href="#0-1-本地运行调试" class="headerlink" title="0.1 本地运行调试"></a>0.1 本地运行调试</h2><p><code>k8s</code>有个文件<code>hack/local-up-cluster.sh</code>用于起一个本地<code>k8s</code>集群，而该脚本生成的证书等同样可以用于<code>idea</code>debug时使用。这里进行了以下修改：将执行组件的命令，<strong>转换成输出命令参数</strong><code>echo</code>命令见附件^1。</p>
<h2 id="0-2-远程debug"><a href="#0-2-远程debug" class="headerlink" title="0.2 远程debug"></a>0.2 远程debug</h2><p>还有一种方式则是在另一台机器上运行一个<code>k8s</code>集群，通过<code>dlv</code>来远程<code>debug</code>，可以参考此篇： <a href="https://cloud.tencent.com/developer/article/1402449" target="_blank" rel="noopener">搭建k8s的开发调试环境</a></p>
<a id="more"></a>


<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><h3 id="1-本地生成密钥以及组件命令参数"><a href="#1-本地生成密钥以及组件命令参数" class="headerlink" title="[^1]: 本地生成密钥以及组件命令参数"></a>[^1]: 本地生成密钥以及组件命令参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copyright 2014 The Kubernetes Authors.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Licensed under the Apache License, Version 2.0 (the <span class="string">"License"</span>);</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you may not use this file except <span class="keyword">in</span> compliance with the License.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Unless required by applicable law or agreed to <span class="keyword">in</span> writing, software</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">"AS IS"</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"></span><br><span class="line">KUBE_ROOT=$(dirname "$&#123;BASH_SOURCE[0]&#125;")/..</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This <span class="built_in">command</span> builds and runs a <span class="built_in">local</span> kubernetes cluster.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You may need to run this as root to allow kubelet to open docker<span class="string">'s socket,</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and to write the <span class="built_in">test</span> CA <span class="keyword">in</span> /var/run/kubernetes.</span></span><br><span class="line">DOCKER_OPTS=$&#123;DOCKER_OPTS:-""&#125;</span><br><span class="line">export DOCKER=(docker "$&#123;DOCKER_OPTS[@]&#125;")</span><br><span class="line">DOCKER_ROOT=$&#123;DOCKER_ROOT:-""&#125;</span><br><span class="line">ALLOW_PRIVILEGED=$&#123;ALLOW_PRIVILEGED:-""&#125;</span><br><span class="line">DENY_SECURITY_CONTEXT_ADMISSION=$&#123;DENY_SECURITY_CONTEXT_ADMISSION:-""&#125;</span><br><span class="line">PSP_ADMISSION=$&#123;PSP_ADMISSION:-""&#125;</span><br><span class="line">NODE_ADMISSION=$&#123;NODE_ADMISSION:-""&#125;</span><br><span class="line">RUNTIME_CONFIG=$&#123;RUNTIME_CONFIG:-""&#125;</span><br><span class="line">KUBELET_AUTHORIZATION_WEBHOOK=$&#123;KUBELET_AUTHORIZATION_WEBHOOK:-""&#125;</span><br><span class="line">KUBELET_AUTHENTICATION_WEBHOOK=$&#123;KUBELET_AUTHENTICATION_WEBHOOK:-""&#125;</span><br><span class="line">POD_MANIFEST_PATH=$&#123;POD_MANIFEST_PATH:-"/var/run/kubernetes/static-pods"&#125;</span><br><span class="line">KUBELET_FLAGS=$&#123;KUBELET_FLAGS:-""&#125;</span><br><span class="line">KUBELET_IMAGE=$&#123;KUBELET_IMAGE:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> many dev environments run with swap on, so we don<span class="string">'t fail in this env</span></span></span><br><span class="line">FAIL_SWAP_ON=$&#123;FAIL_SWAP_ON:-"false"&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Name of the network plugin, eg: <span class="string">"kubenet"</span></span></span><br><span class="line">NET_PLUGIN=$&#123;NET_PLUGIN:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Place the config files and binaries required by NET_PLUGIN <span class="keyword">in</span> these directory,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> eg: <span class="string">"/etc/cni/net.d"</span> <span class="keyword">for</span> config files, and <span class="string">"/opt/cni/bin"</span> <span class="keyword">for</span> binaries.</span></span><br><span class="line">CNI_CONF_DIR=$&#123;CNI_CONF_DIR:-""&#125;</span><br><span class="line">CNI_BIN_DIR=$&#123;CNI_BIN_DIR:-""&#125;</span><br><span class="line">SERVICE_CLUSTER_IP_RANGE=$&#123;SERVICE_CLUSTER_IP_RANGE:-10.0.0.0/24&#125;</span><br><span class="line">FIRST_SERVICE_CLUSTER_IP=$&#123;FIRST_SERVICE_CLUSTER_IP:-10.0.0.1&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> enabled, must <span class="built_in">set</span> CGROUP_ROOT</span></span><br><span class="line">CGROUPS_PER_QOS=$&#123;CGROUPS_PER_QOS:-true&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> name of the cgroup driver, i.e. cgroupfs or systemd</span></span><br><span class="line">CGROUP_DRIVER=$&#123;CGROUP_DRIVER:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> cgroups per qos is enabled, optionally change cgroup root</span></span><br><span class="line">CGROUP_ROOT=$&#123;CGROUP_ROOT:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> owner of client certs, default to current user <span class="keyword">if</span> not specified</span></span><br><span class="line">USER=$&#123;USER:-$(whoami)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> enables testing eviction scenarios locally.</span></span><br><span class="line">EVICTION_HARD=$&#123;EVICTION_HARD:-"memory.available&lt;100Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5%"&#125;</span><br><span class="line">EVICTION_SOFT=$&#123;EVICTION_SOFT:-""&#125;</span><br><span class="line">EVICTION_PRESSURE_TRANSITION_PERIOD=$&#123;EVICTION_PRESSURE_TRANSITION_PERIOD:-"1m"&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This script uses docker0 (or whatever container bridge docker is currently using)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and we don<span class="string">'t know the IP of the DNS pod to pass in as --cluster-dns.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> To <span class="built_in">set</span> this up by hand, <span class="built_in">set</span> this flag and change DNS_SERVER_IP.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note also that you need API_HOST (defined above) <span class="keyword">for</span> correct DNS.</span></span><br><span class="line">KUBE_PROXY_MODE=$&#123;KUBE_PROXY_MODE:-""&#125;</span><br><span class="line">ENABLE_CLUSTER_DNS=$&#123;KUBE_ENABLE_CLUSTER_DNS:-true&#125;</span><br><span class="line">ENABLE_NODELOCAL_DNS=$&#123;KUBE_ENABLE_NODELOCAL_DNS:-false&#125;</span><br><span class="line">DNS_SERVER_IP=$&#123;KUBE_DNS_SERVER_IP:-10.0.0.10&#125;</span><br><span class="line">LOCAL_DNS_IP=$&#123;KUBE_LOCAL_DNS_IP:-169.254.20.10&#125;</span><br><span class="line">DNS_MEMORY_LIMIT=$&#123;KUBE_DNS_MEMORY_LIMIT:-170Mi&#125;</span><br><span class="line">DNS_DOMAIN=$&#123;KUBE_DNS_NAME:-"cluster.local"&#125;</span><br><span class="line">KUBECTL=$&#123;KUBECTL:-"$&#123;KUBE_ROOT&#125;/cluster/kubectl.sh"&#125;</span><br><span class="line">WAIT_FOR_URL_API_SERVER=$&#123;WAIT_FOR_URL_API_SERVER:-60&#125;</span><br><span class="line">MAX_TIME_FOR_URL_API_SERVER=$&#123;MAX_TIME_FOR_URL_API_SERVER:-1&#125;</span><br><span class="line">ENABLE_DAEMON=$&#123;ENABLE_DAEMON:-false&#125;</span><br><span class="line">HOSTNAME_OVERRIDE=$&#123;HOSTNAME_OVERRIDE:-"127.0.0.1"&#125;</span><br><span class="line">EXTERNAL_CLOUD_PROVIDER=$&#123;EXTERNAL_CLOUD_PROVIDER:-false&#125;</span><br><span class="line">EXTERNAL_CLOUD_PROVIDER_BINARY=$&#123;EXTERNAL_CLOUD_PROVIDER_BINARY:-""&#125;</span><br><span class="line">CLOUD_PROVIDER=$&#123;CLOUD_PROVIDER:-""&#125;</span><br><span class="line">CLOUD_CONFIG=$&#123;CLOUD_CONFIG:-""&#125;</span><br><span class="line">FEATURE_GATES=$&#123;FEATURE_GATES:-"AllAlpha=false"&#125;</span><br><span class="line">STORAGE_BACKEND=$&#123;STORAGE_BACKEND:-"etcd3"&#125;</span><br><span class="line">STORAGE_MEDIA_TYPE=$&#123;STORAGE_MEDIA_TYPE:-""&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> preserve etcd data. you also need to <span class="built_in">set</span> ETCD_DIR.</span></span><br><span class="line">PRESERVE_ETCD="$&#123;PRESERVE_ETCD:-false&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> kubernetes dashboard</span></span><br><span class="line">ENABLE_CLUSTER_DASHBOARD=$&#123;KUBE_ENABLE_CLUSTER_DASHBOARD:-false&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> RBAC Mode options</span></span><br><span class="line">AUTHORIZATION_MODE=$&#123;AUTHORIZATION_MODE:-"Node,RBAC"&#125;</span><br><span class="line">KUBECONFIG_TOKEN=$&#123;KUBECONFIG_TOKEN:-""&#125;</span><br><span class="line">AUTH_ARGS=$&#123;AUTH_ARGS:-""&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> WebHook Authentication and Authorization</span></span><br><span class="line">AUTHORIZATION_WEBHOOK_CONFIG_FILE=$&#123;AUTHORIZATION_WEBHOOK_CONFIG_FILE:-""&#125;</span><br><span class="line">AUTHENTICATION_WEBHOOK_CONFIG_FILE=$&#123;AUTHENTICATION_WEBHOOK_CONFIG_FILE:-""&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Install a default storage class (enabled by default)</span></span><br><span class="line">DEFAULT_STORAGE_CLASS=$&#123;KUBE_DEFAULT_STORAGE_CLASS:-true&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Do not run the mutation detector by default on a <span class="built_in">local</span> cluster.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is intended <span class="keyword">for</span> a specific <span class="built_in">type</span> of testing and inherently leaks memory.</span></span><br><span class="line">KUBE_CACHE_MUTATION_DETECTOR="$&#123;KUBE_CACHE_MUTATION_DETECTOR:-false&#125;"</span><br><span class="line">export KUBE_CACHE_MUTATION_DETECTOR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> panic the server on watch decode errors since they are considered coder mistakes</span></span><br><span class="line">KUBE_PANIC_WATCH_DECODE_ERROR="$&#123;KUBE_PANIC_WATCH_DECODE_ERROR:-true&#125;"</span><br><span class="line">export KUBE_PANIC_WATCH_DECODE_ERROR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Default list of admission Controllers to invoke prior to persisting objects <span class="keyword">in</span> cluster</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The order defined here does not matter.</span></span><br><span class="line">ENABLE_ADMISSION_PLUGINS=$&#123;ENABLE_ADMISSION_PLUGINS:-"NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,Priority,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota"&#125;</span><br><span class="line">DISABLE_ADMISSION_PLUGINS=$&#123;DISABLE_ADMISSION_PLUGINS:-""&#125;</span><br><span class="line">ADMISSION_CONTROL_CONFIG_FILE=$&#123;ADMISSION_CONTROL_CONFIG_FILE:-""&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> START_MODE can be <span class="string">'all'</span>, <span class="string">'kubeletonly'</span>, <span class="string">'nokubelet'</span>, or <span class="string">'nokubeproxy'</span></span></span><br><span class="line">START_MODE=$&#123;START_MODE:-"all"&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A list of controllers to <span class="built_in">enable</span></span></span><br><span class="line">KUBE_CONTROLLERS="$&#123;KUBE_CONTROLLERS:-"*"&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Audit policy</span></span><br><span class="line">AUDIT_POLICY_FILE=$&#123;AUDIT_POLICY_FILE:-""&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> sanity check <span class="keyword">for</span> OpenStack provider</span></span><br><span class="line">if [ "$&#123;CLOUD_PROVIDER&#125;" == "openstack" ]; then</span><br><span class="line">    if [ "$&#123;CLOUD_CONFIG&#125;" == "" ]; then</span><br><span class="line">        echo "Missing CLOUD_CONFIG env for OpenStack provider!"</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ ! -f "$&#123;CLOUD_CONFIG&#125;" ]; then</span><br><span class="line">        echo "Cloud config $&#123;CLOUD_CONFIG&#125; doesn't exist"</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> warn <span class="keyword">if</span> users are running with swap allowed</span></span><br><span class="line">if [ "$&#123;FAIL_SWAP_ON&#125;" == "false" ]; then</span><br><span class="line">    echo "WARNING : The kubelet is configured to not fail even if swap is enabled; production deployments should disable swap."</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$(id -u)" != "0" ]; then</span><br><span class="line">    echo "WARNING : This script MAY be run as root for docker socket / iptables functionality; if failures occur, retry as root." 2&gt;&amp;1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Stop right away <span class="keyword">if</span> the build fails</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">source "$&#123;KUBE_ROOT&#125;/hack/lib/init.sh"</span><br><span class="line">kube::util::ensure-gnu-sed</span><br><span class="line"></span><br><span class="line">function usage &#123;</span><br><span class="line">            echo "This script starts a local kube cluster. "</span><br><span class="line">            echo "Example 0: hack/local-up-cluster.sh -h  (this 'help' usage description)"</span><br><span class="line">            echo "Example 1: hack/local-up-cluster.sh -o _output/dockerized/bin/linux/amd64/ (run from docker output)"</span><br><span class="line">            echo "Example 2: hack/local-up-cluster.sh -O (auto-guess the bin path for your platform)"</span><br><span class="line">            echo "Example 3: hack/local-up-cluster.sh (build a local copy of the source)"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This <span class="keyword">function</span> guesses <span class="built_in">where</span> the existing cached binary build is <span class="keyword">for</span> the `-O`</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> flag</span></span><br><span class="line">function guess_built_binary_path &#123;</span><br><span class="line">  local apiserver_path</span><br><span class="line">  apiserver_path=$(kube::util::find-binary "kube-apiserver")</span><br><span class="line">  if [[ -z "$&#123;apiserver_path&#125;" ]]; then</span><br><span class="line">    return</span><br><span class="line">  fi</span><br><span class="line">  echo -n "$(dirname "$&#123;apiserver_path&#125;")"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## Allow user to supply the source directory.</span></span></span><br><span class="line">GO_OUT=$&#123;GO_OUT:-&#125;</span><br><span class="line">while getopts "ho:O" OPTION</span><br><span class="line">do</span><br><span class="line">    case $&#123;OPTION&#125; in</span><br><span class="line">        o)</span><br><span class="line">            echo "skipping build"</span><br><span class="line">            GO_OUT="$&#123;OPTARG&#125;"</span><br><span class="line">            echo "using source $&#123;GO_OUT&#125;"</span><br><span class="line">            ;;</span><br><span class="line">        O)</span><br><span class="line">            GO_OUT=$(guess_built_binary_path)</span><br><span class="line">            if [ "$&#123;GO_OUT&#125;" == "" ]; then</span><br><span class="line">                echo "Could not guess the correct output directory to use."</span><br><span class="line">                exit 1</span><br><span class="line">            fi</span><br><span class="line">            ;;</span><br><span class="line">        h)</span><br><span class="line">            usage</span><br><span class="line">            exit</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            usage</span><br><span class="line">            exit</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ "x$&#123;GO_OUT&#125;" == "x" ]; then</span><br><span class="line">    make -C "$&#123;KUBE_ROOT&#125;" WHAT="cmd/kubectl cmd/kube-apiserver cmd/kube-controller-manager cmd/cloud-controller-manager cmd/kubelet cmd/kube-proxy cmd/kube-scheduler"</span><br><span class="line">else</span><br><span class="line">    echo "skipped the build."</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Shut down anyway <span class="keyword">if</span> there<span class="string">'s an error.</span></span></span><br><span class="line">set +e</span><br><span class="line"></span><br><span class="line">API_PORT=$&#123;API_PORT:-8080&#125;</span><br><span class="line">API_SECURE_PORT=$&#123;API_SECURE_PORT:-6443&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> WARNING: For DNS to work on most setups you should <span class="built_in">export</span> API_HOST as the docker0 ip address,</span></span><br><span class="line">API_HOST=$&#123;API_HOST:-localhost&#125;</span><br><span class="line">API_HOST_IP=$&#123;API_HOST_IP:-"127.0.0.1"&#125;</span><br><span class="line">ADVERTISE_ADDRESS=$&#123;ADVERTISE_ADDRESS:-""&#125;</span><br><span class="line">NODE_PORT_RANGE=$&#123;NODE_PORT_RANGE:-""&#125;</span><br><span class="line">API_BIND_ADDR=$&#123;API_BIND_ADDR:-"0.0.0.0"&#125;</span><br><span class="line">EXTERNAL_HOSTNAME=$&#123;EXTERNAL_HOSTNAME:-localhost&#125;</span><br><span class="line"></span><br><span class="line">KUBELET_HOST=$&#123;KUBELET_HOST:-"127.0.0.1"&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> By default only allow CORS <span class="keyword">for</span> requests on localhost</span></span><br><span class="line">API_CORS_ALLOWED_ORIGINS=$&#123;API_CORS_ALLOWED_ORIGINS:-/127.0.0.1(:[0-9]+)?$,/localhost(:[0-9]+)?$&#125;</span><br><span class="line">KUBELET_PORT=$&#123;KUBELET_PORT:-10250&#125;</span><br><span class="line">LOG_LEVEL=$&#123;LOG_LEVEL:-3&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Use to increase verbosity on particular files, e.g. LOG_SPEC=token_controller*=5,other_controller*=4</span></span><br><span class="line">LOG_SPEC=$&#123;LOG_SPEC:-""&#125;</span><br><span class="line">LOG_DIR=$&#123;LOG_DIR:-"/tmp"&#125;</span><br><span class="line">CONTAINER_RUNTIME=$&#123;CONTAINER_RUNTIME:-"docker"&#125;</span><br><span class="line">CONTAINER_RUNTIME_ENDPOINT=$&#123;CONTAINER_RUNTIME_ENDPOINT:-""&#125;</span><br><span class="line">RUNTIME_REQUEST_TIMEOUT=$&#123;RUNTIME_REQUEST_TIMEOUT:-"2m"&#125;</span><br><span class="line">IMAGE_SERVICE_ENDPOINT=$&#123;IMAGE_SERVICE_ENDPOINT:-""&#125;</span><br><span class="line">CHAOS_CHANCE=$&#123;CHAOS_CHANCE:-0.0&#125;</span><br><span class="line">CPU_CFS_QUOTA=$&#123;CPU_CFS_QUOTA:-true&#125;</span><br><span class="line">ENABLE_HOSTPATH_PROVISIONER=$&#123;ENABLE_HOSTPATH_PROVISIONER:-"false"&#125;</span><br><span class="line">CLAIM_BINDER_SYNC_PERIOD=$&#123;CLAIM_BINDER_SYNC_PERIOD:-"15s"&#125; # current k8s default</span><br><span class="line">ENABLE_CONTROLLER_ATTACH_DETACH=$&#123;ENABLE_CONTROLLER_ATTACH_DETACH:-"true"&#125; # current default</span><br><span class="line"><span class="meta">#</span><span class="bash"> This is the default dir and filename <span class="built_in">where</span> the apiserver will generate a self-signed cert</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">which</span> should be able to be used as the CA to verify itself</span></span><br><span class="line">CERT_DIR=$&#123;CERT_DIR:-"/etc/run/kubernetes"&#125;</span><br><span class="line">ROOT_CA_FILE=$&#123;CERT_DIR&#125;/server-ca.crt</span><br><span class="line">ROOT_CA_KEY=$&#123;CERT_DIR&#125;/server-ca.key</span><br><span class="line">CLUSTER_SIGNING_CERT_FILE=$&#123;CLUSTER_SIGNING_CERT_FILE:-"$&#123;ROOT_CA_FILE&#125;"&#125;</span><br><span class="line">CLUSTER_SIGNING_KEY_FILE=$&#123;CLUSTER_SIGNING_KEY_FILE:-"$&#123;ROOT_CA_KEY&#125;"&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Reuse certs will skip generate new ca/cert files under CERT_DIR</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it<span class="string">'s useful with PRESERVE_ETCD=true because new ca will make existed service account secrets invalided</span></span></span><br><span class="line">REUSE_CERTS=$&#123;REUSE_CERTS:-false&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> name of the cgroup driver, i.e. cgroupfs or systemd</span></span><br><span class="line">if [[ $&#123;CONTAINER_RUNTIME&#125; == "docker" ]]; then</span><br><span class="line"><span class="meta">  #</span><span class="bash"> default cgroup driver to match what is reported by docker to simplify <span class="built_in">local</span> development</span></span><br><span class="line">  if [[ -z $&#123;CGROUP_DRIVER&#125; ]]; then</span><br><span class="line">    # match driver with docker runtime reported value (they must match)</span><br><span class="line">    CGROUP_DRIVER=$(docker info | grep "Cgroup Driver:" |  sed -e 's/^[[:space:]]*//'|cut -f3- -d' ')</span><br><span class="line">    echo "Kubelet cgroup driver defaulted to use: $&#123;CGROUP_DRIVER&#125;"</span><br><span class="line">  fi</span><br><span class="line">  if [[ -f /var/log/docker.log &amp;&amp; ! -f "$&#123;LOG_DIR&#125;/docker.log" ]]; then</span><br><span class="line">    ln -s /var/log/docker.log "$&#123;LOG_DIR&#125;/docker.log"</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Ensure CERT_DIR is created <span class="keyword">for</span> auto-generated crt/key and kubeconfig</span></span><br><span class="line">mkdir -p "$&#123;CERT_DIR&#125;" &amp;&gt;/dev/null || sudo mkdir -p "$&#123;CERT_DIR&#125;"</span><br><span class="line">CONTROLPLANE_SUDO=$(test -w "$&#123;CERT_DIR&#125;" || echo "sudo -E")</span><br><span class="line"></span><br><span class="line">function test_apiserver_off &#123;</span><br><span class="line">    # For the common local scenario, fail fast if server is already running.</span><br><span class="line">    # this can happen if you run local-up-cluster.sh twice and kill etcd in between.</span><br><span class="line">    if [[ "$&#123;API_PORT&#125;" -gt "0" ]]; then</span><br><span class="line">        if ! curl --silent -g "$&#123;API_HOST&#125;:$&#123;API_PORT&#125;" ; then</span><br><span class="line">            echo "API SERVER insecure port is free, proceeding..."</span><br><span class="line">        else</span><br><span class="line">            echo "ERROR starting API SERVER, exiting. Some process on $&#123;API_HOST&#125; is serving already on $&#123;API_PORT&#125;"</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if ! curl --silent -k -g "$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125;" ; then</span><br><span class="line">        echo "API SERVER secure port is free, proceeding..."</span><br><span class="line">    else</span><br><span class="line">        echo "ERROR starting API SERVER, exiting. Some process on $&#123;API_HOST&#125; is serving already on $&#123;API_SECURE_PORT&#125;"</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function detect_binary &#123;</span><br><span class="line">    # Detect the OS name/arch so that we can find our binary</span><br><span class="line">    case "$(uname -s)" in</span><br><span class="line">      Darwin)</span><br><span class="line">        host_os=darwin</span><br><span class="line">        ;;</span><br><span class="line">      Linux)</span><br><span class="line">        host_os=linux</span><br><span class="line">        ;;</span><br><span class="line">      *)</span><br><span class="line">        echo "Unsupported host OS.  Must be Linux or Mac OS X." &gt;&amp;2</span><br><span class="line">        exit 1</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line"></span><br><span class="line">    case "$(uname -m)" in</span><br><span class="line">      x86_64*)</span><br><span class="line">        host_arch=amd64</span><br><span class="line">        ;;</span><br><span class="line">      i?86_64*)</span><br><span class="line">        host_arch=amd64</span><br><span class="line">        ;;</span><br><span class="line">      amd64*)</span><br><span class="line">        host_arch=amd64</span><br><span class="line">        ;;</span><br><span class="line">      aarch64*)</span><br><span class="line">        host_arch=arm64</span><br><span class="line">        ;;</span><br><span class="line">      arm64*)</span><br><span class="line">        host_arch=arm64</span><br><span class="line">        ;;</span><br><span class="line">      arm*)</span><br><span class="line">        host_arch=arm</span><br><span class="line">        ;;</span><br><span class="line">      i?86*)</span><br><span class="line">        host_arch=x86</span><br><span class="line">        ;;</span><br><span class="line">      s390x*)</span><br><span class="line">        host_arch=s390x</span><br><span class="line">        ;;</span><br><span class="line">      ppc64le*)</span><br><span class="line">        host_arch=ppc64le</span><br><span class="line">        ;;</span><br><span class="line">      *)</span><br><span class="line">        echo "Unsupported host arch. Must be x86_64, 386, arm, arm64, s390x or ppc64le." &gt;&amp;2</span><br><span class="line">        exit 1</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line"></span><br><span class="line">   GO_OUT="$&#123;KUBE_ROOT&#125;/_output/local/bin/$&#123;host_os&#125;/$&#123;host_arch&#125;"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cleanup()</span><br><span class="line">&#123;</span><br><span class="line">  echo "Cleaning up..."</span><br><span class="line"><span class="meta">  #</span><span class="bash"> delete running images</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;ENABLE_CLUSTER_DNS&#125;</span>"</span> == <span class="literal">true</span> ]]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Still need to figure why this commands throw an error: Error from server: client: etcd cluster is unavailable or misconfigured</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">     <span class="variable">$&#123;KUBECTL&#125;</span> --namespace=kube-system delete service kube-dns</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> And this one hang forever:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">     <span class="variable">$&#123;KUBECTL&#125;</span> --namespace=kube-system delete rc kube-dns-v10</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="keyword">fi</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the API server is still running</span></span><br><span class="line">  [[ -n "$&#123;APISERVER_PID-&#125;" ]] &amp;&amp; kube::util::read-array APISERVER_PIDS &lt; &lt;(pgrep -P "$&#123;APISERVER_PID&#125;" ; ps -o pid= -p "$&#123;APISERVER_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;APISERVER_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;APISERVER_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the controller-manager is still running</span></span><br><span class="line">  [[ -n "$&#123;CTLRMGR_PID-&#125;" ]] &amp;&amp; kube::util::read-array CTLRMGR_PIDS &lt; &lt;(pgrep -P "$&#123;CTLRMGR_PID&#125;" ; ps -o pid= -p "$&#123;CTLRMGR_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;CTLRMGR_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;CTLRMGR_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the kubelet is still running</span></span><br><span class="line">  [[ -n "$&#123;KUBELET_PID-&#125;" ]] &amp;&amp; kube::util::read-array KUBELET_PIDS &lt; &lt;(pgrep -P "$&#123;KUBELET_PID&#125;" ; ps -o pid= -p "$&#123;KUBELET_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;KUBELET_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;KUBELET_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the proxy is still running</span></span><br><span class="line">  [[ -n "$&#123;PROXY_PID-&#125;" ]] &amp;&amp; kube::util::read-array PROXY_PIDS &lt; &lt;(pgrep -P "$&#123;PROXY_PID&#125;" ; ps -o pid= -p "$&#123;PROXY_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;PROXY_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;PROXY_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the scheduler is still running</span></span><br><span class="line">  [[ -n "$&#123;SCHEDULER_PID-&#125;" ]] &amp;&amp; kube::util::read-array SCHEDULER_PIDS &lt; &lt;(pgrep -P "$&#123;SCHEDULER_PID&#125;" ; ps -o pid= -p "$&#123;SCHEDULER_PID&#125;")</span><br><span class="line">  [[ -n "$&#123;SCHEDULER_PIDS-&#125;" ]] &amp;&amp; sudo kill "$&#123;SCHEDULER_PIDS[@]&#125;" 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Check <span class="keyword">if</span> the etcd is still running</span></span><br><span class="line">  [[ -n "$&#123;ETCD_PID-&#125;" ]] &amp;&amp; kube::etcd::stop</span><br><span class="line">  if [[ "$&#123;PRESERVE_ETCD&#125;" == "false" ]]; then</span><br><span class="line">    [[ -n "$&#123;ETCD_DIR-&#125;" ]] &amp;&amp; kube::etcd::clean_etcd_dir</span><br><span class="line">  fi</span><br><span class="line">  exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Check <span class="keyword">if</span> all processes are still running. Prints a warning once each time</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a process dies unexpectedly.</span></span><br><span class="line">function healthcheck &#123;</span><br><span class="line">  if [[ -n "$&#123;APISERVER_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;APISERVER_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "API server terminated unexpectedly, see $&#123;APISERVER_LOG&#125;"</span><br><span class="line">    APISERVER_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;CTLRMGR_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;CTLRMGR_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "kube-controller-manager terminated unexpectedly, see $&#123;CTLRMGR_LOG&#125;"</span><br><span class="line">    CTLRMGR_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;KUBELET_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;KUBELET_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "kubelet terminated unexpectedly, see $&#123;KUBELET_LOG&#125;"</span><br><span class="line">    KUBELET_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;PROXY_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;PROXY_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "kube-proxy terminated unexpectedly, see $&#123;PROXY_LOG&#125;"</span><br><span class="line">    PROXY_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;SCHEDULER_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;SCHEDULER_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "scheduler terminated unexpectedly, see $&#123;SCHEDULER_LOG&#125;"</span><br><span class="line">    SCHEDULER_PID=</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ -n "$&#123;ETCD_PID-&#125;" ]] &amp;&amp; ! sudo kill -0 "$&#123;ETCD_PID&#125;" 2&gt;/dev/null; then</span><br><span class="line">    warning_log "etcd terminated unexpectedly"</span><br><span class="line">    ETCD_PID=</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function print_color &#123;</span><br><span class="line">  message=$1</span><br><span class="line">  prefix=$&#123;2:+$2: &#125; # add colon only if defined</span><br><span class="line">  color=$&#123;3:-1&#125;     # default is red</span><br><span class="line">  echo -n "$(tput bold)$(tput setaf "$&#123;color&#125;")"</span><br><span class="line">  echo "$&#123;prefix&#125;$&#123;message&#125;"</span><br><span class="line">  echo -n "$(tput sgr0)"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function warning_log &#123;</span><br><span class="line">  print_color "$1" "W$(date "+%m%d %H:%M:%S")]" 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_etcd &#123;</span><br><span class="line">    echo "Starting etcd"</span><br><span class="line">    #export ETCD_LOGFILE=$&#123;LOG_DIR&#125;/etcd.log</span><br><span class="line">    #kube::etcd::start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function set_service_accounts &#123;</span><br><span class="line">    SERVICE_ACCOUNT_LOOKUP=$&#123;SERVICE_ACCOUNT_LOOKUP:-true&#125;</span><br><span class="line">    SERVICE_ACCOUNT_KEY=$&#123;SERVICE_ACCOUNT_KEY:-/tmp/kube-serviceaccount.key&#125;</span><br><span class="line">    # Generate ServiceAccount key if needed</span><br><span class="line">    if [[ ! -f "$&#123;SERVICE_ACCOUNT_KEY&#125;" ]]; then</span><br><span class="line">      mkdir -p "$(dirname "$&#123;SERVICE_ACCOUNT_KEY&#125;")"</span><br><span class="line">      openssl genrsa -out "$&#123;SERVICE_ACCOUNT_KEY&#125;" 2048 2&gt;/dev/null</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function generate_certs &#123;</span><br><span class="line">    # Create CA signers</span><br><span class="line">    if [[ "$&#123;ENABLE_SINGLE_CA_SIGNER:-&#125;" = true ]]; then</span><br><span class="line">        kube::util::create_signing_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" server '"client auth","server auth"'</span><br><span class="line">        sudo cp "$&#123;CERT_DIR&#125;/server-ca.key" "$&#123;CERT_DIR&#125;/client-ca.key"</span><br><span class="line">        sudo cp "$&#123;CERT_DIR&#125;/server-ca.crt" "$&#123;CERT_DIR&#125;/client-ca.crt"</span><br><span class="line">        sudo cp "$&#123;CERT_DIR&#125;/server-ca-config.json" "$&#123;CERT_DIR&#125;/client-ca-config.json"</span><br><span class="line">    else</span><br><span class="line">        kube::util::create_signing_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" server '"server auth"'</span><br><span class="line">        kube::util::create_signing_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" client '"client auth"'</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Create auth proxy client ca</span><br><span class="line">    kube::util::create_signing_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" request-header '"client auth"'</span><br><span class="line"></span><br><span class="line">    # serving cert for kube-apiserver</span><br><span class="line">    kube::util::create_serving_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "server-ca" kube-apiserver kubernetes.default kubernetes.default.svc "localhost" "$&#123;API_HOST_IP&#125;" "$&#123;API_HOST&#125;" "$&#123;FIRST_SERVICE_CLUSTER_IP&#125;"</span><br><span class="line"></span><br><span class="line">    # Create client certs signed with client-ca, given id, given CN and a number of groups</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' controller system:kube-controller-manager</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' scheduler  system:kube-scheduler</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' admin system:admin system:masters</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' kube-apiserver kube-apiserver</span><br><span class="line"></span><br><span class="line">    # Create matching certificates for kube-aggregator</span><br><span class="line">    kube::util::create_serving_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "server-ca" kube-aggregator api.kube-public.svc "localhost" "$&#123;API_HOST_IP&#125;"</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" request-header-ca auth-proxy system:auth-proxy</span><br><span class="line"></span><br><span class="line">    # TODO remove masters and add rolebinding</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' kube-aggregator system:kube-aggregator system:masters</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" kube-aggregator</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function generate_kubeproxy_certs &#123;</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' kube-proxy system:kube-proxy system:nodes</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" kube-proxy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function generate_kubelet_certs &#123;</span><br><span class="line">    kube::util::create_client_certkey "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" 'client-ca' kubelet "system:node:$&#123;HOSTNAME_OVERRIDE&#125;" system:nodes</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" kubelet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_apiserver &#123;</span><br><span class="line">    security_admission=""</span><br><span class="line">    if [[ -n "$&#123;DENY_SECURITY_CONTEXT_ADMISSION&#125;" ]]; then</span><br><span class="line">      security_admission=",SecurityContextDeny"</span><br><span class="line">    fi</span><br><span class="line">    if [[ -n "$&#123;PSP_ADMISSION&#125;" ]]; then</span><br><span class="line">      security_admission=",PodSecurityPolicy"</span><br><span class="line">    fi</span><br><span class="line">    if [[ -n "$&#123;NODE_ADMISSION&#125;" ]]; then</span><br><span class="line">      security_admission=",NodeRestriction"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Append security_admission plugin</span><br><span class="line">    ENABLE_ADMISSION_PLUGINS="$&#123;ENABLE_ADMISSION_PLUGINS&#125;$&#123;security_admission&#125;"</span><br><span class="line"></span><br><span class="line">    authorizer_arg=""</span><br><span class="line">    if [[ -n "$&#123;AUTHORIZATION_MODE&#125;" ]]; then</span><br><span class="line">      authorizer_arg="--authorization-mode=$&#123;AUTHORIZATION_MODE&#125;"</span><br><span class="line">    fi</span><br><span class="line">    priv_arg=""</span><br><span class="line">    if [[ -n "$&#123;ALLOW_PRIVILEGED&#125;" ]]; then</span><br><span class="line">      priv_arg="--allow-privileged=$&#123;ALLOW_PRIVILEGED&#125;"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    runtime_config=""</span><br><span class="line">    if [[ -n "$&#123;RUNTIME_CONFIG&#125;" ]]; then</span><br><span class="line">      runtime_config="--runtime-config=$&#123;RUNTIME_CONFIG&#125;"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Let the API server pick a default address when API_HOST_IP</span><br><span class="line">    # is set to 127.0.0.1</span><br><span class="line">    advertise_address=""</span><br><span class="line">    if [[ "$&#123;API_HOST_IP&#125;" != "127.0.0.1" ]]; then</span><br><span class="line">        advertise_address="--advertise-address=$&#123;API_HOST_IP&#125;"</span><br><span class="line">    fi</span><br><span class="line">    if [[ "$&#123;ADVERTISE_ADDRESS&#125;" != "" ]] ; then</span><br><span class="line">        advertise_address="--advertise-address=$&#123;ADVERTISE_ADDRESS&#125;"</span><br><span class="line">    fi</span><br><span class="line">    node_port_range=""</span><br><span class="line">    if [[ "$&#123;NODE_PORT_RANGE&#125;" != "" ]] ; then</span><br><span class="line">        node_port_range="--service-node-port-range=$&#123;NODE_PORT_RANGE&#125;"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [[ "$&#123;REUSE_CERTS&#125;" != true ]]; then</span><br><span class="line">      # Create Certs</span><br><span class="line">      generate_certs</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    cloud_config_arg="--cloud-provider=$&#123;CLOUD_PROVIDER&#125; --cloud-config=$&#123;CLOUD_CONFIG&#125;"</span><br><span class="line">    if [[ "$&#123;EXTERNAL_CLOUD_PROVIDER:-&#125;" == "true" ]]; then</span><br><span class="line">      cloud_config_arg="--cloud-provider=external"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [[ -z "$&#123;AUDIT_POLICY_FILE&#125;" ]]; then</span><br><span class="line">      cat &lt;&lt;EOF &gt; /tmp/kube-audit-policy-file</span><br><span class="line"><span class="meta">#</span><span class="bash"> Log all requests at the Metadata level.</span></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line">EOF</span><br><span class="line">      AUDIT_POLICY_FILE="/tmp/kube-audit-policy-file"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    APISERVER_LOG=$&#123;LOG_DIR&#125;/kube-apiserver.log</span><br><span class="line">    # shellcheck disable=SC2086</span><br><span class="line">    echo "go build apiserver.go $&#123;authorizer_arg&#125; $&#123;priv_arg&#125; $&#123;runtime_config&#125; $&#123;cloud_config_arg&#125; $&#123;advertise_address&#125; $&#123;node_port_range&#125; --v=$&#123;LOG_LEVEL&#125; --vmodule=$&#123;LOG_SPEC&#125; --audit-policy-file=$&#123;AUDIT_POLICY_FILE&#125; --audit-log-path=$&#123;LOG_DIR&#125;/kube-apiserver-audit.log --authorization-webhook-config-file=$&#123;AUTHORIZATION_WEBHOOK_CONFIG_FILE&#125; --authentication-token-webhook-config-file=$&#123;AUTHENTICATION_WEBHOOK_CONFIG_FILE&#125; --cert-dir=$&#123;CERT_DIR&#125; --client-ca-file=$&#123;CERT_DIR&#125;/client-ca.crt --kubelet-client-certificate=$&#123;CERT_DIR&#125;/client-kube-apiserver.crt --kubelet-client-key=$&#123;CERT_DIR&#125;/client-kube-apiserver.key --service-account-key-file=$&#123;SERVICE_ACCOUNT_KEY&#125; --service-account-lookup=$&#123;SERVICE_ACCOUNT_LOOKUP&#125; --enable-admission-plugins=$&#123;ENABLE_ADMISSION_PLUGINS&#125; --disable-admission-plugins=$&#123;DISABLE_ADMISSION_PLUGINS&#125; --admission-control-config-file=$&#123;ADMISSION_CONTROL_CONFIG_FILE&#125; --bind-address=$&#123;API_BIND_ADDR&#125; --secure-port=$&#123;API_SECURE_PORT&#125; --tls-cert-file=$&#123;CERT_DIR&#125;/serving-kube-apiserver.crt --tls-private-key-file=$&#123;CERT_DIR&#125;/serving-kube-apiserver.key --insecure-bind-address=$&#123;API_HOST_IP&#125; --insecure-port=$&#123;API_PORT&#125; --storage-backend=$&#123;STORAGE_BACKEND&#125; --storage-media-type=$&#123;STORAGE_MEDIA_TYPE&#125; --etcd-servers=http://$&#123;ETCD_HOST&#125;:$&#123;ETCD_PORT&#125; --service-cluster-ip-range=$&#123;SERVICE_CLUSTER_IP_RANGE&#125; --feature-gates=$&#123;FEATURE_GATES&#125; --external-hostname=$&#123;EXTERNAL_HOSTNAME&#125; --requestheader-username-headers=X-Remote-User --requestheader-group-headers=X-Remote-Group --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-client-ca-file=$&#123;CERT_DIR&#125;/request-header-ca.crt --requestheader-allowed-names=system:auth-proxy --proxy-client-cert-file=$&#123;CERT_DIR&#125;/client-auth-proxy.crt --proxy-client-key-file=$&#123;CERT_DIR&#125;/client-auth-proxy.key --cors-allowed-origins=$&#123;API_CORS_ALLOWED_ORIGINS&#125; &gt;$&#123;APISERVER_LOG&#125; 2&gt;&amp;1 &amp; "</span><br><span class="line"></span><br><span class="line">    # Wait for kube-apiserver to come up before launching the rest of the components.</span><br><span class="line">    echo "Waiting for apiserver to come up"</span><br><span class="line">    #kube::util::wait_for_url "https://$&#123;API_HOST_IP&#125;:$&#123;API_SECURE_PORT&#125;/healthz" "apiserver: " 1 "$&#123;WAIT_FOR_URL_API_SERVER&#125;" "$&#123;MAX_TIME_FOR_URL_API_SERVER&#125;" \</span><br><span class="line">    #    || &#123; echo "check apiserver logs: $&#123;APISERVER_LOG&#125;" ; exit 1 ; &#125;</span><br><span class="line"></span><br><span class="line">    # Create kubeconfigs for all components, using client certs</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" admin</span><br><span class="line">    $&#123;CONTROLPLANE_SUDO&#125; chown "$&#123;USER&#125;" "$&#123;CERT_DIR&#125;/client-admin.key" # make readable for kubectl</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" controller</span><br><span class="line">    kube::util::write_client_kubeconfig "$&#123;CONTROLPLANE_SUDO&#125;" "$&#123;CERT_DIR&#125;" "$&#123;ROOT_CA_FILE&#125;" "$&#123;API_HOST&#125;" "$&#123;API_SECURE_PORT&#125;" scheduler</span><br><span class="line"></span><br><span class="line">    if [[ -z "$&#123;AUTH_ARGS&#125;" ]]; then</span><br><span class="line">        AUTH_ARGS="--client-key=$&#123;CERT_DIR&#125;/client-admin.key --client-certificate=$&#123;CERT_DIR&#125;/client-admin.crt"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Grant apiserver permission to speak to the kubelet</span><br><span class="line">    $&#123;KUBECTL&#125; --kubeconfig "$&#123;CERT_DIR&#125;/admin.kubeconfig" create clusterrolebinding kube-apiserver-kubelet-admin --clusterrole=system:kubelet-api-admin --user=kube-apiserver</span><br><span class="line"></span><br><span class="line">    $&#123;CONTROLPLANE_SUDO&#125; cp "$&#123;CERT_DIR&#125;/admin.kubeconfig" "$&#123;CERT_DIR&#125;/admin-kube-aggregator.kubeconfig"</span><br><span class="line">    $&#123;CONTROLPLANE_SUDO&#125; chown "$(whoami)" "$&#123;CERT_DIR&#125;/admin-kube-aggregator.kubeconfig"</span><br><span class="line">    $&#123;KUBECTL&#125; config set-cluster local-up-cluster --kubeconfig="$&#123;CERT_DIR&#125;/admin-kube-aggregator.kubeconfig" --server="https://$&#123;API_HOST_IP&#125;:31090"</span><br><span class="line">    echo "use 'kubectl --kubeconfig=$&#123;CERT_DIR&#125;/admin-kube-aggregator.kubeconfig' to use the aggregated API server"</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_controller_manager &#123;</span><br><span class="line">    node_cidr_args=()</span><br><span class="line">    if [[ "$&#123;NET_PLUGIN&#125;" == "kubenet" ]]; then</span><br><span class="line">      node_cidr_args=("--allocate-node-cidrs=true" "--cluster-cidr=10.1.0.0/16")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    cloud_config_arg=("--cloud-provider=$&#123;CLOUD_PROVIDER&#125;" "--cloud-config=$&#123;CLOUD_CONFIG&#125;")</span><br><span class="line">    if [[ "$&#123;EXTERNAL_CLOUD_PROVIDER:-&#125;" == "true" ]]; then</span><br><span class="line">      cloud_config_arg=("--cloud-provider=external")</span><br><span class="line">      cloud_config_arg+=("--external-cloud-volume-plugin=$&#123;CLOUD_PROVIDER&#125;")</span><br><span class="line">      cloud_config_arg+=("--cloud-config=$&#123;CLOUD_CONFIG&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    CTLRMGR_LOG=$&#123;LOG_DIR&#125;/kube-controller-manager.log</span><br><span class="line"></span><br><span class="line">    echo "go build controller-manager.go $&#123;GO_OUT&#125;/kube-controller-manager --v=$&#123;LOG_LEVEL&#125; --vmodule=$&#123;LOG_SPEC&#125; --service-account-private-key-file=$&#123;SERVICE_ACCOUNT_KEY&#125; --root-ca-file=$&#123;ROOT_CA_FILE&#125; --cluster-signing-cert-file=$&#123;CLUSTER_SIGNING_CERT_FILE&#125; --cluster-signing-key-file=$&#123;CLUSTER_SIGNING_KEY_FILE&#125; --enable-hostpath-provisioner=$&#123;ENABLE_HOSTPATH_PROVISIONER&#125; $&#123;node_cidr_args[@]+$&#123;node_cidr_args[@]&#125;&#125; --pvclaimbinder-sync-period=$&#123;CLAIM_BINDER_SYNC_PERIOD&#125; --feature-gates=$&#123;FEATURE_GATES&#125; $&#123;cloud_config_arg[@]&#125; --kubeconfig $&#123;CERT_DIR&#125;/controller.kubeconfig --use-service-account-credentials --controllers=$&#123;KUBE_CONTROLLERS&#125; --leader-elect=false --cert-dir=$&#123;CERT_DIR&#125; --master=https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125; &gt;$&#123;CTLRMGR_LOG&#125; 2&gt;&amp;1 &amp;"</span><br><span class="line"><span class="meta">#</span><span class="bash">    CTLRMGR_PID=$!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_cloud_controller_manager &#123;</span><br><span class="line">    if [ -z "$&#123;CLOUD_CONFIG&#125;" ]; then</span><br><span class="line">      echo "CLOUD_CONFIG cannot be empty!"</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ ! -f "$&#123;CLOUD_CONFIG&#125;" ]; then</span><br><span class="line">      echo "Cloud config $&#123;CLOUD_CONFIG&#125; doesn't exist"</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    node_cidr_args=()</span><br><span class="line">    if [[ "$&#123;NET_PLUGIN&#125;" == "kubenet" ]]; then</span><br><span class="line">      node_cidr_args=("--allocate-node-cidrs=true" "--cluster-cidr=10.1.0.0/16")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    CLOUD_CTLRMGR_LOG=$&#123;LOG_DIR&#125;/cloud-controller-manager.log</span><br><span class="line">    $&#123;CONTROLPLANE_SUDO&#125; "$&#123;EXTERNAL_CLOUD_PROVIDER_BINARY:-"$&#123;GO_OUT&#125;/cloud-controller-manager"&#125;" \</span><br><span class="line">      --v="$&#123;LOG_LEVEL&#125;" \</span><br><span class="line">      --vmodule="$&#123;LOG_SPEC&#125;" \</span><br><span class="line">      "$&#123;node_cidr_args[@]:-&#125;" \</span><br><span class="line">      --feature-gates="$&#123;FEATURE_GATES&#125;" \</span><br><span class="line">      --cloud-provider="$&#123;CLOUD_PROVIDER&#125;" \</span><br><span class="line">      --cloud-config="$&#123;CLOUD_CONFIG&#125;" \</span><br><span class="line">      --kubeconfig "$&#123;CERT_DIR&#125;"/controller.kubeconfig \</span><br><span class="line">      --use-service-account-credentials \</span><br><span class="line">      --leader-elect=false \</span><br><span class="line">      --master="https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125;" &gt;"$&#123;CLOUD_CTLRMGR_LOG&#125;" 2&gt;&amp;1 &amp;</span><br><span class="line">    export CLOUD_CTLRMGR_PID=$!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function wait_node_ready()&#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> check the nodes information after kubelet daemon start</span></span><br><span class="line">  local nodes_stats="$&#123;KUBECTL&#125; --kubeconfig '$&#123;CERT_DIR&#125;/admin.kubeconfig' get nodes"</span><br><span class="line">  local node_name=$HOSTNAME_OVERRIDE</span><br><span class="line">  local system_node_wait_time=30</span><br><span class="line">  local interval_time=2</span><br><span class="line">  kube::util::wait_for_success "$system_node_wait_time" "$interval_time" "$nodes_stats | grep $node_name"</span><br><span class="line">  if [ $? == "1" ]; then</span><br><span class="line">    echo "time out on waiting $node_name info"</span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubelet &#123;</span><br><span class="line">    KUBELET_LOG=$&#123;LOG_DIR&#125;/kubelet.log</span><br><span class="line">    mkdir -p "$&#123;POD_MANIFEST_PATH&#125;" &amp;&gt;/dev/null || sudo mkdir -p "$&#123;POD_MANIFEST_PATH&#125;"</span><br><span class="line"></span><br><span class="line">    cloud_config_arg=("--cloud-provider=$&#123;CLOUD_PROVIDER&#125;" "--cloud-config=$&#123;CLOUD_CONFIG&#125;")</span><br><span class="line">    if [[ "$&#123;EXTERNAL_CLOUD_PROVIDER:-&#125;" == "true" ]]; then</span><br><span class="line">       cloud_config_arg=("--cloud-provider=external")</span><br><span class="line">       cloud_config_arg+=("--provider-id=$(hostname)")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    mkdir -p "/var/lib/kubelet" &amp;&gt;/dev/null || sudo mkdir -p "/var/lib/kubelet"</span><br><span class="line">    # Enable dns</span><br><span class="line">    if [[ "$&#123;ENABLE_CLUSTER_DNS&#125;" = true ]]; then</span><br><span class="line">      if [[ "$&#123;ENABLE_NODELOCAL_DNS:-&#125;" == "true" ]]; then</span><br><span class="line">        dns_args=("--cluster-dns=$&#123;LOCAL_DNS_IP&#125;" "--cluster-domain=$&#123;DNS_DOMAIN&#125;")</span><br><span class="line">      else</span><br><span class="line">        dns_args=("--cluster-dns=$&#123;DNS_SERVER_IP&#125;" "--cluster-domain=$&#123;DNS_DOMAIN&#125;")</span><br><span class="line">      fi</span><br><span class="line">    else</span><br><span class="line">      # To start a private DNS server set ENABLE_CLUSTER_DNS and</span><br><span class="line">      # DNS_SERVER_IP/DOMAIN. This will at least provide a working</span><br><span class="line">      # DNS server for real world hostnames.</span><br><span class="line">      dns_args=("--cluster-dns=8.8.8.8")</span><br><span class="line">    fi</span><br><span class="line">    net_plugin_args=()</span><br><span class="line">    if [[ -n "$&#123;NET_PLUGIN&#125;" ]]; then</span><br><span class="line">      net_plugin_args=("--network-plugin=$&#123;NET_PLUGIN&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    auth_args=()</span><br><span class="line">    if [[ "$&#123;KUBELET_AUTHORIZATION_WEBHOOK:-&#125;" != "false" ]]; then</span><br><span class="line">      auth_args+=("--authorization-mode=Webhook")</span><br><span class="line">    fi</span><br><span class="line">    if [[ "$&#123;KUBELET_AUTHENTICATION_WEBHOOK:-&#125;" != "false" ]]; then</span><br><span class="line">      auth_args+=("--authentication-token-webhook")</span><br><span class="line">    fi</span><br><span class="line">    if [[ -n "$&#123;CLIENT_CA_FILE:-&#125;" ]]; then</span><br><span class="line">      auth_args+=("--client-ca-file=$&#123;CLIENT_CA_FILE&#125;")</span><br><span class="line">    else</span><br><span class="line">      auth_args+=("--client-ca-file=$&#123;CERT_DIR&#125;/client-ca.crt")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    cni_conf_dir_args=()</span><br><span class="line">    if [[ -n "$&#123;CNI_CONF_DIR&#125;" ]]; then</span><br><span class="line">      cni_conf_dir_args=("--cni-conf-dir=$&#123;CNI_CONF_DIR&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    cni_bin_dir_args=()</span><br><span class="line">    if [[ -n "$&#123;CNI_BIN_DIR&#125;" ]]; then</span><br><span class="line">      cni_bin_dir_args=("--cni-bin-dir=$&#123;CNI_BIN_DIR&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    container_runtime_endpoint_args=()</span><br><span class="line">    if [[ -n "$&#123;CONTAINER_RUNTIME_ENDPOINT&#125;" ]]; then</span><br><span class="line">      container_runtime_endpoint_args=("--container-runtime-endpoint=$&#123;CONTAINER_RUNTIME_ENDPOINT&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    image_service_endpoint_args=()</span><br><span class="line">    if [[ -n "$&#123;IMAGE_SERVICE_ENDPOINT&#125;" ]]; then</span><br><span class="line">      image_service_endpoint_args=("--image-service-endpoint=$&#123;IMAGE_SERVICE_ENDPOINT&#125;")</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # shellcheck disable=SC2206</span><br><span class="line">    all_kubelet_flags=(</span><br><span class="line">      "--v=$&#123;LOG_LEVEL&#125;"</span><br><span class="line">      "--vmodule=$&#123;LOG_SPEC&#125;"</span><br><span class="line">      "--chaos-chance=$&#123;CHAOS_CHANCE&#125;"</span><br><span class="line">      "--container-runtime=$&#123;CONTAINER_RUNTIME&#125;"</span><br><span class="line">      "--hostname-override=$&#123;HOSTNAME_OVERRIDE&#125;"</span><br><span class="line">      "$&#123;cloud_config_arg[@]&#125;"</span><br><span class="line">      "--address=$&#123;KUBELET_HOST&#125;"</span><br><span class="line">      --kubeconfig "$&#123;CERT_DIR&#125;"/kubelet.kubeconfig</span><br><span class="line">      "--feature-gates=$&#123;FEATURE_GATES&#125;"</span><br><span class="line">      "--cpu-cfs-quota=$&#123;CPU_CFS_QUOTA&#125;"</span><br><span class="line">      "--enable-controller-attach-detach=$&#123;ENABLE_CONTROLLER_ATTACH_DETACH&#125;"</span><br><span class="line">      "--cgroups-per-qos=$&#123;CGROUPS_PER_QOS&#125;"</span><br><span class="line">      "--cgroup-driver=$&#123;CGROUP_DRIVER&#125;"</span><br><span class="line">      "--cgroup-root=$&#123;CGROUP_ROOT&#125;"</span><br><span class="line">      "--eviction-hard=$&#123;EVICTION_HARD&#125;"</span><br><span class="line">      "--eviction-soft=$&#123;EVICTION_SOFT&#125;"</span><br><span class="line">      "--eviction-pressure-transition-period=$&#123;EVICTION_PRESSURE_TRANSITION_PERIOD&#125;"</span><br><span class="line">      "--pod-manifest-path=$&#123;POD_MANIFEST_PATH&#125;"</span><br><span class="line">      "--fail-swap-on=$&#123;FAIL_SWAP_ON&#125;"</span><br><span class="line">      $&#123;auth_args[@]+"$&#123;auth_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;dns_args[@]+"$&#123;dns_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;cni_conf_dir_args[@]+"$&#123;cni_conf_dir_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;cni_bin_dir_args[@]+"$&#123;cni_bin_dir_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;net_plugin_args[@]+"$&#123;net_plugin_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;container_runtime_endpoint_args[@]+"$&#123;container_runtime_endpoint_args[@]&#125;"&#125;</span><br><span class="line">      $&#123;image_service_endpoint_args[@]+"$&#123;image_service_endpoint_args[@]&#125;"&#125;</span><br><span class="line">      "--runtime-request-timeout=$&#123;RUNTIME_REQUEST_TIMEOUT&#125;"</span><br><span class="line">      "--port=$&#123;KUBELET_PORT&#125;"</span><br><span class="line">      $&#123;KUBELET_FLAGS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    if [[ "$&#123;REUSE_CERTS&#125;" != true ]]; then</span><br><span class="line">        generate_kubelet_certs</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # shellcheck disable=SC2024</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubeproxy &#123;</span><br><span class="line">    PROXY_LOG=$&#123;LOG_DIR&#125;/kube-proxy.log</span><br><span class="line"></span><br><span class="line">    # wait for kubelet collect node information</span><br><span class="line">    echo "wait kubelet ready"</span><br><span class="line">    #wait_node_ready</span><br><span class="line"></span><br><span class="line">    cat &lt;&lt;EOF &gt; /tmp/kube-proxy.yaml</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: $&#123;CERT_DIR&#125;/kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: $&#123;HOSTNAME_OVERRIDE&#125;</span><br><span class="line">mode: $&#123;KUBE_PROXY_MODE&#125;</span><br><span class="line">EOF</span><br><span class="line">    if [[ -n $&#123;FEATURE_GATES&#125; ]]; then</span><br><span class="line">      echo "featureGates:"</span><br><span class="line">      # Convert from foo=true,bar=false to</span><br><span class="line">      #   foo: true</span><br><span class="line">      #   bar: false</span><br><span class="line">      for gate in $(echo "$&#123;FEATURE_GATES&#125;" | tr ',' ' '); do</span><br><span class="line">        echo "$&#123;gate&#125;" | $&#123;SED&#125; -e 's/\(.*\)=\(.*\)/  \1: \2/'</span><br><span class="line">      done</span><br><span class="line">    fi &gt;&gt;/tmp/kube-proxy.yaml</span><br><span class="line"></span><br><span class="line">    if [[ "$&#123;REUSE_CERTS&#125;" != true ]]; then</span><br><span class="line">        generate_kubeproxy_certs</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # shellcheck disable=SC2024</span><br><span class="line">    echo "go build proxy.go --v=$&#123;LOG_LEVEL&#125; --config=/tmp/kube-proxy.yaml --master=https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125; &gt;$&#123;PROXY_LOG&#125; 2&gt;&amp;1 &amp;"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubescheduler &#123;</span><br><span class="line"></span><br><span class="line">    SCHEDULER_LOG=$&#123;LOG_DIR&#125;/kube-scheduler.log</span><br><span class="line">    echo "go build scheduler.go --v=$&#123;LOG_LEVEL&#125; --leader-elect=false --kubeconfig $&#123;CERT_DIR&#125;/scheduler.kubeconfig --feature-gates=$&#123;FEATURE_GATES&#125; --master=https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125; &gt;$&#123;SCHEDULER_LOG&#125; 2&gt;&amp;1 &amp;"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubedns &#123;</span><br><span class="line">    if [[ "$&#123;ENABLE_CLUSTER_DNS&#125;" = true ]]; then</span><br><span class="line">        cp "$&#123;KUBE_ROOT&#125;/cluster/addons/dns/kube-dns/kube-dns.yaml.in" kube-dns.yaml</span><br><span class="line">        $&#123;SED&#125; -i -e "s/&#123;&#123; pillar\['dns_domain'\] &#125;&#125;/$&#123;DNS_DOMAIN&#125;/g" kube-dns.yaml</span><br><span class="line">        $&#123;SED&#125; -i -e "s/&#123;&#123; pillar\['dns_server'\] &#125;&#125;/$&#123;DNS_SERVER_IP&#125;/g" kube-dns.yaml</span><br><span class="line">        $&#123;SED&#125; -i -e "s/&#123;&#123; pillar\['dns_memory_limit'\] &#125;&#125;/$&#123;DNS_MEMORY_LIMIT&#125;/g" kube-dns.yaml</span><br><span class="line">        # TODO update to dns role once we have one.</span><br><span class="line">        # use kubectl to create kubedns addon</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" --namespace=kube-system create -f kube-dns.yaml</span><br><span class="line">        echo "Kube-dns addon successfully deployed."</span><br><span class="line">        rm kube-dns.yaml</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_nodelocaldns &#123;</span><br><span class="line">  cp "$&#123;KUBE_ROOT&#125;/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml" nodelocaldns.yaml</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SED&#125; -i -e <span class="string">"s/__PILLAR__DNS__DOMAIN__/<span class="variable">$&#123;DNS_DOMAIN&#125;</span>/g"</span> nodelocaldns.yaml</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SED&#125; -i -e <span class="string">"s/__PILLAR__DNS__SERVER__/<span class="variable">$&#123;DNS_SERVER_IP&#125;</span>/g"</span> nodelocaldns.yaml</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SED&#125; -i -e <span class="string">"s/__PILLAR__LOCAL__DNS__/<span class="variable">$&#123;LOCAL_DNS_IP&#125;</span>/g"</span> nodelocaldns.yaml</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> use kubectl to create nodelocaldns addon</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;KUBECTL&#125; --kubeconfig=<span class="string">"<span class="variable">$&#123;CERT_DIR&#125;</span>/admin.kubeconfig"</span> --namespace=kube-system create -f nodelocaldns.yaml</span></span><br><span class="line">  echo "NodeLocalDNS addon successfully deployed."</span><br><span class="line">  rm nodelocaldns.yaml</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function start_kubedashboard &#123;</span><br><span class="line">    if [[ "$&#123;ENABLE_CLUSTER_DASHBOARD&#125;" = true ]]; then</span><br><span class="line">        echo "Creating kubernetes-dashboard"</span><br><span class="line">        # use kubectl to create the dashboard</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-secret.yaml"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-configmap.yaml"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-rbac.yaml"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-deployment.yaml"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" apply -f "$&#123;KUBE_ROOT&#125;/cluster/addons/dashboard/dashboard-service.yaml"</span><br><span class="line">        echo "kubernetes-dashboard deployment and service successfully deployed."</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function create_psp_policy &#123;</span><br><span class="line">    echo "Create podsecuritypolicy policies for RBAC."</span><br><span class="line">    $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" create -f "$&#123;KUBE_ROOT&#125;/examples/podsecuritypolicy/rbac/policies.yaml"</span><br><span class="line">    $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" create -f "$&#123;KUBE_ROOT&#125;/examples/podsecuritypolicy/rbac/roles.yaml"</span><br><span class="line">    $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" create -f "$&#123;KUBE_ROOT&#125;/examples/podsecuritypolicy/rbac/bindings.yaml"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function create_storage_class &#123;</span><br><span class="line">    if [ -z "$&#123;CLOUD_PROVIDER&#125;" ]; then</span><br><span class="line">        CLASS_FILE=$&#123;KUBE_ROOT&#125;/cluster/addons/storage-class/local/default.yaml</span><br><span class="line">    else</span><br><span class="line">        CLASS_FILE=$&#123;KUBE_ROOT&#125;/cluster/addons/storage-class/$&#123;CLOUD_PROVIDER&#125;/default.yaml</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -e "$&#123;CLASS_FILE&#125;" ]; then</span><br><span class="line">        echo "Create default storage class for $&#123;CLOUD_PROVIDER&#125;"</span><br><span class="line">        $&#123;KUBECTL&#125; --kubeconfig="$&#123;CERT_DIR&#125;/admin.kubeconfig" create -f "$&#123;CLASS_FILE&#125;"</span><br><span class="line">    else</span><br><span class="line">        echo "No storage class available for $&#123;CLOUD_PROVIDER&#125;."</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function print_success &#123;</span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  if [[ "$&#123;ENABLE_DAEMON&#125;" = false ]]; then</span><br><span class="line">    echo "Local Kubernetes cluster is running. Press Ctrl-C to shut it down."</span><br><span class="line">  else</span><br><span class="line">    echo "Local Kubernetes cluster is running."</span><br><span class="line">  fi</span><br><span class="line">  cat &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">Logs:</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;APISERVER_LOG:-&#125;</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;CTLRMGR_LOG:-&#125;</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;CLOUD_CTLRMGR_LOG:-&#125;</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;PROXY_LOG:-&#125;</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SCHEDULER_LOG:-&#125;</span></span><br><span class="line">EOF</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$&#123;START_MODE&#125;" == "all" ]]; then</span><br><span class="line">  echo "  $&#123;KUBELET_LOG&#125;"</span><br><span class="line">elif [[ "$&#123;START_MODE&#125;" == "nokubelet" ]]; then</span><br><span class="line">  echo</span><br><span class="line">  echo "No kubelet was started because you set START_MODE=nokubelet"</span><br><span class="line">  echo "Run this script again with START_MODE=kubeletonly to run a kubelet"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  echo</span><br><span class="line">  if [[ "$&#123;ENABLE_DAEMON&#125;" = false ]]; then</span><br><span class="line">    echo "To start using your cluster, you can open up another terminal/tab and run:"</span><br><span class="line">  else</span><br><span class="line">    echo "To start using your cluster, run:"</span><br><span class="line">  fi</span><br><span class="line">  cat &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">  export KUBECONFIG=$&#123;CERT_DIR&#125;/admin.kubeconfig</span><br><span class="line">  cluster/kubectl.sh</span><br><span class="line"></span><br><span class="line">Alternatively, you can write to the default kubeconfig:</span><br><span class="line"></span><br><span class="line">  export KUBERNETES_PROVIDER=local</span><br><span class="line"></span><br><span class="line">  cluster/kubectl.sh config set-cluster local --server=https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125; --certificate-authority=$&#123;ROOT_CA_FILE&#125;</span><br><span class="line">  cluster/kubectl.sh config set-credentials myself $&#123;AUTH_ARGS&#125;</span><br><span class="line">  cluster/kubectl.sh config set-context local --cluster=local --user=myself</span><br><span class="line">  cluster/kubectl.sh config use-context local</span><br><span class="line">  cluster/kubectl.sh</span><br><span class="line">EOF</span><br><span class="line">else</span><br><span class="line">  cat &lt;&lt;EOF</span><br><span class="line">The kubelet was started.</span><br><span class="line"></span><br><span class="line">Logs:</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;KUBELET_LOG&#125;</span></span><br><span class="line">EOF</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [ "$&#123;CONTAINER_RUNTIME&#125;" == "docker" ] &amp;&amp; ! kube::util::ensure_docker_daemon_connectivity; then</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  test_apiserver_off</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">kube::util::test_openssl_installed</span><br><span class="line">kube::util::ensure-cfssl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## IF the user didn't supply an output/ for the build... Then we detect.</span></span></span><br><span class="line">if [ "$&#123;GO_OUT&#125;" == "" ]; then</span><br><span class="line">  detect_binary</span><br><span class="line">fi</span><br><span class="line">echo "Detected host and ready to start services.  Doing some housekeeping first..."</span><br><span class="line">echo "Using GO_OUT $&#123;GO_OUT&#125;"</span><br><span class="line">export KUBELET_CIDFILE=/tmp/kubelet.cid</span><br><span class="line">if [[ "$&#123;ENABLE_DAEMON&#125;" = false ]]; then</span><br><span class="line">  trap cleanup EXIT</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo "Starting services now!"</span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  start_etcd</span><br><span class="line">  set_service_accounts</span><br><span class="line">  start_apiserver</span><br><span class="line">  start_controller_manager</span><br><span class="line">  start_kubescheduler</span><br><span class="line"><span class="meta">  #</span><span class="bash">start_kubedashboard</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;START_MODE&#125;</span>"</span> != <span class="string">"nokubelet"</span> ]]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="comment">## TODO remove this check if/when kubelet is supported on darwin</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="comment"># Detect the OS name/arch and display appropriate error.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="keyword">case</span> <span class="string">"<span class="variable">$(uname -s)</span>"</span> <span class="keyword">in</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">      Darwin)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        print_color <span class="string">"kubelet is not currently supported in darwin, kubelet aborted."</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">        KUBELET_LOG=<span class="string">""</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ;;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      Linux)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        start_kubelet</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ;;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      *)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        print_color <span class="string">"Unsupported host OS.  Must be Linux or Mac OS X, kubelet aborted."</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ;;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="keyword">esac</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">fi</span></span></span><br><span class="line"></span><br><span class="line">if [[ "$&#123;START_MODE&#125;" != "kubeletonly" ]]; then</span><br><span class="line">  if [[ "$&#123;START_MODE&#125;" != "nokubeproxy" ]]; then</span><br><span class="line">    start_kubeproxy</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">print_success</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;ENABLE_DAEMON&#125;</span>"</span> = <span class="literal">false</span> ]]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> sleep 1; healthcheck; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">fi</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;KUBETEST_IN_DOCKER:-&#125;</span>"</span> == <span class="string">"true"</span> ]]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  cluster/kubectl.sh config <span class="built_in">set</span>-cluster <span class="built_in">local</span> --server=https://localhost:6443 --certificate-authority=/var/run/kubernetes/server-ca.crt</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  cluster/kubectl.sh config <span class="built_in">set</span>-credentials myself --client-key=/var/run/kubernetes/client-admin.key --client-certificate=/var/run/kubernetes/client-admin.crt</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  cluster/kubectl.sh config <span class="built_in">set</span>-context <span class="built_in">local</span> --cluster=<span class="built_in">local</span> --user=myself</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  cluster/kubectl.sh config use-context <span class="built_in">local</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">fi</span></span></span><br></pre></td></tr></table></figure>




<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">go build apiserver.go --authorization-mode&#x3D;Node,RBAC   --cloud-provider&#x3D; --cloud-config&#x3D;   --v&#x3D;3 --vmodule&#x3D; --audit-policy-file&#x3D;&#x2F;tmp&#x2F;kube-audit-policy-file --audit-log-path&#x3D;&#x2F;tmp&#x2F;kube-apiserver-audit.log --authorization-webhook-config-file&#x3D; --authentication-token-webhook-config-file&#x3D; --cert-dir&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes --client-ca-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-ca.crt --kubelet-client-certificate&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-kube-apiserver.crt --kubelet-client-key&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-kube-apiserver.key --service-account-key-file&#x3D;&#x2F;tmp&#x2F;kube-serviceaccount.key --service-account-lookup&#x3D;true --enable-admission-plugins&#x3D;NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,Priority,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota --disable-admission-plugins&#x3D; --admission-control-config-file&#x3D; --bind-address&#x3D;0.0.0.0 --secure-port&#x3D;6443 --tls-cert-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;serving-kube-apiserver.crt --tls-private-key-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;serving-kube-apiserver.key --insecure-bind-address&#x3D;127.0.0.1 --insecure-port&#x3D;8080 --storage-backend&#x3D;etcd3 --storage-media-type&#x3D; --etcd-servers&#x3D;http:&#x2F;&#x2F;127.0.0.1:2379 --service-cluster-ip-range&#x3D;10.0.0.0&#x2F;24 --feature-gates&#x3D;AllAlpha&#x3D;false --external-hostname&#x3D;localhost --requestheader-username-headers&#x3D;X-Remote-User --requestheader-group-headers&#x3D;X-Remote-Group --requestheader-extra-headers-prefix&#x3D;X-Remote-Extra- --requestheader-client-ca-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;request-header-ca.crt --requestheader-allowed-names&#x3D;system:auth-proxy --proxy-client-cert-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-auth-proxy.crt --proxy-client-key-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;client-auth-proxy.key --cors-allowed-origins&#x3D;&#x2F;127.0.0.1(:[0-9]+)?$,&#x2F;localhost(:[0-9]+)?$ &gt;&#x2F;tmp&#x2F;kube-apiserver.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">go build controller-manager.go --v&#x3D;3 --service-account-private-key-file&#x3D;&#x2F;tmp&#x2F;kube-serviceaccount.key --root-ca-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;server-ca.crt --cluster-signing-cert-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;server-ca.crt --cluster-signing-key-file&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;server-ca.key --enable-hostpath-provisioner&#x3D;false  --pvclaimbinder-sync-period&#x3D;15s --feature-gates&#x3D;AllAlpha&#x3D;false --cloud-provider&#x3D; --cloud-config&#x3D; --kubeconfig &#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;controller.kubeconfig --use-service-account-credentials --controllers&#x3D;* --leader-elect&#x3D;false --cert-dir&#x3D;&#x2F;var&#x2F;run&#x2F;kubernetes --master&#x3D;https:&#x2F;&#x2F;localhost:6443 &gt;&#x2F;tmp&#x2F;kube-controller-manager.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">go build scheduler.go --v&#x3D;3 --leader-elect&#x3D;false --kubeconfig &#x2F;var&#x2F;run&#x2F;kubernetes&#x2F;scheduler.kubeconfig --feature-gates&#x3D;AllAlpha&#x3D;false --master&#x3D;https:&#x2F;&#x2F;localhost:6443 &gt;&#x2F;tmp&#x2F;kube-scheduler.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">go build proxy.go --v&#x3D;3 --config&#x3D;&#x2F;tmp&#x2F;kube-proxy.yaml --master&#x3D;https:&#x2F;&#x2F;localhost:6443 &gt;&#x2F;tmp&#x2F;kube-proxy.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>



    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/02/03/k8s/1.k8s%E7%AE%80%E4%BB%8B/" rel="prev" title="k8s简介">
      <i class="fa fa-chevron-left"></i> k8s简介
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/02/04/k8s/3.k8s-apiserver/" rel="next" title="k8s-apiserver">
      k8s-apiserver <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0-本地调试"><span class="nav-number">1.</span> <span class="nav-text">0. 本地调试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-1-本地运行调试"><span class="nav-number">1.1.</span> <span class="nav-text">0.1 本地运行调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0-2-远程debug"><span class="nav-number">1.2.</span> <span class="nav-text">0.2 远程debug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件"><span class="nav-number">1.3.</span> <span class="nav-text">附件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-本地生成密钥以及组件命令参数"><span class="nav-number">1.3.1.</span> <span class="nav-text">[^1]: 本地生成密钥以及组件命令参数</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zamperini"
      src="/images/avator.png">
  <p class="site-author-name" itemprop="name">Zamperini</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/DorgenJones" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;DorgenJones" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:dblpfilter@163.com" title="E-Mail → mailto:dblpfilter@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/1938368215" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;1938368215" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zamperini</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
